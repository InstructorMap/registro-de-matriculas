<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Acad√©mico | ASARI</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary-color: #4f46e5; }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #475569; scroll-behavior: smooth; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hover-lift { transition: all 0.3s ease; }
        .hover-lift:hover { transform: translateY(-5px); box-shadow: 0 15px 30px -10px rgba(0,0,0,0.1); }
        .chat-widget { position: fixed; bottom: 20px; right: 20px; z-index: 1000; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .chat-open { width: 350px; height: 500px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .chat-closed { width: 60px; height: 60px; border-radius: 50%; cursor: pointer; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <nav class="fixed w-full z-50 bg-white/90 backdrop-blur-md border-b border-slate-200 h-20">
        <div class="max-w-7xl mx-auto px-6 h-full flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div id="logo-container" class="h-10 hidden bg-white p-1 rounded border border-slate-100 shadow-sm">
                    <img id="logo-inst" src="" class="h-full object-contain">
                </div>
                <span id="nombre-inst" class="font-black text-xl tracking-tighter text-slate-900">Cargando...</span>
            </div>
            <div class="hidden md:flex items-center gap-8 text-[11px] font-bold uppercase tracking-widest">
                <a href="#inicio">Inicio</a>
                <a href="#areas-container">√Åreas</a>
                <a href="student/index.html" class="bg-slate-900 text-white px-5 py-2 rounded-full">Campus</a>
            </div>
        </div>
    </nav>

    <header id="inicio" class="pt-40 pb-20 bg-slate-50 relative overflow-hidden">
        <div class="max-w-5xl mx-auto px-6 text-center relative z-10 fade-in">
            <h1 id="hero-title" class="text-5xl md:text-7xl font-black text-slate-900 leading-tight mb-4">
                Lidera tu <br> <span id="hero-accent" class="text-indigo-600">futuro</span>
            </h1>
            <p id="hero-desc" class="text-lg text-slate-500 max-w-2xl mx-auto">Excelencia acad√©mica y formaci√≥n profesional.</p>
        </div>
    </header>

    <main class="flex-1 max-w-7xl mx-auto px-6 w-full py-12">
        <section id="vista-curso" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-12 mb-20 fade-in">
            <div class="lg:col-span-2 bg-white rounded-3xl p-8 border border-slate-200 shadow-sm">
                <h2 id="det-titulo" class="text-4xl font-black text-slate-900 mb-6">Curso</h2>
                <div id="det-desc" class="text-slate-600 mb-10 leading-relaxed"></div>
                <div id="temario-accordion" class="space-y-3"></div>
            </div>
            <div class="lg:col-span-1">
                <div class="bg-slate-950 rounded-3xl p-8 text-white shadow-2xl sticky top-28">
                    <h3 class="text-xl font-bold mb-6">Inscripci√≥n</h3>
                    <form id="form-lead" class="space-y-4">
                        <input type="text" name="nombre" placeholder="Nombre completo" required class="w-full bg-white/10 border-none rounded-xl p-4 text-white outline-none focus:ring-2 focus:ring-indigo-500">
                        <input type="email" name="email" placeholder="Email" required class="w-full bg-white/10 border-none rounded-xl p-4 text-white outline-none focus:ring-2 focus:ring-indigo-500">
                        <input type="tel" name="telefono" placeholder="WhatsApp" required class="w-full bg-white/10 border-none rounded-xl p-4 text-white outline-none focus:ring-2 focus:ring-indigo-500">
                        <button type="submit" id="btn-submit" class="w-full py-4 rounded-xl font-black uppercase tracking-widest bg-indigo-600 hover:bg-indigo-500 transition-all">Solicitar Informaci√≥n</button>
                    </form>
                </div>
            </div>
        </section>

        <div id="areas-container" class="space-y-20">
            <div id="catalogo-loader" class="text-center py-20">
                <i data-lucide="loader-2" class="w-10 h-10 animate-spin mx-auto text-slate-300"></i>
            </div>
        </div>
    </main>

    <div id="chat-widget" class="chat-widget chat-closed bg-white border border-slate-200 shadow-2xl flex flex-col overflow-hidden">
        <div id="chat-header" class="h-14 flex items-center justify-between px-4 bg-slate-900 text-white" onclick="toggleChat()">
            <div class="flex items-center gap-2"><span>ü¶â</span> <span class="font-bold text-sm">Don B√∫ho</span></div>
            <i data-lucide="chevron-up" id="chat-icon"></i>
        </div>
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 text-xs bg-slate-50"></div>
        <form onsubmit="enviarPregunta(event)" class="p-3 bg-white border-t flex gap-2">
            <input type="text" id="chat-input" placeholder="Pregunta..." class="flex-1 bg-slate-100 rounded-full px-4 outline-none">
            <button class="w-8 h-8 bg-indigo-600 text-white rounded-full flex items-center justify-center"><i data-lucide="send" class="w-3 h-3"></i></button>
        </form>
    </div>

    <script>
        // CONFIGURACI√ìN (Extra√≠da de tu Panel)
        const PROJECT_URL = 'https://vxggatcfrywyodovjwxj.supabase.co';
        const PUBLIC_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4Z2dhdGNmcnl3eW9kb3Zqd3hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzM5MjgsImV4cCI6MjA4MzgwOTkyOH0.RZ9jhEASO6nCV8EnzrHQBhglP4G1nik9Z5osPXysGNg';
        const db = supabase.createClient(PROJECT_URL, PUBLIC_KEY);

        let instGlobal = null;
        let cursoGlobal = null;

        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            lucide.createIcons();
            const params = new URLSearchParams(window.location.search);
            const instSigla = params.get('inst');
            const courseId = params.get('id');

            try {
                // 1. Cargar Instituci√≥n (L√≥gica Sincro Panel)
                let instData;
                if (courseId) {
                    const { data: curso } = await db.from('cursos_oficiales').select('*, instituciones(*)').eq('id', courseId).single();
                    cursoGlobal = curso;
                    instData = curso.instituciones;
                    renderCurso();
                } else {
                    const { data: inst } = await db.from('instituciones').select('*').eq('sigla', instSigla).single();
                    instData = inst;
                }

                if (!instData) throw new Error("Portal no configurado");
                instGlobal = instData;
                
                // 2. Aplicar Branding
                aplicarMarca();

                // 3. Cargar √Åreas (L√≥gica Sincro Panel: institution_id)
                await cargarContenido(instGlobal.id);

            } catch (err) {
                console.error(err);
                document.getElementById('nombre-inst').innerText = "Portal no encontrado";
            }
        }

        function aplicarMarca() {
            document.getElementById('nombre-inst').innerText = instGlobal.nombre;
            document.documentElement.style.setProperty('--primary-color', instGlobal.color_primario);
            document.getElementById('hero-accent').style.color = instGlobal.color_primario;
            document.getElementById('chat-header').style.backgroundColor = instGlobal.color_primario;
            document.getElementById('btn-submit') ? document.getElementById('btn-submit').style.backgroundColor = instGlobal.color_primario : null;
            
            if (instGlobal.logo_url) {
                const img = document.getElementById('logo-inst');
                img.src = instGlobal.logo_url;
                document.getElementById('logo-container').classList.remove('hidden');
            }
        }

        async function cargarContenido(instId) {
            // Consulta Sincro: Traemos √°reas que pertenecen a la instituci√≥n
            const { data: areas, error } = await db.from('areas')
                .select('*, cursos_oficiales(*)')
                .eq('institution_id', instId) // Filtro seg√∫n Admin
                .order('orden');

            const container = document.getElementById('areas-container');
            container.innerHTML = "";

            if (error || !areas || areas.length === 0) {
                container.innerHTML = "<p class='text-center py-20 text-slate-400'>No hay √°reas configuradas en el Admin.</p>";
                return;
            }

            areas.forEach(area => {
                // Sincro: El Panel usa area_id en cursos_oficiales para agrupar
                if (area.cursos_oficiales && area.cursos_oficiales.length > 0) {
                    const section = document.createElement('div');
                    section.className = "fade-in";
                    section.innerHTML = `
                        <div class="flex items-center gap-4 mb-8">
                            <h3 class="text-2xl font-black text-slate-900 uppercase">${area.nombre}</h3>
                            <div class="h-1 flex-1 bg-slate-100 rounded-full relative">
                                <div class="absolute inset-0 w-20 rounded-full" style="background-color: var(--primary-color)"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            ${area.cursos_oficiales.map(c => `
                                <div class="bg-white rounded-2xl border border-slate-200 p-6 hover-lift flex flex-col h-full shadow-sm">
                                    <h4 class="text-lg font-bold text-slate-900 mb-2">${c.nombre}</h4>
                                    <p class="text-xs text-slate-500 line-clamp-2 mb-6">${c.descripcion || ''}</p>
                                    <div class="mt-auto flex justify-between items-center pt-4 border-t border-slate-50">
                                        <span class="text-[10px] font-bold text-indigo-600">CERTIFICADO</span>
                                        <a href="portal.html?id=${c.id}" class="text-sm font-black" style="color: var(--primary-color)">VER M√ÅS ‚Üí</a>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    container.appendChild(section);
                }
            });
            lucide.createIcons();
        }

        function renderCurso() {
            document.getElementById('vista-curso').classList.remove('hidden');
            document.getElementById('det-titulo').innerText = cursoGlobal.nombre;
            document.getElementById('det-desc').innerText = cursoGlobal.descripcion || "Formaci√≥n profesional certificada.";
            
            const acc = document.getElementById('temario-accordion');
            if (cursoGlobal.contenido && Array.isArray(cursoGlobal.contenido)) {
                cursoGlobal.contenido.forEach((mod, i) => {
                    acc.innerHTML += `<div class="p-4 bg-slate-50 rounded-xl border border-slate-100 text-xs font-bold">M√≥dulo ${i+1}: ${mod.titulo}</div>`;
                });
            }
        }

        // LEADS (Sincro con tabla 'leads' del Panel)
        document.getElementById('form-lead')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.innerText = "PROCESANDO...";
            
            const f = new FormData(e.target);
            const { error } = await db.from('leads').insert({
                nombre: f.get('nombre'),
                email: f.get('email'),
                telefono: f.get('telefono'),
                curso_interes: cursoGlobal?.nombre || 'Consulta General',
                institution_id: instGlobal.id,
                fuente: 'Portal SaaS',
                estado: 'nuevo' // Estado inicial para CRM
            });

            if (!error) {
                btn.innerText = "¬°ENVIADO!";
                btn.style.backgroundColor = "#10b981";
                const wpp = instGlobal.telefono_contacto?.replace(/\D/g, '');
                if (wpp) setTimeout(() => window.open(`https://wa.me/${wpp}`, '_blank'), 1000);
            }
        });

        // CHATBOT
        function toggleChat() {
            const w = document.getElementById('chat-widget');
            w.classList.toggle('chat-closed');
            w.classList.toggle('chat-open');
        }

        async function enviarPregunta(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const txt = input.value;
            if (!txt) return;

            addMsg(txt, 'user');
            input.value = "";
            
            try {
                const { data: sec } = await db.from('app_secrets').select('value').eq('name', 'gemini_api_key').single();
                const prompt = `Eres Don B√∫ho de ${instGlobal.nombre}. Responde sobre: ${cursoGlobal ? cursoGlobal.nombre : 'nuestra oferta'}. S√© breve. Usuario: ${txt}`;
                
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${sec.value}`, {
                    method: 'POST', body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const json = await res.json();
                addMsg(marked.parse(json.candidates[0].content.parts[0].text), 'bot');
            } catch (e) { addMsg("Hola, ¬øen qu√© puedo ayudarte?", 'bot'); }
        }

        function addMsg(h, s) {
            const m = document.getElementById('chat-messages');
            const d = document.createElement('div');
            d.className = s === 'user' ? 'flex justify-end' : 'flex justify-start';
            d.innerHTML = `<div class="${s === 'user' ? 'bg-indigo-600 text-white' : 'bg-white border'} p-3 rounded-2xl max-w-[80%] shadow-sm">${h}</div>`;
            m.appendChild(d);
            m.scrollTop = m.scrollHeight;
        }
    </script>
</body>
</html>
