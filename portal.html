<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Acad√©mico | ASARI SaaS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary-color: #4f46e5; }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #475569; scroll-behavior: smooth; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hover-lift { transition: all 0.3s ease; }
        .hover-lift:hover { transform: translateY(-5px); box-shadow: 0 15px 30px -10px rgba(0,0,0,0.1); }
        .chat-widget { position: fixed; bottom: 20px; right: 20px; z-index: 1000; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .chat-open { width: 350px; height: 500px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .chat-closed { width: 60px; height: 60px; border-radius: 50%; cursor: pointer; }
        
        /* Estilos para validaci√≥n segura */
        .safe-apply { transition: all 0.3s ease; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <nav class="fixed w-full z-50 bg-white/90 backdrop-blur-md border-b border-slate-200 h-20">
        <div class="max-w-7xl mx-auto px-6 h-full flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div id="logo-container" class="h-10 hidden bg-white p-1 rounded border border-slate-100 shadow-sm">
                    <img id="logo-inst" src="" class="h-full object-contain" alt="Logo" onerror="this.style.display='none'">
                </div>
                <span id="nombre-inst" class="font-black text-xl tracking-tighter text-slate-900 uppercase">Cargando...</span>
            </div>
            <div class="hidden md:flex items-center gap-8 text-[11px] font-bold uppercase tracking-widest">
                <a href="#inicio" class="hover:text-indigo-600 transition">Inicio</a>
                <a href="#areas-container" class="hover:text-indigo-600 transition">√Åreas</a>
                <button id="btn-campus" class="bg-slate-900 text-white px-5 py-2 rounded-full hover:bg-slate-800 transition shadow-lg">Campus</button>
            </div>
        </div>
    </nav>

    <header id="inicio" class="pt-40 pb-20 bg-slate-50 relative overflow-hidden border-b border-slate-100">
        <div class="max-w-5xl mx-auto px-6 text-center relative z-10 fade-in">
            <h1 id="hero-title" class="text-5xl md:text-7xl font-black text-slate-900 leading-tight mb-4">
                Lidera tu <br> <span id="hero-accent" class="text-indigo-600 italic">futuro profesional</span>
            </h1>
            <p id="hero-desc" class="text-lg text-slate-500 max-w-2xl mx-auto">Excelencia acad√©mica y formaci√≥n t√©cnica de vanguardia.</p>
        </div>
    </header>

    <main class="flex-1 max-w-7xl mx-auto px-6 w-full py-12">
        
        <section id="vista-curso" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-12 mb-20 fade-in">
            <div class="lg:col-span-2 space-y-8">
                <div class="bg-white rounded-3xl p-8 border border-slate-200 shadow-sm">
                    <h2 id="det-titulo" class="text-4xl font-black text-slate-900 mb-6 uppercase tracking-tighter">Cargando Curso...</h2>
                    <div id="det-desc" class="text-slate-600 mb-10 leading-relaxed text-lg"></div>
                    <div class="space-y-4">
                        <h3 class="font-black text-slate-900 flex items-center gap-2 text-sm uppercase">
                            <i data-lucide="book-open" class="w-4 h-4"></i> Plan de Estudios
                        </h3>
                        <div id="temario-accordion" class="space-y-2"></div>
                    </div>
                </div>
            </div>
            <div class="lg:col-span-1">
                <div class="bg-slate-950 rounded-3xl p-8 text-white shadow-2xl sticky top-28 border border-white/5">
                    <h3 class="text-xl font-bold mb-2">Inscripci√≥n</h3>
                    <p class="text-slate-400 text-xs mb-6 uppercase tracking-widest font-bold">Solicita una vacante hoy</p>
                    <form id="form-lead" class="space-y-4">
                        <input type="text" name="nombre" placeholder="Nombre completo" required class="w-full bg-white/10 border-none rounded-xl p-4 text-white outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                        <input type="email" name="email" placeholder="Correo electr√≥nico" required class="w-full bg-white/10 border-none rounded-xl p-4 text-white outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                        <input type="tel" name="telefono" placeholder="WhatsApp (Ej: +549...)" required class="w-full bg-white/10 border-none rounded-xl p-4 text-white outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                        <button type="submit" id="btn-submit" class="w-full py-4 rounded-xl font-black uppercase tracking-widest bg-indigo-600 hover:bg-indigo-500 transition-all shadow-lg shadow-indigo-600/20 safe-apply">Enviar Solicitud</button>
                    </form>
                </div>
            </div>
        </section>

        <div id="areas-container" class="space-y-24">
            <div id="catalogo-loader" class="text-center py-20">
                <i data-lucide="loader-2" class="w-10 h-10 animate-spin mx-auto text-slate-300"></i>
                <p class="text-xs font-bold text-slate-400 uppercase mt-4 tracking-widest">Sincronizando con base de datos...</p>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t border-slate-200 py-12">
        <div class="max-w-7xl mx-auto px-6 text-center">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">¬© 2026 <span id="footer-inst">ASARI Platform</span></p>
        </div>
    </footer>

    <div id="chat-widget" class="chat-widget chat-closed bg-white border border-slate-200 shadow-2xl flex flex-col overflow-hidden">
        <div id="chat-header" class="h-14 flex items-center justify-between px-4 bg-slate-900 text-white cursor-pointer" onclick="toggleChat()">
            <div class="flex items-center gap-2"><span class="text-lg">ü¶â</span> <span class="font-bold text-xs uppercase tracking-tighter">Asesor Don B√∫ho</span></div>
            <i data-lucide="chevron-up" id="chat-icon" class="w-4 h-4"></i>
        </div>
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 text-[11px] bg-slate-50 leading-relaxed"></div>
        <form onsubmit="enviarPregunta(event)" class="p-3 bg-white border-t flex gap-2">
            <input type="text" id="chat-input" placeholder="Escribe tu duda aqu√≠..." class="flex-1 bg-slate-100 rounded-full px-4 text-xs outline-none focus:ring-2 focus:ring-indigo-600 transition-all">
            <button class="w-8 h-8 bg-indigo-600 text-white rounded-full flex items-center justify-center shadow-md"><i data-lucide="send" class="w-3 h-3"></i></button>
        </form>
    </div>

    <script>
        // ============================================
        // CONFIGURACI√ìN Y VARIABLES GLOBALES
        // ============================================
        const PROJECT_URL = 'https://vxggatcfrywyodovjwxj.supabase.co';
        const PUBLIC_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4Z2dhdGNmcnl3eW9kb3Zqd3hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzM5MjgsImV4cCI6MjA4MzgwOTkyOH0.RZ9jhEASO6nCV8EnzrHQBhglP4G1nik9Z5osPXysGNg';
        const db = supabase.createClient(PROJECT_URL, PUBLIC_KEY);

        let instGlobal = null;
        let cursoGlobal = null;
        let currentInstitutionId = null;

        // ============================================
        // 1. INICIALIZACI√ìN PRINCIPAL
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            await initPortal();
        });

        async function initPortal() {
            const params = new URLSearchParams(window.location.search);
            const instSigla = params.get('inst');
            const courseId = params.get('id');

            console.log("üöÄ Portal SaaS iniciando...");
            console.log("üìå Par√°metros URL:", { instSigla, courseId });

            try {
                // MODO 1: Vista espec√≠fica de curso (?id=UUID)
                if (courseId) {
                    await cargarVistaCurso(courseId);
                }
                // MODO 2: Portal institucional (?inst=sigla)
                else if (instSigla) {
                    await cargarVistaInstitucional(instSigla);
                }
                // MODO 3: Sin par√°metros - error
                else {
                    throw new Error("Acceso inv√°lido: Se requiere par√°metro ?inst=sigla o ?id=curso");
                }

                // Cargar cat√°logo despu√©s de tener institution_id
                if (currentInstitutionId) {
                    await cargarContenido(currentInstitutionId);
                }

            } catch (error) {
                console.error("‚ùå ERROR CR√çTICO:", error);
                mostrarError(error.message);
            }
        }

        // ============================================
        // 2. CARGA DE VISTA INSTITUCIONAL
        // ============================================
        async function cargarVistaInstitucional(sigla) {
            console.log(`üîç Buscando instituci√≥n con sigla: ${sigla}`);
            
            const { data: institucion, error } = await db
                .from('instituciones')
                .select('*')
                .eq('sigla', sigla)
                .eq('activo', true)
                .single();

            if (error || !institucion) {
                throw new Error(`Instituci√≥n "${sigla}" no encontrada o inactiva`);
            }

            instGlobal = institucion;
            currentInstitutionId = institucion.id;
            
            console.log("‚úÖ Instituci√≥n cargada:", institucion.nombre, "ID:", institucion.id);
            
            aplicarBranding();
            renderHomeInstituto();
        }

        // ============================================
        // 3. CARGA DE VISTA DE CURSO ESPEC√çFICO
        // ============================================
        async function cargarVistaCurso(cursoId) {
            console.log(`üîç Buscando curso con ID: ${cursoId}`);
            
            const { data: curso, error } = await db
                .from('cursos_oficiales')
                .select('*, instituciones(*)')
                .eq('id', cursoId)
                .single();

            if (error || !curso) {
                throw new Error("Curso no encontrado en la base de datos");
            }

            cursoGlobal = curso;
            instGlobal = curso.instituciones;
            currentInstitutionId = curso.institution_id || curso.institucion_id || curso.instituciones?.id;
            
            console.log("‚úÖ Curso cargado:", curso.nombre);
            
            aplicarBranding();
            renderVistaCurso();
        }

        // ============================================
        // 4. APLICACI√ìN DE BRANDING (CON VALIDACI√ìN SEGURA)
        // ============================================
        function aplicarBranding() {
            if (!instGlobal) return;
            
            // 1. T√≠tulo y metadata
            document.title = `${instGlobal.nombre} | Portal Acad√©mico`;
            
            // 2. Textos institucionales
            safeSetText('nombre-inst', instGlobal.nombre);
            safeSetText('footer-inst', instGlobal.nombre);
            
            // 3. Color primario (con validaci√≥n)
            const color = instGlobal.color_primario || '#4f46e5';
            if (color) {
                document.documentElement.style.setProperty('--primary-color', color);
                
                const heroAccent = document.getElementById('hero-accent');
                if (heroAccent) heroAccent.style.color = color;
                
                const chatHeader = document.getElementById('chat-header');
                if (chatHeader) chatHeader.style.backgroundColor = color;
                
                const btnSubmit = document.getElementById('btn-submit');
                if (btnSubmit) btnSubmit.style.backgroundColor = color;
                
                const btnCampus = document.getElementById('btn-campus');
                if (btnCampus) btnCampus.style.backgroundColor = color;
            }
            
            // 4. Logo (con validaci√≥n)
            if (instGlobal.logo_url) {
                const logoContainer = document.getElementById('logo-container');
                const logoImg = document.getElementById('logo-inst');
                
                if (logoContainer && logoImg) {
                    logoImg.src = instGlobal.logo_url;
                    logoContainer.classList.remove('hidden');
                }
            }
        }

        // ============================================
        // 5. CARGA DE CONTENIDO - DOBLE CARGA INFALIBLE
        // ============================================
        async function cargarContenido(instId) {
            console.log("üîç PLAN B INFALIBLE activado para Instituci√≥n ID:", instId);
            
            const container = document.getElementById('areas-container');
            if (!container) return;
            
            // Ocultar loader
            const loader = document.getElementById('catalogo-loader');
            if (loader) loader.style.display = 'none';
            
            try {
                // PASO 1: Obtener √°reas de la instituci√≥n (usando OR robusto)
                console.log("üì¶ PASO 1: Obteniendo √°reas...");
                let areas = [];
                try {
                    const { data: areasData, error: areasError } = await db
                        .from('areas')
                        .select('*')
                        .or(`institution_id.eq.${instId},institucion_id.eq.${instId}`)
                        .order('orden', { ascending: true });
                    
                    if (areasError) {
                        console.warn("‚ö†Ô∏è Consulta OR fall√≥, probando individualmente...");
                        // Intentar con cada columna
                        const { data: data1 } = await db
                            .from('areas')
                            .select('*')
                            .eq('institution_id', instId)
                            .order('orden', { ascending: true });
                        
                        if (data1 && data1.length > 0) {
                            areas = data1;
                        } else {
                            const { data: data2 } = await db
                                .from('areas')
                                .select('*')
                                .eq('institucion_id', instId)
                                .order('orden', { ascending: true });
                            
                            if (data2) areas = data2;
                        }
                    } else {
                        areas = areasData || [];
                    }
                } catch (error) {
                    console.error("‚ùå Error obteniendo √°reas:", error);
                    areas = [];
                }
                
                console.log(`‚úÖ √Åreas encontradas: ${areas.length}`);
                
                // Si no hay √°reas, mostrar mensaje
                if (areas.length === 0) {
                    mostrarSinContenido();
                    return;
                }
                
                // PASO 2: Obtener cursos de la instituci√≥n (usando OR robusto)
                console.log("üì¶ PASO 2: Obteniendo cursos...");
                let cursos = [];
                try {
                    const { data: cursosData, error: cursosError } = await db
                        .from('cursos_oficiales')
                        .select('*')
                        .or(`institution_id.eq.${instId},institucion_id.eq.${instId}`);
                    
                    if (cursosError) {
                        console.warn("‚ö†Ô∏è Consulta OR fall√≥ para cursos, probando individualmente...");
                        // Intentar con cada columna
                        const { data: data1 } = await db
                            .from('cursos_oficiales')
                            .select('*')
                            .eq('institution_id', instId);
                        
                        if (data1 && data1.length > 0) {
                            cursos = data1;
                        } else {
                            const { data: data2 } = await db
                                .from('cursos_oficiales')
                                .select('*')
                                .eq('institucion_id', instId);
                            
                            if (data2) cursos = data2;
                        }
                    } else {
                        cursos = cursosData || [];
                    }
                } catch (error) {
                    console.error("‚ùå Error obteniendo cursos:", error);
                    cursos = [];
                }
                
                console.log(`‚úÖ Cursos encontrados: ${cursos.length}`);
                
                // PASO 3: Cruce de datos en JavaScript
                console.log("üîÑ PASO 3: Cruzando datos √°reas ‚Üî cursos...");
                
                // Crear array final de √°reas con sus cursos
                const areasConCursos = areas.map(area => {
                    // Filtrar cursos que pertenecen a esta √°rea (c.area_id === area.id)
                    const cursosDeArea = cursos.filter(curso => {
                        return curso.area_id === area.id;
                    });
                    
                    return {
                        ...area,
                        cursos_oficiales: cursosDeArea
                    };
                });
                
                console.log(`‚úÖ √Åreas con cursos despu√©s del cruce: ${areasConCursos.filter(a => a.cursos_oficiales.length > 0).length}`);
                
                // PASO 4: Renderizar resultados
                renderAreas(areasConCursos);
                
            } catch (error) {
                console.error("‚ùå Error cr√≠tico en PLAN B INFALIBLE:", error);
                mostrarErrorContenido(error, instId);
            }
        }

        // ============================================
        // 6. RENDERIZADO DE √ÅREAS Y CURSOS
        // ============================================
        function renderAreas(areas) {
            const container = document.getElementById('areas-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Filtrar solo √°reas que tienen cursos
            const areasConCursos = areas.filter(area => {
                const cursosValidos = (area.cursos_oficiales || []).filter(curso => {
                    // Validar datos m√≠nimos del curso
                    if (!curso || !curso.nombre || curso.nombre.trim() === '') {
                        return false;
                    }
                    
                    // Validar estado activo (si existe la propiedad)
                    if (curso.activo !== undefined && curso.activo !== true) {
                        return false;
                    }
                    
                    return true;
                });
                
                area.cursos_filtrados = cursosValidos;
                return cursosValidos.length > 0;
            });
            
            console.log(`üéØ √Åreas con cursos v√°lidos para mostrar: ${areasConCursos.length}`);
            
            if (areasConCursos.length === 0) {
                mostrarSinContenido();
                return;
            }
            
            // Renderizar cada √°rea con sus cursos
            areasConCursos.forEach((area, index) => {
                const areaElement = document.createElement('div');
                areaElement.className = `fade-in`;
                areaElement.style.animationDelay = `${index * 0.1}s`;
                
                areaElement.innerHTML = `
                    <div class="flex items-center gap-4 mb-8">
                        <div class="w-10 h-1 rounded-full" style="background-color: var(--primary-color)"></div>
                        <h3 class="text-2xl font-black text-slate-900 uppercase tracking-tighter">${area.nombre}</h3>
                        <span class="text-xs font-bold bg-slate-100 text-slate-600 px-2 py-1 rounded">
                            ${area.cursos_filtrados.length} curso${area.cursos_filtrados.length !== 1 ? 's' : ''}
                        </span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${area.cursos_filtrados.map(curso => `
                            <div class="bg-white rounded-2xl border border-slate-200 p-6 hover-lift flex flex-col h-full shadow-sm transition-all duration-300 group">
                                <h4 class="text-lg font-bold text-slate-900 mb-2 uppercase tracking-tight line-clamp-2">${curso.nombre}</h4>
                                <p class="text-[11px] text-slate-500 line-clamp-3 mb-4 flex-1">${curso.descripcion || 'Formaci√≥n profesional con certificaci√≥n oficial.'}</p>
                                <div class="mt-auto flex justify-between items-center pt-4 border-t border-slate-50">
                                    <span class="text-[9px] font-black bg-slate-100 text-slate-600 px-2 py-0.5 rounded tracking-widest">OFICIAL</span>
                                    <a href="?id=${curso.id}" class="text-xs font-bold hover:underline group-hover:translate-x-1 transition-transform" style="color: var(--primary-color)">
                                        VER DETALLE <i data-lucide="arrow-right" class="w-3 h-3 inline ml-1"></i>
                                    </a>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(areaElement);
            });
            
            lucide.createIcons();
            
            // Mostrar resumen en consola
            const totalCursos = areasConCursos.reduce((total, area) => total + area.cursos_filtrados.length, 0);
            console.log(`üéâ Renderizado completado: ${areasConCursos.length} √°reas con ${totalCursos} cursos totales`);
        }

        function mostrarSinContenido() {
            const container = document.getElementById('areas-container');
            if (!container) return;
            
            container.innerHTML = `
                <div class="text-center py-20 bg-white rounded-3xl border border-dashed border-slate-200 fade-in">
                    <i data-lucide="folder-open" class="w-12 h-12 text-slate-300 mx-auto mb-4"></i>
                    <p class="text-slate-500 font-bold uppercase tracking-widest text-sm mb-2">Cat√°logo en preparaci√≥n</p>
                    <p class="text-xs text-slate-400 max-w-md mx-auto">
                        ${instGlobal?.nombre || 'Esta instituci√≥n'} est√° actualizando su oferta acad√©mica.
                    </p>
                    <p class="text-[10px] text-slate-300 mt-4">Instituci√≥n ID: ${currentInstitutionId}</p>
                </div>
            `;
            lucide.createIcons();
        }

        function mostrarErrorContenido(error, instId) {
            const container = document.getElementById('areas-container');
            if (!container) return;
            
            container.innerHTML = `
                <div class="text-center py-20 fade-in">
                    <p class="text-red-500 font-bold">Error al cargar el cat√°logo</p>
                    <p class="text-xs text-slate-400 mt-2 max-w-md mx-auto">${error.message}</p>
                    <button onclick="cargarContenido('${instId}')" class="mt-4 text-xs bg-slate-100 hover:bg-slate-200 px-4 py-2 rounded-full font-bold transition-colors">
                        Reintentar
                    </button>
                </div>
            `;
        }

        // ============================================
        // 7. RENDERIZADO DE VISTAS
        // ============================================
        function renderVistaCurso() {
            const vistaCurso = document.getElementById('vista-curso');
            if (!vistaCurso || !cursoGlobal) return;
            
            vistaCurso.classList.remove('hidden');
            
            safeSetText('det-titulo', cursoGlobal.nombre);
            safeSetText('det-desc', cursoGlobal.descripcion || 'Formaci√≥n profesional con amplia salida laboral y certificaci√≥n oficial.');
            
            // Temario/Contenido
            const temario = document.getElementById('temario-accordion');
            if (temario) {
                temario.innerHTML = '';
                
                if (cursoGlobal.contenido && Array.isArray(cursoGlobal.contenido)) {
                    cursoGlobal.contenido.forEach((modulo, index) => {
                        temario.innerHTML += `
                            <div class="p-4 bg-slate-50 rounded-xl border border-slate-100 text-[11px] font-bold text-slate-700 flex justify-between items-center hover:bg-slate-100 transition-colors">
                                <span>M√ìDULO ${index + 1}: ${modulo.titulo?.toUpperCase() || 'Sin t√≠tulo'}</span>
                                <i data-lucide="chevron-right" class="w-3 h-3 text-slate-300"></i>
                            </div>
                        `;
                    });
                } else {
                    temario.innerHTML = `
                        <div class="p-4 bg-slate-50 rounded-xl border border-slate-100 text-slate-500 text-center text-xs">
                            Contenido program√°tico disponible al inscribirse
                        </div>
                    `;
                }
            }
            
            lucide.createIcons();
        }

        function renderHomeInstituto() {
            const heroTitle = document.getElementById('hero-title');
            const heroDesc = document.getElementById('hero-desc');
            
            if (heroTitle && instGlobal) {
                heroTitle.innerHTML = `Formaci√≥n Oficial en <br><span id="hero-accent" class="text-indigo-600 italic">${instGlobal.nombre}</span>`;
            }
            
            if (heroDesc) {
                heroDesc.textContent = `Explora nuestro cat√°logo acad√©mico y comienza hoy tu transformaci√≥n profesional.`;
            }
        }

        // ============================================
        // 8. GESTI√ìN DE LEADS (CRM INTEGRADO)
        // ============================================
        const formLead = document.getElementById('form-lead');
        if (formLead) {
            formLead.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!instGlobal) {
                    alert('Error: No se identific√≥ la instituci√≥n');
                    return;
                }
                
                const btn = document.getElementById('btn-submit');
                if (!btn) return;
                
                const originalText = btn.innerText;
                const originalBg = btn.style.backgroundColor;
                
                // Deshabilitar y mostrar estado de carga
                btn.innerText = "PROCESANDO...";
                btn.disabled = true;
                
                try {
                    const formData = new FormData(e.target);
                    const leadData = {
                        nombre: formData.get('nombre'),
                        email: formData.get('email'),
                        telefono: formData.get('telefono'),
                        curso_interes: cursoGlobal?.nombre || 'Consulta General',
                        institution_id: instGlobal.id,
                        fuente: 'Portal SaaS',
                        status: 'nuevo',
                        created_at: new Date().toISOString()
                    };
                    
                    console.log('üì§ Enviando lead:', leadData);
                    
                    const { error } = await db.from('leads').insert([leadData]);
                    
                    if (error) {
                        throw new Error(`Error al guardar: ${error.message}`);
                    }
                    
                    // √âxito
                    btn.innerText = "¬°SOLICITUD ENVIADA!";
                    btn.style.backgroundColor = "#10b981";
                    
                    // Redirigir a WhatsApp si hay tel√©fono configurado
                    setTimeout(() => {
                        if (instGlobal.telefono_contacto) {
                            const wppNum = instGlobal.telefono_contacto.replace(/\D/g, '');
                            const mensaje = encodeURIComponent(
                                `Hola, acabo de registrarme en el portal de ${instGlobal.nombre} ` +
                                `para el curso "${cursoGlobal?.nombre || 'General'}". ` +
                                `Mi nombre es ${leadData.nombre}. Necesito informaci√≥n.`
                            );
                            window.open(`https://wa.me/${wppNum}?text=${mensaje}`, '_blank');
                        }
                    }, 1500);
                    
                    // Resetear formulario despu√©s de 3 segundos
                    setTimeout(() => {
                        formLead.reset();
                        btn.innerText = originalText;
                        btn.style.backgroundColor = originalBg;
                        btn.disabled = false;
                    }, 3000);
                    
                } catch (error) {
                    console.error('‚ùå Error en formulario:', error);
                    alert(`Error: ${error.message}`);
                    btn.innerText = originalText;
                    btn.style.backgroundColor = originalBg;
                    btn.disabled = false;
                }
            });
        }

        // ============================================
        // 9. CHATBOT IA
        // ============================================
        function toggleChat() {
            const widget = document.getElementById('chat-widget');
            if (!widget) return;
            
            widget.classList.toggle('chat-closed');
            widget.classList.toggle('chat-open');
            
            const icon = document.getElementById('chat-icon');
            if (icon) {
                icon.style.transform = widget.classList.contains('chat-open') ? 'rotate(180deg)' : 'rotate(0deg)';
            }
            
            // Focus en input cuando se abre
            if (widget.classList.contains('chat-open')) {
                setTimeout(() => {
                    const input = document.getElementById('chat-input');
                    if (input) input.focus();
                }, 300);
            }
        }

        async function enviarPregunta(e) {
            e.preventDefault();
            
            const input = document.getElementById('chat-input');
            if (!input) return;
            
            const pregunta = input.value.trim();
            if (!pregunta) return;
            
            input.value = "";
            
            // Mostrar mensaje del usuario
            addMensajeChat(pregunta, 'user');
            
            // Mostrar indicador de carga
            const loadId = addMensajeChat('<div class="flex gap-1"><div class="w-2 h-2 bg-indigo-400 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-indigo-400 rounded-full animate-pulse" style="animation-delay:0.2s"></div><div class="w-2 h-2 bg-indigo-400 rounded-full animate-pulse" style="animation-delay:0.4s"></div></div>', 'bot');
            
            try {
                // Obtener API Key de Gemini
                const { data: secret } = await db
                    .from('app_secrets')
                    .select('value')
                    .eq('name', 'gemini_api_key')
                    .single();
                
                if (!secret) throw new Error('API Key no configurada');
                
                // Preparar prompt contextual
                const contextoCurso = cursoGlobal ? `Curso espec√≠fico: ${cursoGlobal.nombre}` : 'Oferta acad√©mica general';
                const prompt = `Eres "Don B√∫ho", asesor acad√©mico de ${instGlobal?.nombre || 'la instituci√≥n'}. 
                Contexto: ${contextoCurso}
                Pregunta del usuario: "${pregunta}"
                
                Responde de manera breve, √∫til y profesional. Si es sobre precios o inscripciones, sugiere contacto directo.`;
                
                // Llamada a Gemini
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${secret.value}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: {
                                temperature: 0.7,
                                topK: 40,
                                topP: 0.8,
                                maxOutputTokens: 200
                            }
                        })
                    }
                );
                
                if (!response.ok) throw new Error('Error en API Gemini');
                
                const data = await response.json();
                const respuesta = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No pude generar una respuesta.';
                
                // Remover loader y mostrar respuesta
                document.getElementById(loadId)?.remove();
                addMensajeChat(marked.parse(respuesta), 'bot');
                
            } catch (error) {
                console.error('‚ùå Error en chatbot:', error);
                document.getElementById(loadId)?.remove();
                addMensajeChat('Hola, ¬øen qu√© puedo ayudarte con nuestros cursos? Para informaci√≥n espec√≠fica sobre inscripciones, te recomiendo contactarnos directamente.', 'bot');
            }
        }

        function addMensajeChat(contenido, tipo) {
            const contenedor = document.getElementById('chat-messages');
            if (!contenedor) return null;
            
            const id = 'msg-' + Date.now();
            const mensajeDiv = document.createElement('div');
            mensajeDiv.id = id;
            mensajeDiv.className = tipo === 'user' ? 'flex justify-end' : 'flex justify-start';
            
            mensajeDiv.innerHTML = `
                <div class="${tipo === 'user' ? 'bg-indigo-600 text-white' : 'bg-white border border-slate-200 text-slate-700'} p-3 rounded-2xl max-w-[85%] shadow-sm text-xs leading-relaxed">
                    ${contenido}
                </div>
            `;
            
            contenedor.appendChild(mensajeDiv);
            contenedor.scrollTop = contenedor.scrollHeight;
            
            return id;
        }

        // ============================================
        // 10. FUNCIONES UTILITARIAS
        // ============================================
        function safeSetText(elementId, text) {
            const element = document.getElementById(elementId);
            if (element && text) {
                element.textContent = text;
            }
        }

        function mostrarError(mensaje) {
            const container = document.getElementById('areas-container');
            if (!container) return;
            
            container.innerHTML = `
                <div class="text-center py-20">
                    <h2 class="text-2xl font-black text-red-500 mb-2">¬°Vaya! Algo sali√≥ mal</h2>
                    <p class="text-slate-500 mb-4">${mensaje}</p>
                    <a href="https://asari.com.ar" class="mt-6 inline-block font-bold text-indigo-600 underline">Volver a ASARI</a>
                </div>
            `;
        }

        // Inicializar chatbot con mensaje de bienvenida
        setTimeout(() => {
            if (instGlobal && !document.querySelector('#chat-messages .flex.justify-start')) {
                addMensajeChat(`¬°Hola! Soy Don B√∫ho ü¶â, tu asesor acad√©mico en ${instGlobal.nombre}. ¬øEn qu√© puedo ayudarte hoy?`, 'bot');
            }
        }, 1000);
    </script>
</body>
</html>
