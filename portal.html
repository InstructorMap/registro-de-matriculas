<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Acad√©mico</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .hero-pattern { background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        
        /* Chatbot Animaciones */
        .chat-enter { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        /* Scrollbar invisible para chat */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-slate-800 flex flex-col min-h-screen">

    <nav class="sticky top-0 z-40 w-full glass border-b border-slate-200 transition-all duration-500" id="navbar">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <img id="logo-inst" src="" class="h-10 w-10 object-contain hidden">
                <h1 class="font-black text-xl tracking-tight text-slate-900" id="nombre-inst">Cargando...</h1>
            </div>
            <div class="hidden md:flex gap-6 items-center">
                <a href="#areas" class="text-sm font-bold text-slate-600 hover:text-slate-900">√Åreas Acad√©micas</a>
                <a href="index.html" class="text-sm font-bold text-white bg-slate-900 px-5 py-2.5 rounded-full hover:bg-slate-800 transition shadow-lg shadow-slate-900/20">Campus Alumnos</a>
            </div>
        </div>
    </nav>

    <header class="relative pt-24 pb-32 overflow-hidden hero-pattern">
        <div class="max-w-7xl mx-auto px-4 text-center relative z-10">
            <span class="inline-block py-1 px-3 rounded-full bg-blue-50 text-blue-700 text-[10px] font-black uppercase tracking-widest mb-6 border border-blue-100">Inscripciones Abiertas 2026</span>
            <h2 class="text-5xl md:text-7xl font-black text-slate-900 mb-6 tracking-tight leading-none">
                Tu futuro profesional <br>
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600" id="hero-highlight">comienza aqu√≠.</span>
            </h2>
            <p class="text-lg text-slate-500 max-w-2xl mx-auto mb-10 leading-relaxed">
                Accede a formaci√≥n de excelencia avalada por las instituciones m√°s prestigiosas. Encuentra tu vocaci√≥n en nuestros universos educativos especializados.
            </p>
            
            <div class="max-w-xl mx-auto relative group">
                <div class="absolute -inset-1 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000"></div>
                <div class="relative bg-white rounded-2xl shadow-xl flex items-center p-2 border border-slate-100">
                    <i data-lucide="search" class="ml-3 text-slate-400 w-5 h-5"></i>
                    <input type="text" id="main-search" placeholder="¬øQu√© te gustar√≠a aprender hoy?" class="w-full p-3 outline-none text-slate-700 font-medium placeholder:text-slate-400 bg-transparent" onkeydown="if(event.key === 'Enter') buscarChat()">
                    <button onclick="buscarChat()" class="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold hover:bg-black transition text-sm">Consultar</button>
                </div>
            </div>
        </div>
    </header>

    <section id="areas" class="py-20 bg-white border-t border-slate-100">
        <div class="max-w-7xl mx-auto px-4">
            <div class="text-center mb-16">
                <h3 class="text-3xl font-black text-slate-900">Nuestros Universos</h3>
                <p class="text-slate-500 mt-2">Explora las facultades y √°reas de especializaci√≥n disponibles.</p>
            </div>

            <div id="areas-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="col-span-3 text-center py-20">
                    <i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto text-slate-400 mb-2"></i>
                    <p class="text-sm text-slate-400">Conectando con la instituci√≥n...</p>
                </div>
            </div>
        </div>
    </section>

    <footer class="bg-slate-950 text-slate-400 py-12 mt-auto">
        <div class="max-w-7xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <p class="text-sm font-medium">¬© 2026 <span id="footer-inst-name">Instituci√≥n</span>. Plataforma SaaS.</p>
            </div>
            <div class="flex gap-4">
                <a href="#" class="hover:text-white transition p-2 bg-slate-900 rounded-full"><i data-lucide="instagram" class="w-4 h-4"></i></a>
                <a href="#" class="hover:text-white transition p-2 bg-slate-900 rounded-full"><i data-lucide="facebook" class="w-4 h-4"></i></a>
                <a href="#" class="hover:text-white transition p-2 bg-slate-900 rounded-full"><i data-lucide="mail" class="w-4 h-4"></i></a>
            </div>
        </div>
    </footer>

    <div id="concierge-widget" class="fixed bottom-6 right-6 z-50 flex flex-col items-end">
        
        <div id="chat-window" class="hidden w-80 md:w-96 bg-white rounded-2xl shadow-2xl border border-slate-200 overflow-hidden mb-4 chat-enter flex flex-col h-[500px]">
            <div class="bg-slate-900 p-4 flex items-center justify-between shrink-0 transition-colors" id="chat-header-bg">
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <div class="w-10 h-10 rounded-full bg-white p-0.5 shadow-md"><img src="https://cdn-icons-png.flaticon.com/512/4712/4712009.png" class="w-full h-full object-contain"></div>
                        <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-slate-900 rounded-full"></div>
                    </div>
                    <div>
                        <h4 class="font-bold text-white text-sm">Asistente de Admisi√≥n</h4>
                        <p class="text-[10px] text-white/70">En l√≠nea ‚Ä¢ Responde al instante</p>
                    </div>
                </div>
                <button onclick="toggleChat()" class="text-white/50 hover:text-white transition"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>

            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 no-scrollbar">
                <div class="flex gap-3">
                    <div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center shrink-0 text-xs shadow-sm">ü§ñ</div>
                    <div class="bg-white border border-slate-100 p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-600">
                        ¬°Hola! üëã Bienvenido. Estoy capacitado con toda la informaci√≥n institucional para ayudarte. ¬øQu√© te gustar√≠a estudiar?
                    </div>
                </div>
            </div>

            <div class="p-3 bg-white border-t border-slate-100">
                <form onsubmit="enviarMensaje(event)" class="flex gap-2">
                    <input type="text" id="chat-input" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:border-blue-500 transition" placeholder="Escribe tu consulta..." autocomplete="off">
                    <button type="submit" class="bg-slate-900 hover:bg-black text-white p-2 rounded-xl transition shadow-lg"><i data-lucide="send-horizontal" class="w-5 h-5"></i></button>
                </form>
            </div>
        </div>

        <button onclick="toggleChat()" class="group flex items-center justify-center">
            <div class="relative">
                <div class="absolute inset-0 bg-blue-600 rounded-full animate-ping opacity-20"></div>
                <div class="w-14 h-14 bg-slate-900 hover:bg-black text-white rounded-full shadow-2xl flex items-center justify-center transition-transform transform group-hover:scale-110 border-4 border-white">
                    <i data-lucide="message-circle" class="w-7 h-7"></i>
                </div>
                <span class="absolute top-0 right-0 flex h-4 w-4">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-4 w-4 bg-red-500 border-2 border-white"></span>
                </span>
            </div>
        </button>
    </div>

    <script>
        const PROJECT_URL = 'https://vxggatcfrywyodovjwxj.supabase.co';
        const PUBLIC_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4Z2dhdGNmcnl3eW9kb3Zqd3hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzM5MjgsImV4cCI6MjA4MzgwOTkyOH0.RZ9jhEASO6nCV8EnzrHQBhglP4G1nik9Z5osPXysGNg';
        const db = supabase.createClient(PROJECT_URL, PUBLIC_KEY);

        let institutionData = null;
        let globalDossier = ""; 

        // --- INICIO ---
        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            await loadInstitution();
            await loadAreas();
        });

        // 1. CARGAR IDENTIDAD (INTELIGENTE)
        async function loadInstitution() {
            const params = new URLSearchParams(window.location.search);
            const siglaUrl = params.get('inst');

            let query = db.from('instituciones').select('*');

            if (siglaUrl) {
                // Prioridad 1: URL Espec√≠fica
                query = query.eq('sigla', siglaUrl);
            } else {
                // Prioridad 2: Buscar Colbert o Fallback al primero activo
                query = query.ilike('nombre', '%Colbert%'); 
            }

            const { data, error } = await query.maybeSingle(); // maybeSingle evita error si hay varios, devuelve null si no hay
            
            // Si no encontr√≥ Colbert, buscar CUALQUIER activo
            if (!data) {
                const { data: fallback } = await db.from('instituciones').select('*').eq('activo', true).limit(1).single();
                institutionData = fallback;
            } else {
                institutionData = data;
            }

            if(institutionData) {
                // Pintar UI
                document.getElementById('nombre-inst').innerText = institutionData.nombre;
                document.getElementById('footer-inst-name').innerText = institutionData.nombre;
                
                if(institutionData.logo_url) {
                    const img = document.getElementById('logo-inst');
                    img.src = institutionData.logo_url;
                    img.classList.remove('hidden');
                }

                if(institutionData.color_primario) {
                    const color = institutionData.color_primario;
                    document.getElementById('navbar').style.borderTop = `4px solid ${color}`;
                    document.getElementById('hero-highlight').style.backgroundImage = `linear-gradient(to right, ${color}, #4f46e5)`;
                    document.getElementById('chat-header-bg').style.backgroundColor = color;
                }
            } else {
                console.error("No se encontr√≥ ninguna instituci√≥n.");
            }
        }

        // 2. CARGAR √ÅREAS (Los Universos)
        async function loadAreas() {
            if(!institutionData) return;
            const container = document.getElementById('areas-container');
            
            const { data: areas } = await db.from('areas')
                .select('*')
                .eq('institution_id', institutionData.id)
                .order('created_at');

            container.innerHTML = "";
            
            // Construir Memoria del Bot
            let allDossierText = `Eres el asistente oficial de ${institutionData.nombre}. Responde preguntas sobre nuestra oferta acad√©mica. `;

            if(areas && areas.length > 0) {
                areas.forEach(area => {
                    // Evitar cargar el √°rea 'General' si est√° vac√≠a o es interna
                    if(area.slug === 'general') return;

                    if(area.dossier_txt) allDossierText += `\n\n[√ÅREA: ${area.nombre}]\n${area.dossier_txt}`;

                    container.innerHTML += `
                    <div class="group relative bg-white rounded-2xl shadow-sm hover:shadow-xl border border-slate-100 overflow-hidden transition-all duration-300 hover:-translate-y-1 h-full flex flex-col">
                        <div class="absolute top-0 left-0 w-full h-1.5" style="background-color: ${area.color_tema || '#3b82f6'}"></div>
                        <div class="p-8 flex-1 flex flex-col">
                            <div class="w-14 h-14 rounded-2xl mb-6 flex items-center justify-center text-white shadow-lg group-hover:scale-110 transition-transform" style="background-color: ${area.color_tema || '#3b82f6'}">
                                <i data-lucide="graduation-cap" class="w-7 h-7"></i>
                            </div>
                            <h4 class="text-2xl font-bold text-slate-900 mb-3 leading-tight">${area.nombre}</h4>
                            <p class="text-sm text-slate-500 mb-6 flex-1">Formaci√≥n especializada. Haz clic para consultar sobre los cursos disponibles en esta √°rea.</p>
                            
                            <div class="pt-4 mt-auto">
                                <button onclick="preguntarSobreArea('${area.nombre}')" class="w-full py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition hover:opacity-90 text-white shadow-md" style="background-color: ${area.color_tema || '#3b82f6'}">
                                    Ver Oferta Acad√©mica <i data-lucide="arrow-right" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>`;
                });
                globalDossier = allDossierText;
            } else {
                container.innerHTML = `<div class="col-span-3 text-center text-slate-400 py-10">Pr√≥ximamente publicaremos nuestra oferta acad√©mica.</div>`;
            }
            lucide.createIcons();
        }

        // --- 3. CHATBOT CONCIERGE (IA) ---
        
        function toggleChat() {
            const chat = document.getElementById('chat-window');
            chat.classList.toggle('hidden');
            if(!chat.classList.contains('hidden')) document.getElementById('chat-input').focus();
        }

        function buscarChat() {
            const val = document.getElementById('main-search').value;
            if(val) {
                toggleChat();
                document.getElementById('chat-input').value = val;
                enviarMensaje({ preventDefault: () => {} });
            }
        }

        function preguntarSobreArea(nombreArea) {
            toggleChat();
            const input = document.getElementById('chat-input');
            input.value = `Me interesa el √°rea de ${nombreArea}. ¬øQu√© cursos tienen?`;
            enviarMensaje({ preventDefault: () => {} });
        }

        async function enviarMensaje(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(!msg) return;

            const chatBox = document.getElementById('chat-messages');
            chatBox.innerHTML += `<div class="flex gap-3 flex-row-reverse chat-enter"><div class="bg-slate-900 text-white p-3 rounded-2xl rounded-tr-none shadow-sm text-sm max-w-[85%]">${msg}</div></div>`;
            input.value = "";
            chatBox.scrollTop = chatBox.scrollHeight;

            const loadingId = 'load-' + Date.now();
            chatBox.innerHTML += `<div id="${loadingId}" class="flex gap-3 chat-enter"><div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center shrink-0 text-xs">ü§ñ</div><div class="bg-white border border-slate-100 p-3 rounded-2xl rounded-tl-none shadow-sm flex items-center gap-1 h-10"><div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div><div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div><div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div></div></div>`;
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                // Obtener API Key de BD
                const { data: secret } = await db.from('app_secrets').select('value').eq('name', 'gemini_api_key').single();
                
                if(!secret) throw new Error("Sistema de IA no configurado.");

                const prompt = `
                ERES UN EXPERTO EN ADMISIONES DE: ${institutionData.nombre}.
                
                TU CONOCIMIENTO (BASE DE DATOS):
                "${globalDossier}"
                
                PREGUNTA DEL INTERESADO: "${msg}"
                
                OBJETIVO: Vender y orientar.
                REGLAS:
                1. S√© breve y muy amable. Usa emojis.
                2. Si preguntan por un √°rea, resume sus ventajas y menciona cursos si los conoces.
                3. Si no sabes algo, invita a contactar a secretar√≠a.
                4. NO inventes precios si no est√°n en el texto.
                `;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite:generateContent?key=${secret.value}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                const reply = data.candidates[0].content.parts[0].text;

                document.getElementById(loadingId).remove();
                
                chatBox.innerHTML += `
                <div class="flex gap-3 chat-enter">
                    <div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center shrink-0 text-xs shadow-sm">ü§ñ</div>
                    <div class="bg-white border border-slate-100 p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-700 prose prose-sm max-w-[90%]">
                        ${marked.parse(reply)}
                    </div>
                </div>`;
                chatBox.scrollTop = chatBox.scrollHeight;

            } catch(e) {
                document.getElementById(loadingId).remove();
                chatBox.innerHTML += `<div class="text-xs text-red-400 text-center mt-2">Error de conexi√≥n con el servidor de IA.</div>`;
            }
        }
    </script>
</body>
</html>
