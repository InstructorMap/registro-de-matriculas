<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Acad√©mico</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .hero-pattern { background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        
        /* Chatbot Animaciones */
        .chat-enter { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        /* Scrollbar invisible para chat */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-slate-800 flex flex-col min-h-screen">

    <nav class="sticky top-0 z-40 w-full glass border-b border-slate-200 transition-colors duration-500" id="navbar">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <img id="logo-inst" src="" class="h-10 w-10 object-contain hidden">
                <h1 class="font-black text-xl tracking-tight text-slate-900" id="nombre-inst">Cargando...</h1>
            </div>
            <div class="hidden md:flex gap-6">
                <a href="#areas" class="text-sm font-bold text-slate-600 hover:text-slate-900">√Åreas de Estudio</a>
                <a href="#contacto" class="text-sm font-bold text-slate-600 hover:text-slate-900">Contacto</a>
                <a href="index.html" class="text-sm font-bold text-white bg-slate-900 px-4 py-2 rounded-full hover:bg-slate-800 transition">Campus Alumnos</a>
            </div>
        </div>
    </nav>

    <header class="relative pt-20 pb-32 overflow-hidden hero-pattern">
        <div class="max-w-7xl mx-auto px-4 text-center relative z-10">
            <span class="inline-block py-1 px-3 rounded-full bg-blue-100 text-blue-700 text-[10px] font-black uppercase tracking-widest mb-4">Inscripciones Abiertas 2026</span>
            <h2 class="text-5xl md:text-7xl font-black text-slate-900 mb-6 tracking-tight leading-none">
                Tu futuro profesional <br>
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600" id="hero-highlight">comienza aqu√≠.</span>
            </h2>
            <p class="text-lg text-slate-500 max-w-2xl mx-auto mb-10">
                Formaci√≥n acad√©mica de excelencia avalada por las instituciones m√°s prestigiosas. Encuentra tu vocaci√≥n en nuestros universos educativos.
            </p>
            
            <div class="max-w-xl mx-auto relative group">
                <div class="absolute -inset-1 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000"></div>
                <div class="relative bg-white rounded-2xl shadow-xl flex items-center p-2 border border-slate-100">
                    <i data-lucide="search" class="ml-3 text-slate-400 w-5 h-5"></i>
                    <input type="text" id="main-search" placeholder="¬øQu√© te gustar√≠a aprender hoy?" class="w-full p-3 outline-none text-slate-700 font-medium placeholder:text-slate-400 bg-transparent">
                    <button class="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold hover:bg-black transition text-sm">Buscar</button>
                </div>
            </div>
        </div>
    </header>

    <section id="areas" class="py-20 bg-white border-t border-slate-100">
        <div class="max-w-7xl mx-auto px-4">
            <div class="text-center mb-16">
                <h3 class="text-3xl font-black text-slate-900">Universos Acad√©micos</h3>
                <p class="text-slate-500 mt-2">Explora nuestras facultades y √°reas de especializaci√≥n</p>
            </div>

            <div id="areas-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="col-span-3 text-center py-20"><i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto text-slate-400"></i></div>
            </div>
        </div>
    </section>

    <footer class="bg-slate-900 text-slate-400 py-12 mt-auto">
        <div class="max-w-7xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-6">
            <p class="text-sm font-medium">¬© 2026 <span id="footer-inst-name">Instituci√≥n</span>. Todos los derechos reservados.</p>
            <div class="flex gap-4">
                <a href="#" class="hover:text-white transition"><i data-lucide="instagram" class="w-5 h-5"></i></a>
                <a href="#" class="hover:text-white transition"><i data-lucide="facebook" class="w-5 h-5"></i></a>
                <a href="#" class="hover:text-white transition"><i data-lucide="mail" class="w-5 h-5"></i></a>
            </div>
        </div>
    </footer>

    <div id="concierge-widget" class="fixed bottom-6 right-6 z-50 flex flex-col items-end">
        
        <div id="chat-window" class="hidden w-80 md:w-96 bg-white rounded-2xl shadow-2xl border border-slate-200 overflow-hidden mb-4 chat-enter flex flex-col h-[500px]">
            <div class="bg-slate-900 p-4 flex items-center justify-between shrink-0" id="chat-header-bg">
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <div class="w-10 h-10 rounded-full bg-white p-0.5"><img src="https://cdn-icons-png.flaticon.com/512/4712/4712009.png" class="w-full h-full object-contain"></div>
                        <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-slate-900 rounded-full"></div>
                    </div>
                    <div>
                        <h4 class="font-bold text-white text-sm">Asistente de Admisi√≥n</h4>
                        <p class="text-[10px] text-slate-400">En l√≠nea ahora</p>
                    </div>
                </div>
                <button onclick="toggleChat()" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>

            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 no-scrollbar">
                <div class="flex gap-3">
                    <div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center shrink-0 text-xs shadow-sm">ü§ñ</div>
                    <div class="bg-white border border-slate-100 p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-600">
                        ¬°Hola! üëã Soy la IA del instituto. ¬øTe interesa alg√∫n curso o √°rea en particular?
                    </div>
                </div>
            </div>

            <div class="p-3 bg-white border-t border-slate-100">
                <form onsubmit="enviarMensaje(event)" class="flex gap-2">
                    <input type="text" id="chat-input" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:border-blue-500 transition" placeholder="Escribe tu consulta..." autocomplete="off">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-xl transition"><i data-lucide="send-horizontal" class="w-5 h-5"></i></button>
                </form>
            </div>
        </div>

        <button onclick="toggleChat()" class="group flex items-center justify-center">
            <div class="relative">
                <div class="absolute inset-0 bg-blue-600 rounded-full animate-ping opacity-20"></div>
                <div class="w-14 h-14 bg-slate-900 hover:bg-black text-white rounded-full shadow-2xl flex items-center justify-center transition-transform transform group-hover:scale-110 border-4 border-white">
                    <i data-lucide="message-circle" class="w-7 h-7"></i>
                </div>
                <span class="absolute top-0 right-0 flex h-3 w-3">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                </span>
            </div>
        </button>
    </div>

    <script>
        const PROJECT_URL = 'https://vxggatcfrywyodovjwxj.supabase.co';
        const PUBLIC_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4Z2dhdGNmcnl3eW9kb3Zqd3hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzM5MjgsImV4cCI6MjA4MzgwOTkyOH0.RZ9jhEASO6nCV8EnzrHQBhglP4G1nik9Z5osPXysGNg';
        const db = supabase.createClient(PROJECT_URL, PUBLIC_KEY);

        let institutionData = null;
        let globalDossier = ""; // Memoria de la IA

        // --- INICIO ---
        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            await loadInstitution();
            await loadAreas();
        });

        // 1. CARGAR IDENTIDAD (Logo, Colores)
        async function loadInstitution() {
            // L√≥gica: Buscar la primera instituci√≥n activa (SaaS simple)
            // Idealmente leer√≠a subdomain, pero para demo usamos la primera.
            const { data, error } = await db.from('instituciones').select('*').limit(1).single();
            
            if(data) {
                institutionData = data;
                document.getElementById('nombre-inst').innerText = data.nombre;
                document.getElementById('footer-inst-name').innerText = data.nombre;
                
                if(data.logo_url) {
                    const img = document.getElementById('logo-inst');
                    img.src = data.logo_url;
                    img.classList.remove('hidden');
                }

                if(data.color_primario) {
                    // Aplicar colores din√°micos
                    document.getElementById('hero-highlight').style.backgroundImage = `linear-gradient(to right, ${data.color_primario}, #4f46e5)`;
                    // El chat tambi√©n hereda el color
                    document.getElementById('chat-header-bg').style.backgroundColor = data.color_primario;
                }
            }
        }

        // 2. CARGAR √ÅREAS (Los Universos)
        async function loadAreas() {
            if(!institutionData) return;
            const container = document.getElementById('areas-container');
            
            const { data: areas } = await db.from('areas')
                .select('*')
                .eq('institution_id', institutionData.id)
                .order('created_at');

            container.innerHTML = "";
            
            // Recopilar texto para la IA
            let allDossierText = `Est√°s actuando como el asistente de admisi√≥n de ${institutionData.nombre}. `;

            if(areas && areas.length > 0) {
                areas.forEach(area => {
                    // Agregar info a la IA
                    if(area.dossier_txt) allDossierText += `\n\nSOBRE EL √ÅREA ${area.nombre}: ${area.dossier_txt}`;

                    container.innerHTML += `
                    <div class="group relative bg-white rounded-2xl shadow-sm hover:shadow-xl border border-slate-100 overflow-hidden transition-all duration-300 hover:-translate-y-1">
                        <div class="absolute top-0 left-0 w-full h-1.5" style="background-color: ${area.color_tema || '#3b82f6'}"></div>
                        <div class="p-8">
                            <div class="w-12 h-12 rounded-xl mb-6 flex items-center justify-center text-white shadow-lg group-hover:scale-110 transition-transform" style="background-color: ${area.color_tema || '#3b82f6'}">
                                <i data-lucide="graduation-cap" class="w-6 h-6"></i>
                            </div>
                            <h4 class="text-xl font-bold text-slate-900 mb-2">${area.nombre}</h4>
                            <p class="text-sm text-slate-500 mb-6">Explora nuestra oferta acad√©mica especializada en este universo.</p>
                            
                            <div class="border-t border-slate-100 pt-4 mt-auto">
                                <button onclick="preguntarSobreArea('${area.nombre}')" class="text-sm font-bold flex items-center gap-2 transition" style="color: ${area.color_tema}">
                                    Ver Cursos <i data-lucide="arrow-right" class="w-4 h-4 group-hover:translate-x-1 transition-transform"></i>
                                </button>
                            </div>
                        </div>
                    </div>`;
                });
                globalDossier = allDossierText; // Guardar en memoria global
            } else {
                container.innerHTML = `<div class="col-span-3 text-center text-slate-400">Pr√≥ximamente publicaremos nuestra oferta acad√©mica.</div>`;
            }
            lucide.createIcons();
        }

        // --- 3. CHATBOT CONCIERGE (IA) ---
        
        function toggleChat() {
            const chat = document.getElementById('chat-window');
            chat.classList.toggle('hidden');
            if(!chat.classList.contains('hidden')) document.getElementById('chat-input').focus();
        }

        function preguntarSobreArea(nombreArea) {
            toggleChat();
            const input = document.getElementById('chat-input');
            input.value = `Quiero saber qu√© cursos tienen en el √°rea de ${nombreArea}`;
            enviarMensaje({ preventDefault: () => {} }); // Simular env√≠o
        }

        async function enviarMensaje(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(!msg) return;

            // UI Usuario
            const chatBox = document.getElementById('chat-messages');
            chatBox.innerHTML += `
            <div class="flex gap-3 flex-row-reverse chat-enter">
                <div class="bg-slate-900 text-white p-3 rounded-2xl rounded-tr-none shadow-sm text-sm max-w-[80%]">
                    ${msg}
                </div>
            </div>`;
            input.value = "";
            chatBox.scrollTop = chatBox.scrollHeight;

            // UI Loading
            const loadingId = 'load-' + Date.now();
            chatBox.innerHTML += `
            <div id="${loadingId}" class="flex gap-3 chat-enter">
                <div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center shrink-0 text-xs">ü§ñ</div>
                <div class="bg-white border border-slate-100 p-3 rounded-2xl rounded-tl-none shadow-sm flex items-center gap-1 h-10">
                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div>
                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div>
                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div>
                </div>
            </div>`;
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                // 1. Obtener API Key segura
                const { data: secret } = await db.from('app_secrets').select('value').eq('name', 'gemini_api_key').single();
                if(!secret) throw new Error("Falta configuraci√≥n de IA");

                // 2. Llamar a Gemini
                const prompt = `
                ERES UN ASISTENTE DE VENTAS EDUCATIVO.
                
                CONTEXTO DE LA INSTITUCI√ìN:
                "${globalDossier}"
                
                PREGUNTA DEL USUARIO: "${msg}"
                
                INSTRUCCIONES:
                - Responde de forma breve, amable y persuasiva.
                - Si preguntan por un √°rea, vende los beneficios.
                - Usa emojis.
                - No inventes cursos que no est√©n en el contexto.
                `;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite:generateContent?key=${secret.value}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                const reply = data.candidates[0].content.parts[0].text;

                document.getElementById(loadingId).remove();
                
                // Renderizar Markdown simple
                chatBox.innerHTML += `
                <div class="flex gap-3 chat-enter">
                    <div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center shrink-0 text-xs shadow-sm">ü§ñ</div>
                    <div class="bg-white border border-slate-100 p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-700 prose prose-sm max-w-[90%]">
                        ${marked.parse(reply)}
                    </div>
                </div>`;
                chatBox.scrollTop = chatBox.scrollHeight;

            } catch(e) {
                document.getElementById(loadingId).remove();
                chatBox.innerHTML += `<div class="text-xs text-red-400 text-center mt-2">Error de conexi√≥n. Intenta de nuevo.</div>`;
            }
        }
    </script>
</body>
</html>
