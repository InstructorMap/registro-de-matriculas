<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Acad√©mico | ASARI SaaS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary-color: #4f46e5; }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #475569; scroll-behavior: smooth; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hover-lift { transition: all 0.3s ease; }
        .hover-lift:hover { transform: translateY(-5px); box-shadow: 0 15px 30px -10px rgba(0,0,0,0.1); }
        .chat-widget { position: fixed; bottom: 20px; right: 20px; z-index: 1000; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .chat-open { width: 350px; height: 500px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .chat-closed { width: 60px; height: 60px; border-radius: 50%; cursor: pointer; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <nav class="fixed w-full z-50 bg-white/90 backdrop-blur-md border-b border-slate-200 h-20">
        <div class="max-w-7xl mx-auto px-6 h-full flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div id="logo-container" class="h-10 hidden bg-white p-1 rounded border border-slate-100 shadow-sm">
                    <img id="logo-inst" src="" class="h-full object-contain" alt="Logo">
                </div>
                <span id="nombre-inst" class="font-black text-xl tracking-tighter text-slate-900 uppercase">ASARI Platform</span>
            </div>
            <div class="hidden md:flex items-center gap-8 text-[11px] font-bold uppercase tracking-widest">
                <a href="#inicio" class="hover:text-indigo-600 transition">Inicio</a>
                <a href="#areas-container" class="hover:text-indigo-600 transition">√Åreas</a>
                <a href="student/index.html" class="bg-slate-900 text-white px-5 py-2 rounded-full hover:bg-slate-800 transition shadow-lg">Campus</a>
            </div>
        </div>
    </nav>

    <header id="inicio" class="pt-40 pb-20 bg-slate-50 relative overflow-hidden border-b border-slate-100">
        <div class="max-w-5xl mx-auto px-6 text-center relative z-10 fade-in">
            <h1 id="hero-title" class="text-5xl md:text-7xl font-black text-slate-900 leading-tight mb-4">
                Lidera tu <br> <span id="hero-accent" class="text-indigo-600 italic">futuro profesional</span>
            </h1>
            <p id="hero-desc" class="text-lg text-slate-500 max-w-2xl mx-auto">Excelencia acad√©mica y formaci√≥n t√©cnica de vanguardia.</p>
        </div>
    </header>

    <main class="flex-1 max-w-7xl mx-auto px-6 w-full py-12">
        
        <section id="vista-curso" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-12 mb-20 fade-in">
            <div class="lg:col-span-2 space-y-8">
                <div class="bg-white rounded-3xl p-8 border border-slate-200 shadow-sm">
                    <h2 id="det-titulo" class="text-4xl font-black text-slate-900 mb-6 uppercase tracking-tighter">Cargando Curso...</h2>
                    <div id="det-desc" class="text-slate-600 mb-10 leading-relaxed text-lg"></div>
                    <div class="space-y-4">
                        <h3 class="font-black text-slate-900 flex items-center gap-2 text-sm uppercase">
                            <i data-lucide="book-open" class="w-4 h-4"></i> Plan de Estudios
                        </h3>
                        <div id="temario-accordion" class="space-y-2"></div>
                    </div>
                </div>
            </div>
            <div class="lg:col-span-1">
                <div class="bg-slate-950 rounded-3xl p-8 text-white shadow-2xl sticky top-28 border border-white/5">
                    <h3 class="text-xl font-bold mb-2">Inscripci√≥n</h3>
                    <p class="text-slate-400 text-xs mb-6 uppercase tracking-widest font-bold">Solicita una vacante hoy</p>
                    <form id="form-lead" class="space-y-4">
                        <input type="text" name="nombre" placeholder="Nombre completo" required class="w-full bg-white/10 border-none rounded-xl p-4 text-white outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                        <input type="email" name="email" placeholder="Correo electr√≥nico" required class="w-full bg-white/10 border-none rounded-xl p-4 text-white outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                        <input type="tel" name="telefono" placeholder="WhatsApp (Ej: +549...)" required class="w-full bg-white/10 border-none rounded-xl p-4 text-white outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                        <button type="submit" id="btn-submit" class="w-full py-4 rounded-xl font-black uppercase tracking-widest bg-indigo-600 hover:bg-indigo-500 transition-all shadow-lg shadow-indigo-600/20">Enviar Solicitud</button>
                    </form>
                </div>
            </div>
        </section>

        <div id="areas-container" class="space-y-24">
            <div id="catalogo-loader" class="text-center py-20">
                <i data-lucide="loader-2" class="w-10 h-10 animate-spin mx-auto text-slate-300"></i>
                <p class="text-xs font-bold text-slate-400 uppercase mt-4 tracking-widest">Sincronizando con base de datos...</p>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t border-slate-200 py-12">
        <div class="max-w-7xl mx-auto px-6 text-center">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">¬© 2026 <span id="footer-inst">ASARI Platform</span></p>
        </div>
    </footer>

    <div id="chat-widget" class="chat-widget chat-closed bg-white border border-slate-200 shadow-2xl flex flex-col overflow-hidden">
        <div id="chat-header" class="h-14 flex items-center justify-between px-4 bg-slate-900 text-white cursor-pointer" onclick="toggleChat()">
            <div class="flex items-center gap-2"><span class="text-lg">ü¶â</span> <span class="font-bold text-xs uppercase tracking-tighter">Asesor Don B√∫ho</span></div>
            <i data-lucide="chevron-up" id="chat-icon" class="w-4 h-4"></i>
        </div>
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 text-[11px] bg-slate-50 leading-relaxed"></div>
        <form onsubmit="enviarPregunta(event)" class="p-3 bg-white border-t flex gap-2">
            <input type="text" id="chat-input" placeholder="Escribe tu duda aqu√≠..." class="flex-1 bg-slate-100 rounded-full px-4 text-xs outline-none focus:ring-2 focus:ring-indigo-600 transition-all">
            <button class="w-8 h-8 bg-indigo-600 text-white rounded-full flex items-center justify-center shadow-md"><i data-lucide="send" class="w-3 h-3"></i></button>
        </form>
    </div>

    <script>
        // CONFIGURACI√ìN DE CONEXI√ìN (Sincronizada con Panel V8.0)
        const PROJECT_URL = 'https://vxggatcfrywyodovjwxj.supabase.co';
        const PUBLIC_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4Z2dhdGNmcnl3eW9kb3Zqd3hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzM5MjgsImV4cCI6MjA4MzgwOTkyOH0.RZ9jhEASO6nCV8EnzrHQBhglP4G1nik9Z5osPXysGNg';
        const db = supabase.createClient(PROJECT_URL, PUBLIC_KEY);

        let instGlobal = null;
        let cursoGlobal = null;

        document.addEventListener('DOMContentLoaded', initPortal);

        async function initPortal() {
            lucide.createIcons();
            const params = new URLSearchParams(window.location.search);
            const instSigla = params.get('inst');
            const courseId = params.get('id');

            console.log("üöÄ Iniciando Portal con Sigla:", instSigla, "ID Curso:", courseId);

            try {
                let currentInstitutionId = null;

                // 1. CARGAR POR CURSO ESPEC√çFICO
                if (courseId) {
                    const { data: curso, error } = await db.from('cursos_oficiales')
                        .select('*, instituciones(*)')
                        .eq('id', courseId)
                        .single();
                    
                    if (error || !curso) throw new Error("Curso no encontrado en la base de datos");
                    
                    cursoGlobal = curso;
                    instGlobal = curso.instituciones;
                    currentInstitutionId = instGlobal.id;
                    renderVistaCurso();
                } 
                // 2. CARGAR POR SIGLA DE INSTITUTO (SaaS Mode)
                else if (instSigla) {
                    const { data: inst, error } = await db.from('instituciones')
                        .select('*')
                        .eq('sigla', instSigla)
                        .single();
                    
                    if (error || !inst) throw new Error("No se encontr√≥ el instituto '" + instSigla + "'");
                    
                    instGlobal = inst;
                    currentInstitutionId = inst.id;
                    renderHomeInstituto();
                } else {
                    throw new Error("Faltan par√°metros de acceso (id o inst)");
                }

                // 3. APLICAR IDENTIDAD VISUAL
                aplicarBranding();

                // 4. CARGAR CAT√ÅLOGO (√Åreas y Cursos)
                await cargarContenido(currentInstitutionId);

            } catch (err) {
                console.error("‚ùå ERROR CR√çTICO:", err.message);
                document.getElementById('areas-container').innerHTML = `
                    <div class="text-center py-20">
                        <h2 class="text-2xl font-black text-red-500 mb-2">¬°Vaya! Algo sali√≥ mal</h2>
                        <p class="text-slate-500">${err.message}</p>
                        <a href="https://asari.com.ar" class="mt-6 inline-block font-bold text-indigo-600 underline">Volver a ASARI</a>
                    </div>
                `;
            }
        }

        function aplicarBranding() {
            document.title = `${instGlobal.nombre} | Portal de Ventas`;
            document.getElementById('nombre-inst').innerText = instGlobal.nombre;
            document.getElementById('footer-inst').innerText = instGlobal.nombre;
            
            const color = instGlobal.color_primario || '#4f46e5';
            document.documentElement.style.setProperty('--primary-color', color);
            document.getElementById('hero-accent').style.color = color;
            document.getElementById('chat-header').style.backgroundColor = color;
            if(document.getElementById('btn-submit')) document.getElementById('btn-submit').style.backgroundColor = color;
            
            if (instGlobal.logo_url) {
                const logo = document.getElementById('logo-inst');
                logo.src = instGlobal.logo_url;
                document.getElementById('logo-container').classList.remove('hidden');
            }
        }

        async function cargarContenido(instId) {
            console.log("üîç Buscando √Åreas para Instituci√≥n UUID:", instId);

            // SINCRO TOTAL: Buscamos √°reas usando ambos idiomas de columna
            const { data: areas, error } = await db.from('areas')
                .select('*, cursos_oficiales(*)')
                .or(`institution_id.eq.${instId},institucion_id.eq.${instId}`)
                .order('orden', { ascending: true });

            const container = document.getElementById('areas-container');
            container.innerHTML = ""; // Limpiar loader

            if (error) {
                console.error("‚ùå Error Supabase al cargar √°reas:", error);
                container.innerHTML = "<p class='text-center py-20'>Error al conectar con la base de datos.</p>";
                return;
            }

            console.log("üì¶ Datos recibidos (√Åreas):", areas);

            if (!areas || areas.length === 0) {
                console.warn("‚ö†Ô∏è No hay √°reas asignadas a este ID en la tabla 'areas'.");
                container.innerHTML = `
                    <div class="text-center py-20 bg-white rounded-3xl border border-dashed border-slate-200">
                        <p class="text-slate-400 font-bold uppercase tracking-widest text-xs mb-4">No hay √°reas configuradas en el Admin.</p>
                        <div class="text-[10px] font-mono text-slate-300">ID Consultada: ${instId}</div>
                    </div>
                `;
                return;
            }

            areas.forEach(area => {
                // Sincronizaci√≥n: El portal solo dibuja el √°rea si tiene cursos adentro
                if (area.cursos_oficiales && area.cursos_oficiales.length > 0) {
                    const section = document.createElement('div');
                    section.className = "fade-in";
                    section.innerHTML = `
                        <div class="flex items-center gap-4 mb-8">
                            <h3 class="text-2xl font-black text-slate-900 uppercase tracking-tighter">${area.nombre}</h3>
                            <div class="h-1 flex-1 bg-slate-100 rounded-full relative">
                                <div class="absolute inset-0 w-24 rounded-full" style="background-color: var(--primary-color)"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            ${area.cursos_oficiales.map(c => `
                                <div class="bg-white rounded-2xl border border-slate-200 p-6 hover-lift flex flex-col h-full shadow-sm">
                                    <h4 class="text-lg font-bold text-slate-900 mb-2 uppercase tracking-tight">${c.nombre}</h4>
                                    <p class="text-[11px] text-slate-500 line-clamp-3 mb-6">${c.descripcion || 'Sin descripci√≥n disponible.'}</p>
                                    <div class="mt-auto flex justify-between items-center pt-4 border-t border-slate-50">
                                        <span class="text-[9px] font-black text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded tracking-widest">OFICIAL</span>
                                        <a href="portal.html?id=${c.id}" class="text-xs font-black hover:underline" style="color: var(--primary-color)">VER DETALLE ‚Üí</a>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    container.appendChild(section);
                }
            });
            lucide.createIcons();
        }

        function renderVistaCurso() {
            document.getElementById('vista-curso').classList.remove('hidden');
            document.getElementById('det-titulo').innerText = cursoGlobal.nombre;
            document.getElementById('det-desc').innerText = cursoGlobal.descripcion || "Formaci√≥n profesional con amplia salida laboral y certificaci√≥n oficial.";
            
            const temario = document.getElementById('temario-accordion');
            temario.innerHTML = "";
            if (cursoGlobal.contenido && Array.isArray(cursoGlobal.contenido)) {
                cursoGlobal.contenido.forEach((mod, i) => {
                    temario.innerHTML += `
                        <div class="p-4 bg-slate-50 rounded-xl border border-slate-100 text-[11px] font-bold text-slate-700 flex justify-between">
                            <span>M√ìDULO ${i+1}: ${mod.titulo.toUpperCase()}</span>
                            <i data-lucide="chevron-right" class="w-3 h-3 text-slate-300"></i>
                        </div>
                    `;
                });
            }
            lucide.createIcons();
        }

        function renderHomeInstituto() {
            document.getElementById('hero-title').innerHTML = `Formaci√≥n Oficial en <br><span class="text-indigo-600 italic">${instGlobal.nombre}</span>`;
            document.getElementById('hero-desc').innerText = `Explora nuestro cat√°logo acad√©mico y comienza hoy tu transformaci√≥n profesional.`;
        }

        // --- GESTI√ìN DE LEADS (Sincronizado con CRM) ---
        document.getElementById('form-lead')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            const originalText = btn.innerText;
            btn.innerText = "PROCESANDO...";
            btn.disabled = true;

            const f = new FormData(e.target);
            const data = {
                nombre: f.get('nombre'),
                email: f.get('email'),
                telefono: f.get('telefono'),
                curso_interes: cursoGlobal?.nombre || 'Consulta General',
                institution_id: instGlobal.id,
                fuente: 'Portal SaaS',
                estado: 'nuevo'
            };

            const { error } = await db.from('leads').insert([data]);

            if (!error) {
                btn.innerText = "¬°SOLICITUD ENVIADA!";
                btn.style.backgroundColor = "#10b981";
                const wppNum = instGlobal.telefono_contacto?.replace(/\D/g, '');
                const msg = encodeURIComponent(`Hola, acabo de registrarme en el portal de ${instGlobal.nombre} para el curso ${cursoGlobal?.nombre || 'General'}. Mi nombre es ${data.nombre}.`);
                if(wppNum) setTimeout(() => window.open(`https://wa.me/${wppNum}?text=${msg}`, '_blank'), 1500);
            } else {
                alert("Error: " + error.message);
                btn.innerText = originalText;
                btn.disabled = false;
            }
        });

        // --- CHATBOT ---
        function toggleChat() {
            const w = document.getElementById('chat-widget');
            w.classList.toggle('chat-closed');
            w.classList.toggle('chat-open');
        }

        async function enviarPregunta(e) {
            e.preventDefault();
            const inp = document.getElementById('chat-input');
            const val = inp.value.trim();
            if (!val) return;

            addMsg(val, 'user');
            inp.value = "";
            const loadId = addMsg('...', 'bot');

            try {
                const { data: s } = await db.from('app_secrets').select('value').eq('name', 'gemini_api_key').single();
                const p = `Eres Don B√∫ho de ${instGlobal.nombre}. Responde brevemente sobre ${cursoGlobal ? cursoGlobal.nombre : 'nuestra oferta'}. Usuario: ${val}`;
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${s.value}`, {
                    method: 'POST', body: JSON.stringify({ contents: [{ parts: [{ text: p }] }] })
                });
                const j = await r.json();
                document.getElementById(loadId).remove();
                addMsg(marked.parse(j.candidates[0].content.parts[0].text), 'bot');
            } catch {
                document.getElementById(loadId).remove();
                addMsg("Hola, ¬øen qu√© puedo ayudarte con nuestros cursos?", 'bot');
            }
        }

        function addMsg(h, s) {
            const id = 'm-' + Date.now();
            const c = document.getElementById('chat-messages');
            const d = document.createElement('div');
            d.id = id;
            d.className = s === 'user' ? 'flex justify-end' : 'flex justify-start';
            d.innerHTML = `<div class="${s === 'user' ? 'bg-indigo-600 text-white' : 'bg-white border text-slate-700'} p-3 rounded-2xl max-w-[85%] shadow-sm">${h}</div>`;
            c.appendChild(d);
            c.scrollTop = c.scrollHeight;
            return id;
        }
    </script>
</body>
</html>
