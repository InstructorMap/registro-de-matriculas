<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Descarga de Credencial Oficial</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- RESET Y BASES --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Roboto', sans-serif;
            background: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
            gap: 20px;
        }

        /* --- CONTENEDOR DE LA TARJETA (ISO ID-1 Standard) --- */
        :root {
            --card-width: 1011px;  /* Ancho real alta calidad */
            --card-height: 638px;  /* Alto real alta calidad */
            --blue-colbert: #0033cc;
        }

        /* Wrapper para visualizar en pantalla (escala reducida) */
        .preview-wrapper {
            transform: scale(0.4); 
            transform-origin: top center;
            margin-bottom: -350px; 
        }
        
        @media (max-width: 600px) {
            .preview-wrapper { transform: scale(0.28); margin-bottom: -450px; }
        }

        .card {
            width: var(--card-width);
            height: var(--card-height);
            background: white;
            display: flex;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            margin-bottom: 50px;
        }

        /* --- FRENTE --- */
        .front-left {
            width: 360px;
            height: 100%;
            position: relative;
            background: #e0e0e0;
        }
        
        .student-photo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Tri√°ngulo en esquina */
        .triangle-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 200px 0 0 200px;
            border-color: transparent transparent transparent var(--blue-colbert);
            z-index: 2;
        }

        /* Texto Sigla en el Tri√°ngulo */
        .reg-sigla {
            position: absolute;
            bottom: 15px;
            left: 5px;
            width: 180px; /* Ancho para centrar texto */
            text-align: center;
            color: white;
            font-size: 24px; /* Ajustado para que entre R.E.M.A.E.P */
            font-weight: 900;
            z-index: 3;
            transform: rotate(-45deg); /* Rotaci√≥n para seguir la diagonal */
            transform-origin: bottom left;
            margin-bottom: 35px; /* Ajuste fino de posici√≥n */
        }

        .front-right {
            flex: 1;
            background: var(--blue-colbert);
            color: white;
            padding: 25px 40px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .header {
            border-bottom: 4px solid white;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-text {
            font-size: 55px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .course-title {
            font-size: 52px;
            font-weight: 900;
            line-height: 1;
            text-transform: uppercase;
            margin: 20px 0;
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .student-name {
            font-size: 32px;
            font-weight: 700;
            text-transform: uppercase;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            text-align: center;
            letter-spacing: 1px;
            white-space: nowrap; 
        }

        .data-grid { margin-top: 20px; }

        .data-row {
            display: flex;
            align-items: center;
            border-top: 2px solid rgba(255,255,255,0.5);
            padding-top: 10px;
            margin-top: 10px;
            font-size: 40px;
            font-weight: 700;
        }

        .icon-box {
            font-size: 50px;
            width: 70px;
            text-align: center;
            margin-right: 20px;
        }

        .data-content {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }
        
        /* QR en el FRENTE (Nuevo) */
        .qr-front {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 120px;
            height: 120px;
            background: white;
            padding: 5px;
            border-radius: 5px;
        }
        .qr-front img { width: 100%; height: 100%; }

        /* Ajuste para que la fecha no choque con el QR */
        .vence-row .data-content {
            width: 75%; /* Dejar espacio al QR */
        }

        /* --- DORSO --- */
        .card-back {
            background: white;
            /* Aqu√≠ puedes poner tu imagen de fondo real si la tienes: 
               background-image: url('fondo_marcadeagua.jpg'); */
            background-image: radial-gradient(#ccc 2px, transparent 2px); 
            background-size: 30px 30px;
            padding: 40px;
            flex-direction: column;
        }

        .legal-text {
            color: var(--blue-colbert);
            font-size: 28px;
            font-weight: 900;
            text-align: center;
            text-transform: uppercase;
            margin-bottom: 40px;
        }

        .signatures-area {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .sig-block { text-align: center; width: 22%; position: relative; }
        
        /* Espacio para imagen de firma */
        .sig-img-placeholder {
            height: 60px;
            margin-bottom: -10px;
            display: block;
            margin: 0 auto;
        }

        .sig-line {
            width: 100%; height: 2px; background: #000; margin-bottom: 10px; margin-top: 5px;
        }
        .sig-name { font-size: 14px; font-weight: bold; color: #000; }
        .sig-role { font-size: 12px; color: #555; }

        /* √Årea de Logos Inferior (Sin QR) */
        .logos-area {
            display: flex;
            align-items: center;
            justify-content: space-between; /* Separar logos a los extremos */
            padding: 0 50px;
            margin-top: auto;
            height: 180px;
        }
        
        /* C√≠rculos para Logos/Sellos */
        .logo-circle {
            width: 160px; height: 160px;
            border-radius: 50%;
            /* border: 2px solid #ccc;  Quitar borde si usas imagen real */
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }
        .logo-circle img { width: 100%; height: 100%; object-fit: contain; }

        .footer-logos {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            border-top: 2px solid #eee;
            padding-top: 10px;
        }
        .footer-logo-img { height: 60px; }

        /* --- UI CONTROLS --- */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            position: sticky;
            top: 20px;
            z-index: 100;
            width: 90%;
            max-width: 600px;
        }
        .btn-action {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: transform 0.1s;
        }
        .btn-upload { background: #e0e0e0; color: #333; }
        .btn-download { background: #00c853; color: white; }
        .btn-download:hover { background: #00b34a; transform: scale(1.05); }

    </style>
</head>
<body>

    <div class="controls">
        <h2 style="margin-bottom:10px;">Panel del Alumno</h2>
        <p style="font-size:14px; color:#666; margin-bottom:15px;">1. Sube tu foto. 2. Descarga ambas im√°genes.</p>
        
        <input type="file" id="input-foto" accept="image/*" style="display:none;" onchange="cargarFoto()">
        <button class="btn-action btn-upload" onclick="document.getElementById('input-foto').click()">üì∏ SUBIR FOTO</button>
        <br>
        <button class="btn-action btn-download" onclick="descargarJPG('card-front', 'Credencial_Frente')">‚¨áÔ∏è DESCARGAR FRENTE</button>
        <button class="btn-action btn-download" onclick="descargarJPG('card-back', 'Credencial_Dorso')">‚¨áÔ∏è DESCARGAR DORSO</button>
    </div>

    <div class="preview-wrapper">
        <div class="card" id="card-front">
            <div class="front-left">
                <img id="img-foto" class="student-photo" src="" style="display:none;">
                <div style="position:absolute; top:40%; width:100%; text-align:center; color:#777; font-weight:bold;" id="placeholder-foto">SIN FOTO</div>
                
                <div class="triangle-overlay"></div>
                <div class="reg-sigla" id="txt-sigla">REGISTRO</div>
            </div>
            
            <div class="front-right" id="bg-panel">
                <div class="header">
                    <span class="header-text">CARNET</span>
                    <span class="header-text" id="txt-anio">2026</span>
                </div>

                <div class="course-title" id="txt-titulo">PARAM√âDICO PROFESIONAL</div>
                <div class="student-name" id="txt-nombre">NOMBRE DEL ALUMNO</div>

                <div class="data-grid">
                    <div class="data-row">
                        <div class="icon-box">‚ú±</div> 
                        <div class="data-content">
                            <span>CI:</span>
                            <span id="txt-dni">---</span>
                        </div>
                    </div>
                    <div class="data-row" style="border:none; margin-top:0;">
                        <div class="icon-box"></div>
                        <div class="data-content">
                            <span>MATR√çCULA:</span>
                            <span id="txt-matricula">---</span>
                        </div>
                    </div>
                    <div class="data-row vence-row">
                        <div class="icon-box">üö®</div>
                        <div class="data-content">
                            <span>VENCE:</span>
                            <span id="txt-vence">---</span>
                        </div>
                    </div>
                </div>

                <div class="qr-front">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=Validado" alt="QR">
                </div>
            </div>
        </div>

        <div class="card card-back" id="card-back">
            <div class="legal-text">EL PRESENTE CARNET ES UNA DECLARACI√ìN JURADA</div>

            <div class="signatures-area">
                <div class="sig-block">
                    <div style="height:50px;"></div> <div class="sig-line"></div>
                    <div class="sig-name">Aldo M. Joseph</div>
                    <div class="sig-role">PRESIDENTE A.A.P.S</div>
                </div>
                 <div class="sig-block">
                    <div style="height:50px;"></div>
                    <div class="sig-line"></div>
                    <div class="sig-name">Pablo Verducchio</div>
                    <div class="sig-role">DIR. GRUPO COLBERT</div>
                </div>
                 <div class="sig-block">
                    <div style="height:50px;"></div>
                    <div class="sig-line"></div>
                    <div class="sig-name">Ivana Santacroce</div>
                    <div class="sig-role">SEC. ACAD√âMICA</div>
                </div>
                 <div class="sig-block">
                    <div style="height:50px;"></div>
                    <div class="sig-line"></div>
                    <div class="sig-name">Miguel A. Ruff</div>
                    <div class="sig-role">DIRECTOR</div>
                </div>
            </div>

            <div class="logos-area">
                <div class="logo-circle">
                    <img src="https://via.placeholder.com/150?text=LOGO+AAPS" alt="Sello AAPS">
                </div>
                
                <div class="logo-circle">
                     <img src="https://via.placeholder.com/150?text=LOGO+COLBERT" alt="Sello Colbert">
                </div>
            </div>

            <div class="footer-logos">
                <img src="https://via.placeholder.com/300x80?text=LOGO+AAPS+HORIZONTAL" class="footer-logo-img">
                <img src="https://via.placeholder.com/300x80?text=INSTITUTO+COLBERT" class="footer-logo-img">
            </div>
        </div>
    </div>

    <script>
        // 1. CARGA DE DATOS (TOKEN)
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');

            if (token) {
                try {
                    const datos = JSON.parse(atob(token));
                    
                    document.getElementById('txt-titulo').innerText = datos.tit;
                    document.getElementById('txt-nombre').innerText = datos.nom;
                    document.getElementById('txt-dni').innerText = datos.dni;
                    document.getElementById('txt-matricula').innerText = datos.mat;
                    document.getElementById('txt-anio').innerText = datos.anio;
                    
                    if(datos.ven) {
                        const parts = datos.ven.split('-');
                        document.getElementById('txt-vence').innerText = `${parts[2]}/${parts[1]}/${parts[0]}`;
                    }

                    // Colores y Siglas
                    const panel = document.getElementById('bg-panel');
                    const sigla = document.getElementById('txt-sigla');
                    const triangulo = document.querySelector('.triangle-overlay');
                    let color = '#0033cc'; 
                    let textoSigla = 'R.E.M.A.E.P'; // Default

                    // Mapeo de siglas completas seg√∫n selecci√≥n
                    if(datos.reg.includes('remaep')) { color = '#0033cc'; textoSigla = 'R.E.M.A.E.P'; }
                    if(datos.reg.includes('rniue'))  { color = '#b8860b'; textoSigla = 'R.N.I.U.E'; }
                    if(datos.reg.includes('rubra'))  { color = '#cc0000'; textoSigla = 'R.U.B.R.A'; }
                    if(datos.reg.includes('rmts'))   { color = '#2f4f4f'; textoSigla = 'R.M.T.S'; }
                    if(datos.reg.includes('rce'))    { color = '#ffcc00'; textoSigla = 'R.C.E'; panel.style.color = 'black'; }
                    if(datos.reg.includes('rpde'))   { color = '#0099ff'; textoSigla = 'R.P.D.E'; }

                    panel.style.backgroundColor = color;
                    triangulo.style.borderBottomColor = color; 
                    
                    // Ajuste din√°mico de tama√±o de fuente si la sigla es muy larga
                    sigla.innerText = textoSigla;
                    if(textoSigla.length > 8) {
                        sigla.style.fontSize = "22px"; 
                    } else {
                        sigla.style.fontSize = "36px";
                    }

                } catch (e) {
                    console.log("Error leyendo token", e);
                }
            }
        });

        // 2. CARGAR FOTO
        function cargarFoto() {
            const input = document.getElementById('input-foto');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('img-foto');
                    img.src = e.target.result;
                    img.style.display = 'block';
                    document.getElementById('placeholder-foto').style.display = 'none';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // 3. DESCARGAR JPG (M√âTODO CLONADO PARA EVITAR ERRORES DE ESCALA)
        function descargarJPG(elementId, fileName) {
            const originalElement = document.getElementById(elementId);
            
            // Clonar nodo para manipularlo fuera de pantalla
            const clone = originalElement.cloneNode(true);
            
            // Forzar estilos al clon para que sea perfecto
            clone.style.transform = "none";
            clone.style.position = "fixed";
            clone.style.top = "-9999px";
            clone.style.left = "0";
            clone.style.width = "1011px";
            clone.style.height = "638px";
            clone.style.margin = "0";
            clone.style.borderRadius = "0";
            
            // Recuperar imagen en el clon
            const originalImg = originalElement.querySelector('img.student-photo');
            const cloneImg = clone.querySelector('img.student-photo');
            if(originalImg.src && originalImg.style.display !== 'none') {
                cloneImg.src = originalImg.src;
                cloneImg.style.display = 'block';
            }

            document.body.appendChild(clone);

            html2canvas(clone, {
                scale: 2, // Alta calidad
                useCORS: true,
                width: 1011,
                height: 638,
                windowWidth: 1011,
                windowHeight: 638,
                backgroundColor: "#ffffff"
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `${fileName}.jpg`;
                link.href = canvas.toDataURL("image/jpeg", 0.95);
                link.click();
                document.body.removeChild(clone);
            }).catch(err => {
                console.error("Error:", err);
                document.body.removeChild(clone);
            });
        }
    </script>
</body>
</html>
