<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validaci√≥n y Descarga de Credencial</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* ESTILOS DEL CARNET (Id√©nticos a la V3) */
        :root {
            --width: 500px; --height: 315px; --font-main: 'Roboto', sans-serif;
            --col-remaep: #0033cc; --col-rniue: #b8860b; --col-rubra: #cc0000;
            --col-rmts: #2f4f4f; --col-rce: #ffcc00; --col-rpde: #0099ff;
        }
        .tema-remaep { --bg-color: var(--col-remaep); --txt-color: white; --accent: rgba(255,255,255,0.2); }
        .tema-rniue  { --bg-color: var(--col-rniue);  --txt-color: white; --accent: rgba(255,255,255,0.2); }
        .tema-rubra  { --bg-color: var(--col-rubra);  --txt-color: white; --accent: rgba(255,255,255,0.2); }
        .tema-rmts   { --bg-color: var(--col-rmts);   --txt-color: white; --accent: rgba(255,255,255,0.1); }
        .tema-rpde   { --bg-color: var(--col-rpde);   --txt-color: white; --accent: rgba(255,255,255,0.2); }
        .tema-rce    { --bg-color: var(--col-rce);    --txt-color: black; --accent: rgba(0,0,0,0.1); }

        body { font-family: var(--font-main); background: #f4f4f4; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        
        .instrucciones { max-width: 600px; text-align: center; margin-bottom: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .upload-btn-wrapper { margin: 15px 0; }
        .btn { border: 2px solid gray; color: gray; background-color: white; padding: 8px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-download { background-color: #0099ff; color: white; border: none; font-size: 18px; padding: 15px 30px; margin-top: 20px; width: 100%; max-width: 500px; }
        input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; }

        /* CARNET CONTAINER */
        .card-container { width: var(--width); height: var(--height); background: white; border-radius: 10px; overflow: hidden; position: relative; box-shadow: 0 10px 20px rgba(0,0,0,0.3); display: flex; margin: 0 auto; }
        .card-front { display: flex; width: 100%; height: 100%; }
        .photo-area { width: 35%; background: #ddd; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .photo-placeholder { position: absolute; text-align: center; color: #555; font-size: 12px; pointer-events: none; }
        .photo-area img { width: 100%; height: 100%; object-fit: cover; display: none; } /* Oculto hasta que suban foto */
        
        .triangle-decor { position: absolute; bottom: 0; left: 0; width: 0; height: 0; border-style: solid; border-width: 80px 0 0 80px; border-color: transparent transparent transparent var(--bg-color); z-index: 2; }
        .registry-sigla { position: absolute; bottom: 5px; left: 5px; color: var(--txt-color); font-weight: 900; font-size: 14px; z-index: 3; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }

        .data-area { width: 65%; background-color: var(--bg-color); color: var(--txt-color); padding: 12px 15px; display: flex; flex-direction: column; background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.03) 10px, rgba(255,255,255,0.03) 20px); }
        .header-year { border-bottom: 2px solid var(--txt-color); display: flex; justify-content: space-between; font-weight: 900; font-size: 18px; padding-bottom: 4px; margin-bottom: 8px; }
        .course-title { font-size: 18px; font-weight: 900; text-transform: uppercase; line-height: 1.1; margin-bottom: 8px; min-height: 44px; display: flex; align-items: center; justify-content: center; text-align: center; }
        .student-name-box { background: var(--accent); padding: 4px 6px; margin-bottom: 8px; border-radius: 4px; }
        .student-name { font-size: 13px; font-weight: 700; text-transform: uppercase; display: block; text-align: justify; text-align-last: justify; width: 100%; }
        .tech-data { font-size: 14px; font-weight: 700; }
        .data-row { display: flex; align-items: center; margin-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 2px; }
        .tema-rce .data-row { border-bottom: 1px solid rgba(0,0,0,0.2); }
        .icon-col { width: 25px; font-size: 18px; text-align: center; }
        .info-col { flex-grow: 1; display: flex; justify-content: space-between; padding-left: 5px; }
        .qr-front-container { position: absolute; bottom: 10px; right: 10px; width: 60px; height: 60px; background: white; padding: 2px; border-radius: 4px; }
        .qr-front-container img { width: 100%; height: 100%; }
        .expiration-row { margin-top: auto; width: 65%; }

        @media print {
            .instrucciones, .btn-download, .no-print { display: none !important; }
            body { background: white; padding: 0; }
            .card-container { box-shadow: none; border: 1px solid #ccc; page-break-inside: avoid; margin: 0; }
        }
    </style>
</head>
<body>

    <div class="instrucciones">
        <h2>Hola, <span id="welcome-name">Alumno</span></h2>
        <p>Tus datos han sido precargados y validados por la instituci√≥n.</p>
        <p><strong>Paso 1:</strong> Haz clic en el recuadro gris para subir tu foto carnet.</p>
        <p><strong>Paso 2:</strong> Verifica que la foto se vea bien.</p>
        <p><strong>Paso 3:</strong> Presiona "Descargar Credencial".</p>
        
        <div class="upload-btn-wrapper">
             <input type="file" id="input-foto" accept="image/*" onchange="previewImage()">
        </div>
    </div>

    <div class="card-container" id="carnet-front">
        <div class="card-front">
            <div class="photo-area" onclick="document.getElementById('input-foto').click()">
                <div class="photo-placeholder" id="placeholder-txt">CLICK AQU√ç PARA<br>SUBIR FOTO</div>
                <img id="card-img" src="" alt="Foto">
                <div class="triangle-decor"></div>
                <div class="registry-sigla" id="card-sigla">REG</div>
            </div>

            <div class="data-area">
                <div class="header-year">
                    <span>CARNET</span>
                    <span id="card-anio">----</span>
                </div>
                <div class="course-title" id="card-titulo">CARGANDO...</div>
                <div class="student-name-box">
                    <span class="student-name" id="card-nombre">---</span>
                </div>
                <div class="tech-data">
                    <div class="data-row">
                        <div class="icon-col">‚ú±</div>
                        <div class="info-col">
                            <span>CI/DNI:</span>
                            <span id="card-dni">---</span>
                        </div>
                    </div>
                    <div class="data-row">
                        <div class="icon-col">#</div>
                        <div class="info-col">
                            <span>MATR√çCULA:</span>
                            <span id="card-matricula">---</span>
                        </div>
                    </div>
                    <div class="data-row expiration-row" style="border:none;">
                        <div class="icon-col">üö®</div>
                        <div class="info-col">
                            <span>VENCE:</span>
                            <span id="card-vence">---</span>
                        </div>
                    </div>
                </div>
                <div class="qr-front-container">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=ValidadoOficial" alt="QR">
                </div>
            </div>
        </div>
    </div>

    <button class="btn-download" onclick="imprimir()">üì• DESCARGAR / IMPRIMIR PDF</button>

    <script>
        // AL CARGAR LA P√ÅGINA: LEER EL TOKEN DE LA URL
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');

            if (!token) {
                document.body.innerHTML = "<h1 style='text-align:center; color:red; margin-top:50px;'>ACCESO DENEGADO<br>Enlace inv√°lido o corrupto.</h1>";
                return;
            }

            try {
                // Decodificar Base64 -> JSON
                const jsonString = atob(token);
                const datos = JSON.parse(jsonString);

                // Inyectar Datos (SIN POSIBILIDAD DE EDICI√ìN)
                document.getElementById('welcome-name').innerText = datos.nom.split(' ')[0]; // Solo primer nombre
                
                // Aplicar Tema
                const card = document.getElementById('carnet-front');
                card.classList.add(datos.reg);
                
                // Sigla
                let sigla = "REG";
                if(datos.reg.includes('remaep')) sigla = "R.E.M.A.E.P";
                else if(datos.reg.includes('rniue')) sigla = "R.N.I.U.E";
                else if(datos.reg.includes('rubra')) sigla = "R.U.B.R.A";
                else if(datos.reg.includes('rmts')) sigla = "R.M.T.S";
                else if(datos.reg.includes('rce')) sigla = "R.C.E";
                else if(datos.reg.includes('rpde')) sigla = "R.P.D.E";
                document.getElementById('card-sigla').innerText = sigla;

                // Textos
                document.getElementById('card-titulo').innerText = datos.tit;
                document.getElementById('card-anio').innerText = datos.anio;
                document.getElementById('card-nombre').innerText = datos.nom;
                document.getElementById('card-dni').innerText = datos.dni;
                document.getElementById('card-matricula').innerText = datos.mat;
                
                // Formato Fecha
                if(datos.ven) {
                    const parts = datos.ven.split('-');
                    document.getElementById('card-vence').innerText = `${parts[2]}/${parts[1]}/${parts[0]}`;
                }

            } catch (e) {
                console.error(e);
                document.body.innerHTML = "<h1 style='text-align:center; color:red;'>ERROR DE VALIDACI√ìN<br>El enlace est√° da√±ado. Contacte administraci√≥n.</h1>";
            }
        });

        // MANEJO DE FOTO
        function previewImage() {
            const file = document.getElementById('input-foto').files[0];
            const preview = document.getElementById('card-img');
            const placeholder = document.getElementById('placeholder-txt');
            const reader = new FileReader();

            reader.addEventListener("load", function () {
                preview.src = reader.result;
                preview.style.display = "block";
                placeholder.style.display = "none";
            }, false);

            if (file) {
                reader.readAsDataURL(file);
            }
        }

        // IMPRIMIR
        function imprimir() {
            const img = document.getElementById('card-img');
            // Validar si subi√≥ foto
            if(window.getComputedStyle(img).display === 'none') {
                alert("‚ö†Ô∏è POR FAVOR, SUBE TU FOTO ANTES DE DESCARGAR.");
                return;
            }
            window.print();
        }
    </script>
</body>
</html>
