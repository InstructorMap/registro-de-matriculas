<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Descarga de Credencial Oficial</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- RESET Y BASES --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Roboto', sans-serif;
            background: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
            gap: 20px;
        }

        /* --- CONTENEDOR DE LA TARJETA (ISO ID-1 Standard) --- */
        /* Dimensiones exactas en pixeles para alta calidad (aprox 300dpi scale) */
        :root {
            --card-width: 1011px;  /* 85.6mm x 300dpi */
            --card-height: 638px;  /* 53.98mm x 300dpi */
            --blue-colbert: #0033cc;
        }

        /* Wrapper para escalar la vista en pantallas chicas sin romper el dise√±o real */
        .preview-wrapper {
            transform: scale(0.4); /* Achicar para ver en monitor */
            transform-origin: top center;
            margin-bottom: -350px; /* Compensar espacio vac√≠o por el scale */
        }
        
        @media (max-width: 600px) {
            .preview-wrapper { transform: scale(0.28); margin-bottom: -450px; }
        }

        .card {
            width: var(--card-width);
            height: var(--card-height);
            background: white;
            display: flex;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            margin-bottom: 50px; /* Espacio entre frente y dorso */
        }

        /* --- FRENTE --- */
        /* Zona Foto (Izquierda - 35%) */
        .front-left {
            width: 360px;
            height: 100%;
            position: relative;
            background: #e0e0e0;
        }
        
        .student-photo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Tri√°ngulo Azul en esquina */
        .triangle-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 200px 0 0 200px; /* Tri√°ngulo grande */
            border-color: transparent transparent transparent var(--blue-colbert);
            z-index: 2;
        }

        .reg-sigla {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: white;
            font-size: 50px;
            font-weight: 900;
            z-index: 3;
            font-family: Arial, sans-serif; /* Similar al original */
        }

        /* Zona Datos (Derecha - Resto) */
        .front-right {
            flex: 1;
            background: var(--blue-colbert);
            color: white;
            padding: 25px 40px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .header {
            border-bottom: 4px solid white;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-text {
            font-size: 55px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .course-title {
            font-size: 52px;
            font-weight: 900;
            line-height: 1;
            text-transform: uppercase;
            margin: 20px 0;
            /* Evitar que se rompa feo */
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .student-name {
            font-size: 32px;
            font-weight: 700;
            text-transform: uppercase;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            text-align: center;
            letter-spacing: 1px;
            white-space: nowrap; /* Fuerza 1 linea */
        }

        .data-grid {
            margin-top: 20px;
        }

        .data-row {
            display: flex;
            align-items: center;
            border-top: 2px solid rgba(255,255,255,0.5);
            padding-top: 10px;
            margin-top: 10px;
            font-size: 40px;
            font-weight: 700;
        }

        .icon-box {
            font-size: 50px;
            width: 70px;
            text-align: center;
            margin-right: 20px;
        }

        .data-content {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }

        /* --- DORSO --- */
        .card-back {
            background: white;
            background-image: radial-gradient(#ccc 2px, transparent 2px); /* Trama de seguridad */
            background-size: 30px 30px;
            padding: 40px;
            flex-direction: column;
        }

        .legal-text {
            color: var(--blue-colbert);
            font-size: 28px;
            font-weight: 900;
            text-align: center;
            text-transform: uppercase;
            margin-bottom: 40px;
        }

        .signatures-area {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .sig-block {
            text-align: center;
            width: 22%;
        }
        .sig-line {
            width: 100%;
            height: 2px;
            background: #000;
            margin-bottom: 10px;
        }
        .sig-name { font-size: 14px; font-weight: bold; color: #000; }
        .sig-role { font-size: 12px; color: #555; }

        .logos-area {
            display: flex;
            align-items: center;
            justify-content: space-around;
            margin-top: auto;
        }
        .logo-placeholder {
            width: 150px; height: 150px;
            background: #eee;
            border-radius: 50%;
            border: 2px solid #999;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; color: #555;
            text-align: center;
        }
        .qr-area {
            width: 180px; height: 180px;
            border: 4px solid black;
            padding: 5px;
            background: white;
        }
        .qr-area img { width: 100%; height: 100%; }

        /* --- UI CONTROLS --- */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            position: sticky;
            top: 20px;
            z-index: 100;
            width: 90%;
            max-width: 600px;
        }
        .btn-action {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: transform 0.1s;
        }
        .btn-upload { background: #e0e0e0; color: #333; }
        .btn-download { background: #00c853; color: white; }
        .btn-download:hover { background: #00b34a; transform: scale(1.05); }

    </style>
</head>
<body>

    <div class="controls">
        <h2 style="margin-bottom:10px;">Panel del Alumno</h2>
        <p style="font-size:14px; color:#666; margin-bottom:15px;">1. Sube tu foto. 2. Descarga ambas im√°genes.</p>
        
        <input type="file" id="input-foto" accept="image/*" style="display:none;" onchange="cargarFoto()">
        <button class="btn-action btn-upload" onclick="document.getElementById('input-foto').click()">üì∏ SUBIR FOTO</button>
        <br>
        <button class="btn-action btn-download" onclick="descargarJPG('card-front', 'Credencial_Frente')">‚¨áÔ∏è DESCARGAR FRENTE</button>
        <button class="btn-action btn-download" onclick="descargarJPG('card-back', 'Credencial_Dorso')">‚¨áÔ∏è DESCARGAR DORSO</button>
    </div>

    <div class="preview-wrapper">
        <div class="card" id="card-front">
            <div class="front-left">
                <img id="img-foto" class="student-photo" src="" style="display:none;">
                <div style="position:absolute; top:40%; width:100%; text-align:center; color:#777; font-weight:bold;" id="placeholder-foto">SIN FOTO</div>
                
                <div class="triangle-overlay"></div>
                <div class="reg-sigla" id="txt-sigla">IC</div>
            </div>
            
            <div class="front-right" id="bg-panel">
                <div class="header">
                    <span class="header-text">CARNET</span>
                    <span class="header-text" id="txt-anio">2026</span>
                </div>

                <div class="course-title" id="txt-titulo">PARAM√âDICO PROFESIONAL</div>
                <div class="student-name" id="txt-nombre">SOLIZ PADILLA JOS√â OSCAR</div>

                <div class="data-grid">
                    <div class="data-row">
                        <div class="icon-box">‚ú±</div> <div class="data-content">
                            <span>CI:</span>
                            <span id="txt-dni">7236103</span>
                        </div>
                    </div>
                    <div class="data-row" style="border:none; margin-top:0;">
                        <div class="icon-box"></div>
                        <div class="data-content">
                            <span>MATRICULA:</span>
                            <span id="txt-matricula">6103</span>
                        </div>
                    </div>
                    <div class="data-row">
                        <div class="icon-box">üö®</div>
                        <div class="data-content">
                            <span>VENCE:</span>
                            <span id="txt-vence">30/12/2026</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card card-back" id="card-back">
            <div class="legal-text">EL PRESENTE CARNET ES UNA DECLARACI√ìN JURADA</div>

            <div class="signatures-area">
                <div class="sig-block">
                    <div class="sig-line"></div>
                    <div class="sig-name">Aldo M. Joseph</div>
                    <div class="sig-role">PRESIDENTE A.A.P.S</div>
                </div>
                 <div class="sig-block">
                    <div class="sig-line"></div>
                    <div class="sig-name">Pablo Verducchio</div>
                    <div class="sig-role">DIR. GRUPO COLBERT</div>
                </div>
                 <div class="sig-block">
                    <div class="sig-line"></div>
                    <div class="sig-name">Ivana Santacroce</div>
                    <div class="sig-role">SEC. ACAD√âMICA</div>
                </div>
                 <div class="sig-block">
                    <div class="sig-line"></div>
                    <div class="sig-name">Miguel A. Ruff</div>
                    <div class="sig-role">DIRECTOR</div>
                </div>
            </div>

            <div class="logos-area">
                <div class="logo-placeholder">LOGO<br>AAPS</div>
                <div class="qr-area">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=Validado" alt="QR">
                </div>
                <div class="logo-placeholder">LOGO<br>COLBERT</div>
            </div>
        </div>
    </div>

    <script>
        // 1. CARGA DE DATOS (TOKEN)
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');

            if (token) {
                try {
                    const datos = JSON.parse(atob(token));
                    
                    document.getElementById('txt-titulo').innerText = datos.tit;
                    document.getElementById('txt-nombre').innerText = datos.nom;
                    document.getElementById('txt-dni').innerText = datos.dni;
                    document.getElementById('txt-matricula').innerText = datos.mat;
                    document.getElementById('txt-anio').innerText = datos.anio;
                    
                    // Formatear Fecha
                    if(datos.ven) {
                        const parts = datos.ven.split('-');
                        document.getElementById('txt-vence').innerText = `${parts[2]}/${parts[1]}/${parts[0]}`;
                    }

                    // Colores por Registro
                    const panel = document.getElementById('bg-panel');
                    const sigla = document.getElementById('txt-sigla');
                    const triangulo = document.querySelector('.triangle-overlay');
                    let color = '#0033cc'; // Default REMAEP
                    let textoSigla = 'IC';

                    if(datos.reg.includes('rniue')) { color = '#b8860b'; textoSigla = 'INS'; }
                    if(datos.reg.includes('rubra')) { color = '#cc0000'; textoSigla = 'BR'; }
                    if(datos.reg.includes('rmts'))  { color = '#2f4f4f'; textoSigla = 'TAC'; }
                    if(datos.reg.includes('rce'))   { color = '#ffcc00'; textoSigla = 'CH'; panel.style.color = 'black'; }
                    if(datos.reg.includes('rpde'))  { color = '#0099ff'; textoSigla = 'DEP'; }

                    panel.style.backgroundColor = color;
                    triangulo.style.borderBottomColor = color; // Fix triangulo color
                    sigla.innerText = textoSigla;

                } catch (e) {
                    console.log("Error leyendo token", e);
                }
            }
        });

        // 2. CARGAR FOTO
        function cargarFoto() {
            const input = document.getElementById('input-foto');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('img-foto');
                    img.src = e.target.result;
                    img.style.display = 'block';
                    document.getElementById('placeholder-foto').style.display = 'none';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // 3. DESCARGAR JPG (HTML2CANVAS)
        function descargarJPG(elementId, fileName) {
            const element = document.getElementById(elementId);
            
            // Usamos html2canvas para renderizar el div como imagen
            html2canvas(element, {
                scale: 1, // Ya estamos en alta resoluci√≥n (1000px ancho)
                useCORS: true // Para permitir cargar imagenes externas si es necesario
            }).then(canvas => {
                // Crear link de descarga
                const link = document.createElement('a');
                link.download = `${fileName}.jpg`;
                link.href = canvas.toDataURL("image/jpeg", 0.9); // Calidad 90%
                link.click();
            });
        }
    </script>
</body>
</html>
