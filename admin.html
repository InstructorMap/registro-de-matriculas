<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Comando - ASARI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        .btn-registro { font-weight: bold; text-transform: uppercase; margin: 5px; color: white !important; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .bg-remaep { background-color: #0033cc; border-color: #002266; }
        .bg-rniue  { background-color: #b8860b; border-color: #8a6e2f; }
        .bg-rubra  { background-color: #cc0000; border-color: #800000; }
        .bg-rmts   { background-color: #2f4f4f; border-color: #1a2f1a; }
        .bg-rce    { background-color: #ffcc00; border-color: #cc9900; color: black !important; text-shadow: none; }
        .bg-rpde   { background-color: #0099ff; border-color: #005c99; }
        .bg-asarin { background-color: #8b0000; border-color: #500000; } /* Instructor */
    </style>
</head>
<body class="bg-light">

<div class="container py-4">
    
    <div class="card shadow mb-5 border-0">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h4 class="m-0">‚öôÔ∏è 1. Configuraci√≥n de Cursos</h4>
            <span class="badge bg-secondary">Base de Datos Maestra</span>
        </div>
        <div class="card-body">
            <p class="text-muted">Haga clic en un Registro para agregar un curso nuevo a esa categor√≠a.</p>
            
            <div class="d-flex flex-wrap justify-content-center mb-4">
                <button onclick="agregarCurso('remaep')" class="btn btn-registro bg-remaep">üîµ REMAEP</button>
                <button onclick="agregarCurso('rniue')"  class="btn btn-registro bg-rniue">üü° RNIUE</button>
                <button onclick="agregarCurso('rubra')"  class="btn btn-registro bg-rubra">üî¥ RUBRA</button>
                <button onclick="agregarCurso('rmts')"   class="btn btn-registro bg-rmts">üü¢ RMTS</button>
                <button onclick="agregarCurso('rce')"    class="btn btn-registro bg-rce">‚ö†Ô∏è RCE</button>
                <button onclick="agregarCurso('rpde')"   class="btn btn-registro bg-rpde">üí† RPDE</button>
                <button onclick="agregarCurso('asarin')" class="btn btn-registro bg-asarin">üî¥ ASARIN</button>
            </div>

            <h5 class="border-bottom pb-2">üìã Cursos Activos</h5>
            <div id="lista-cursos" class="row g-2">
                <div class="text-center py-3">‚è≥ Cargando cursos...</div>
            </div>
        </div>
    </div>

    <div class="card shadow border-0">
        <div class="card-header bg-primary text-white">
            <h4 class="m-0">üéì 2. Alta de Alumno</h4>
        </div>
        <div class="card-body">
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label fw-bold">DNI (Sin puntos)</label>
                    <input type="text" id="dni" class="form-control" placeholder="Ej: 33656107">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Email</label>
                    <input type="email" id="email" class="form-control">
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Nombre</label>
                    <input type="text" id="nombre" class="form-control">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Apellido</label>
                    <input type="text" id="apellido" class="form-control">
                </div>
            </div>

            <div class="mb-3 p-3 bg-light border rounded">
                <label class="form-label fw-bold text-primary">SELECCIONAR CURSO OFICIAL</label>
                <select id="select-curso-alumno" class="form-select form-select-lg">
                    <option value="" disabled selected>-- Elija un curso de la lista --</option>
                </select>
                <div class="form-text">El color y registro se asignar√°n autom√°ticamente seg√∫n el curso elegido.</div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <label class="form-label">Estado</label>
                    <select id="estado" class="form-select">
                        <option value="ACTIVO">ACTIVO</option>
                        <option value="DEUDOR">DEUDOR</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Fecha Inicio</label>
                    <input type="date" id="fecha" class="form-control">
                </div>
            </div>

            <button onclick="guardarAlumno()" id="btnGuardar" class="btn btn-success w-100 py-3 fw-bold fs-5">üíæ MATRICULAR ALUMNO</button>
            <div id="mensaje" class="mt-3"></div>
        </div>
    </div>

</div>

<script>
    // --- CONFIGURACI√ìN ---
    const PROJECT_URL = 'https://vxggatcfrywyodovjwxj.supabase.co';
    const PUBLIC_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4Z2dhdGNmcnl3eW9kb3Zqd3hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzM5MjgsImV4cCI6MjA4MzgwOTkyOH0.RZ9jhEASO6nCV8EnzrHQBhglP4G1nik9Z5osPXysGNg';
    const db = supabase.createClient(PROJECT_URL, PUBLIC_KEY);

    // --- VARIABLES GLOBALES ---
    let cursosCache = []; // Para guardar en memoria los datos de los cursos

    // --- INICIO ---
    document.addEventListener('DOMContentLoaded', () => {
        cargarCursos();
    });

    // --- L√ìGICA DE CURSOS (SECCI√ìN A) ---
    async function agregarCurso(registroId) {
        const nombreCurso = prompt(`Ingrese el NOMBRE del curso para el registro ${registroId.toUpperCase()}:`);
        if (!nombreCurso) return;

        const { error } = await db.from('cursos_oficiales').insert([{ nombre: nombreCurso.toUpperCase(), registro_id: registroId }]);

        if (error) alert("Error al guardar curso: " + error.message);
        else cargarCursos(); // Recargar lista
    }

    async function eliminarCurso(id) {
        if(!confirm("¬øSeguro que desea eliminar este curso?")) return;
        const { error } = await db.from('cursos_oficiales').delete().eq('id', id);
        if (error) alert("Error: " + error.message);
        else cargarCursos();
    }

    async function cargarCursos() {
        const divLista = document.getElementById('lista-cursos');
        const selectAlumno = document.getElementById('select-curso-alumno');
        
        // 1. Obtener cursos de Supabase
        const { data, error } = await db.from('cursos_oficiales').select('*').order('created_at', { ascending: false });

        if (error) {
            console.error(error);
            divLista.innerHTML = '<div class="alert alert-danger">Error cargando cursos</div>';
            return;
        }

        cursosCache = data; // Guardar para usar al matricular

        // 2. Renderizar lista arriba (Configuraci√≥n)
        divLista.innerHTML = '';
        selectAlumno.innerHTML = '<option value="" disabled selected>-- Elija un curso de la lista --</option>';

        if(data.length === 0) {
            divLista.innerHTML = '<div class="text-center text-muted">No hay cursos creados. Use los botones de colores para crear uno.</div>';
        }

        data.forEach(c => {
            // A. Poner en el panel de configuraci√≥n
            const badgeClass = `bg-${c.registro_id}`;
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4';
            col.innerHTML = `
                <div class="p-2 border rounded d-flex justify-content-between align-items-center bg-white">
                    <div>
                        <span class="badge ${badgeClass} me-2">${c.registro_id.toUpperCase()}</span>
                        <strong>${c.nombre}</strong>
                    </div>
                    <button onclick="eliminarCurso('${c.id}')" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
                </div>
            `;
            divLista.appendChild(col);

            // B. Poner en el Select del Alumno
            const option = document.createElement('option');
            option.value = c.id; // El value es el ID del curso, no el nombre
            option.innerText = `${c.nombre} (${c.registro_id.toUpperCase()})`;
            selectAlumno.appendChild(option);
        });
    }

    // --- L√ìGICA DE ALUMNOS (SECCI√ìN B) ---
    async function guardarAlumno() {
        const btn = document.getElementById('btnGuardar');
        const msgDiv = document.getElementById('mensaje');
        const cursoIdSeleccionado = document.getElementById('select-curso-alumno').value;

        // Validaciones
        if (!cursoIdSeleccionado) { alert("‚ö†Ô∏è Debe seleccionar un curso de la lista."); return; }
        
        // Buscar los datos completos del curso seleccionado en memoria
        const cursoInfo = cursosCache.find(c => c.id === cursoIdSeleccionado);
        if (!cursoInfo) { alert("Error cr√≠tico: Curso no encontrado en memoria."); return; }

        btn.disabled = true; btn.innerText = "‚è≥ Guardando..."; msgDiv.innerHTML = '';

        const datos = {
            dni_alumno: document.getElementById('dni').value,
            nombre: document.getElementById('nombre').value,
            apellido: document.getElementById('apellido').value,
            email: document.getElementById('email').value,
            estado: document.getElementById('estado').value,
            fecha_inicio: document.getElementById('fecha').value || new Date().toISOString().split('T')[0],
            
            // ASIGNACI√ìN AUTOM√ÅTICA
            curso: cursoInfo.nombre,        // Guardamos el nombre visible
            registro_id: cursoInfo.registro_id // Guardamos el color/sigla asociado
        };

        if(!datos.dni_alumno || !datos.nombre || !datos.apellido) {
            msgDiv.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Datos incompletos (DNI, Nombre, Apellido).</div>';
            btn.disabled = false; btn.innerText = "üíæ MATRICULAR ALUMNO";
            return;
        }

        const { data, error } = await db.from('matriculas').insert([datos]).select();

        if (error) {
            console.error(error);
            msgDiv.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${error.message}</div>`;
        } else {
            msgDiv.innerHTML = `<div class="alert alert-success">‚úÖ Alumno matriculado en <b>${datos.curso}</b> (${datos.registro_id.toUpperCase()}).</div>`;
            // Limpiar campos b√°sicos
            document.getElementById('dni').value = '';
            document.getElementById('nombre').value = '';
            document.getElementById('apellido').value = '';
        }
        btn.disabled = false; btn.innerText = "üíæ MATRICULAR ALUMNO";
    }
</script>

</body>
</html>
