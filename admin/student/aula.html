<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aula Virtual - ASARI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Estilo para el reproductor */
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; background: black; border-radius: 12px; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        /* Scrollbar fina */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 h-screen flex flex-col overflow-hidden font-sans">

    <header class="h-16 bg-slate-950 border-b border-slate-800 flex items-center justify-between px-6 shrink-0">
        <div class="flex items-center gap-4">
            <a href="../dashboard.html" class="p-2 hover:bg-slate-800 rounded-lg transition text-slate-400 hover:text-white">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </a>
            <div>
                <h1 class="font-bold text-white text-lg leading-tight" id="course-title">Cargando curso...</h1>
                <p class="text-xs text-slate-500 font-medium uppercase tracking-wider">Aula Virtual</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <div class="hidden md:block text-right">
                <p class="text-sm font-bold text-white" id="student-name">...</p>
                <p class="text-[10px] text-green-500 font-bold uppercase">Alumno Regular</p>
            </div>
            <div class="w-9 h-9 bg-blue-600 rounded-full flex items-center justify-center font-bold text-white shadow-lg shadow-blue-900/50">
                <i data-lucide="user" class="w-4 h-4"></i>
            </div>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        
        <main class="flex-1 flex flex-col min-w-0 bg-slate-900 relative">
            
            <div class="flex-1 p-6 md:p-10 overflow-y-auto flex flex-col">
                <div class="w-full max-w-5xl mx-auto space-y-6">
                    
                    <div id="player-area" class="bg-black rounded-2xl shadow-2xl overflow-hidden border border-slate-800 relative aspect-video flex items-center justify-center">
                        <div class="text-center p-8">
                            <i data-lucide="play-circle" class="w-16 h-16 text-slate-700 mx-auto mb-4"></i>
                            <h3 class="text-xl font-bold text-slate-500">Selecciona una clase para comenzar</h3>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h2 id="current-lesson-title" class="text-2xl font-bold text-white">Bienvenido al Curso</h2>
                        <div class="flex gap-3">
                            <button id="btn-prev" class="px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm font-bold disabled:opacity-50" disabled>Anterior</button>
                            <button id="btn-next" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold shadow-lg shadow-blue-900/20 disabled:opacity-50" disabled>Siguiente Clase</button>
                        </div>
                    </div>

                </div>
            </div>
        </main>

        <aside class="w-80 bg-slate-950 border-l border-slate-800 flex flex-col shrink-0 transition-all duration-300 absolute md:relative right-0 h-full z-10" id="playlist-sidebar">
            <div class="p-4 border-b border-slate-800 bg-slate-950 sticky top-0 z-10">
                <h3 class="font-bold text-slate-300 text-sm uppercase tracking-wider">Contenido del Curso</h3>
                <div class="h-1 w-full bg-slate-800 rounded-full mt-3 overflow-hidden">
                    <div class="h-full bg-green-500 w-0" id="progress-bar"></div>
                </div>
                <p class="text-[10px] text-slate-500 mt-1 text-right">0% Completado</p>
            </div>

            <div id="modules-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                <p class="text-center text-slate-600 text-xs py-10">Cargando temario...</p>
            </div>
        </aside>

    </div>

    <script>
        const PROJECT_URL = 'https://vxggatcfrywyodovjwxj.supabase.co';
        const PUBLIC_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4Z2dhdGNmcnl3eW9kb3Zqd3hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzM5MjgsImV4cCI6MjA4MzgwOTkyOH0.RZ9jhEASO6nCV8EnzrHQBhglP4G1nik9Z5osPXysGNg';
        const db = supabase.createClient(PROJECT_URL, PUBLIC_KEY);

        let cursoData = null;
        let currentLessonIndex = -1;
        let flatLessons = []; // Array plano para botones sig/ant

        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            
            // 1. Obtener Usuario
            const { data: { session } } = await db.auth.getSession();
            if(!session) return window.location.href = '../index.html';
            
            // Cargar nombre del alumno (perfil)
            const { data: perfil } = await db.from('perfiles').select('nombre_completo').eq('id', session.user.id).single();
            if(perfil) document.getElementById('student-name').innerText = perfil.nombre_completo;

            // 2. Obtener Curso (ID desde URL)
            const params = new URLSearchParams(window.location.search);
            const cursoId = params.get('id');

            if(!cursoId) {
                alert("No se especificó un curso.");
                return window.location.href = '../dashboard.html';
            }

            await cargarCurso(cursoId);
        });

        async function cargarCurso(id) {
            // Traemos el JSON 'contenido'
            const { data, error } = await db.from('cursos_oficiales').select('*').eq('id', id).single();
            
            if(error) return alert("Error al cargar curso");
            
            cursoData = data;
            document.getElementById('course-title').innerText = data.nombre;

            // Renderizar Temario
            renderizarTemario(data.contenido);
        }

        function renderizarTemario(modulos) {
            const container = document.getElementById('modules-list');
            container.innerHTML = "";
            flatLessons = [];

            if(!modulos || !Array.isArray(modulos) || modulos.length === 0) {
                container.innerHTML = `<div class="p-4 text-center text-slate-500 text-xs">Este curso aún no tiene contenido cargado.</div>`;
                return;
            }

            modulos.forEach((mod, modIdx) => {
                // Crear HTML del Módulo
                const modHTML = document.createElement('div');
                modHTML.className = "mb-1";
                
                // Header del Módulo
                modHTML.innerHTML = `
                    <button class="w-full text-left px-3 py-2 bg-slate-800/50 hover:bg-slate-800 rounded-lg flex justify-between items-center text-xs font-bold text-slate-300 transition-colors mb-1" onclick="toggleAcordeon('mod-body-${modIdx}')">
                        <span>${mod.titulo}</span>
                        <i data-lucide="chevron-down" class="w-4 h-4"></i>
                    </button>
                    <div id="mod-body-${modIdx}" class="space-y-0.5 pl-2 pb-2"></div>
                `;
                
                container.appendChild(modHTML);
                const body = modHTML.querySelector(`#mod-body-${modIdx}`);

                // Lecciones del Módulo
                if(mod.lecciones && mod.lecciones.length > 0) {
                    mod.lecciones.forEach((lec, lecIdx) => {
                        const globalIndex = flatLessons.length;
                        flatLessons.push({ ...lec, modIdx, lecIdx }); // Guardamos referencia plana

                        const btn = document.createElement('button');
                        btn.className = "w-full text-left px-3 py-2 rounded-lg flex items-center gap-3 text-xs text-slate-400 hover:bg-slate-800 hover:text-white transition-all group";
                        btn.onclick = () => cargarClase(globalIndex);
                        
                        const icon = lec.tipo === 'VIDEO' ? 'play-circle' : 'file-text';
                        const color = lec.tipo === 'VIDEO' ? 'text-blue-500' : 'text-red-500';

                        btn.innerHTML = `
                            <i data-lucide="${icon}" class="w-4 h-4 ${color} shrink-0"></i>
                            <span class="truncate">${lec.titulo}</span>
                            <i data-lucide="check-circle" class="w-3 h-3 ml-auto text-slate-700 group-hover:text-slate-600"></i>
                        `;
                        body.appendChild(btn);
                    });
                } else {
                    body.innerHTML = `<p class="text-[10px] text-slate-600 pl-4 py-1 italic">Sin contenido</p>`;
                }
            });

            lucide.createIcons();
            
            // Cargar la primera clase automáticamente si existe
            if(flatLessons.length > 0) cargarClase(0);
        }

        function toggleAcordeon(id) {
            const el = document.getElementById(id);
            el.classList.toggle('hidden');
        }

        function cargarClase(index) {
            if(index < 0 || index >= flatLessons.length) return;
            
            currentLessonIndex = index;
            const leccion = flatLessons[index];
            const playerArea = document.getElementById('player-area');
            const titleArea = document.getElementById('current-lesson-title');

            titleArea.innerText = leccion.titulo;

            // Lógica para mostrar VIDEO o PDF
            if(leccion.tipo === 'VIDEO') {
                let embedUrl = "";
                // Detectar si es YouTube (ID o URL)
                if(leccion.url.length === 11) { // Asumimos ID de 11 caracteres
                    embedUrl = `https://www.youtube.com/embed/${leccion.url}?autoplay=1&rel=0&modestbranding=1`;
                } else if(leccion.url.includes('youtu')) {
                    // Logica simple para extraer ID de URL (se puede mejorar)
                    const videoId = leccion.url.split('v=')[1] || leccion.url.split('/').pop();
                    embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
                } else {
                    // Si es un MP4 directo (Supabase storage)
                    playerArea.innerHTML = `<video src="${leccion.url}" controls autoplay class="w-full h-full bg-black"></video>`;
                    updateNavButtons();
                    return;
                }

                playerArea.innerHTML = `
                    <div class="video-container w-full h-full">
                        <iframe src="${embedUrl}" title="Reproductor" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>`;

            } else if (leccion.tipo === 'PDF') {
                playerArea.innerHTML = `
                    <div class="w-full h-full bg-slate-800 flex flex-col items-center justify-center p-10 text-center">
                        <i data-lucide="file-text" class="w-20 h-20 text-red-500 mb-4"></i>
                        <h3 class="text-xl font-bold text-white mb-2">Material de Lectura</h3>
                        <p class="text-slate-400 mb-6 max-w-md">Este contenido es un documento PDF. Puedes leerlo aquí o descargarlo.</p>
                        <div class="flex gap-4">
                            <a href="${leccion.url}" target="_blank" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2">
                                <i data-lucide="download"></i> Descargar PDF
                            </a>
                             <a href="${leccion.url}" target="_blank" class="bg-slate-700 hover:bg-slate-600 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2">
                                <i data-lucide="eye"></i> Abrir en Pestaña
                            </a>
                        </div>
                    </div>`;
                lucide.createIcons();
            }

            updateNavButtons();
            
            // Resaltar en Sidebar
            // (Aquí podrías agregar lógica visual para marcar la clase activa en el menú)
        }

        function updateNavButtons() {
            const btnPrev = document.getElementById('btn-prev');
            const btnNext = document.getElementById('btn-next');

            btnPrev.disabled = currentLessonIndex <= 0;
            btnPrev.onclick = () => cargarClase(currentLessonIndex - 1);

            btnNext.disabled = currentLessonIndex >= flatLessons.length - 1;
            btnNext.onclick = () => cargarClase(currentLessonIndex + 1);
        }

    </script>
</body>
</html>
