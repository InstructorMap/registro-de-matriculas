<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Principal | ASARI SaaS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-50 flex h-screen overflow-hidden font-sans text-slate-800">

    <aside id="sidebar" class="w-64 bg-slate-900 text-white flex flex-col hidden md:flex border-r border-slate-800 transition-colors duration-500">
        <div class="p-6 flex items-center gap-3 border-b border-white/10 h-24">
            <img id="sidebar-logo" src="" class="h-10 w-10 object-contain hidden bg-white rounded-lg p-1">
            <div id="sidebar-brand-text">
                <h1 class="font-bold text-lg tracking-wide">ASARI <span class="text-xs text-blue-400">SaaS</span></h1>
            </div>
        </div>
        <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-1">
            <div class="pt-2 pb-2 px-3 text-[10px] font-bold text-white/40 uppercase tracking-wider">Principal</div>
            <div class="flex items-center gap-3 px-3 py-3 bg-white/10 text-white rounded-xl shadow-inner">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span class="text-sm font-bold">Dashboard</span>
            </div>
            
            <div class="pt-6 pb-2 px-3 text-[10px] font-bold text-white/40 uppercase tracking-wider">Gestión</div>
            <a href="cursos.html" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-white/10 rounded-xl transition-colors">
                <i data-lucide="book-open" class="w-5 h-5"></i>
                <span class="text-sm font-bold">Mis Cursos</span>
            </a>
        </nav>
        <div class="p-4 border-t border-white/10 bg-black/20">
            <div class="flex items-center gap-3">
                <div class="h-8 w-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold" id="user-initials">U</div>
                <div class="overflow-hidden">
                    <p class="text-sm font-bold truncate" id="user-name">Cargando...</p>
                    <button onclick="logout()" class="text-[10px] text-red-400 hover:text-red-300 font-bold uppercase">Cerrar Sesión</button>
                </div>
            </div>
        </div>
    </aside>

    <div class="flex-1 flex flex-col min-w-0">
        <header class="h-20 bg-white border-b border-slate-200 flex items-center justify-between px-8 shadow-sm">
            <div>
                <h2 class="text-2xl font-black text-slate-800">Panel General</h2>
                <p class="text-xs text-slate-500 font-medium mt-1">Resumen de actividad y métricas</p>
            </div>
            <div class="flex gap-3">
                <button onclick="abrirModalMatricula()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-3 rounded-xl text-sm font-bold flex items-center gap-2 shadow-lg shadow-blue-900/20 transition-all">
                    <i data-lucide="user-plus" class="w-5 h-5"></i> Nueva Matrícula
                </button>
            </div>
        </header>

        <main class="flex-1 p-8 overflow-y-auto bg-slate-50">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center">
                        <i data-lucide="users" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase">Total Alumnos</p>
                        <h3 class="text-2xl font-black text-slate-800" id="kpi-alumnos">-</h3>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-green-50 text-green-600 flex items-center justify-center">
                        <i data-lucide="book" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase">Cursos Activos</p>
                        <h3 class="text-2xl font-black text-slate-800" id="kpi-cursos">-</h3>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center">
                        <i data-lucide="activity" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase">Estado Sistema</p>
                        <h3 class="text-lg font-black text-green-500">Operativo</h3>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="font-bold text-slate-800">Últimas Matriculaciones</h3>
                    <a href="cursos.html" class="text-xs font-bold text-blue-600 hover:underline">Ver cursos completos &rarr;</a>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 font-bold text-xs uppercase">
                            <tr>
                                <th class="px-6 py-4">Fecha</th>
                                <th class="px-6 py-4">Alumno</th>
                                <th class="px-6 py-4">DNI</th>
                                <th class="px-6 py-4">Curso Asignado</th>
                                <th class="px-6 py-4">Estado</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-matriculas" class="divide-y divide-slate-100">
                            <tr><td colspan="5" class="px-6 py-8 text-center text-slate-400">Cargando datos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <div id="modal-global" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-8 relative">
            <button onclick="document.getElementById('modal-global').classList.add('hidden')" class="absolute top-4 right-4 text-slate-300 hover:text-slate-600"><i data-lucide="x"></i></button>
            
            <h3 class="text-xl font-black text-slate-800 mb-1">Inscribir Alumno</h3>
            <p class="text-sm text-slate-500 mb-6">Selecciona el curso y carga los datos del alumno.</p>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Curso Destino</label>
                    <select id="glob-curso" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg text-sm font-bold text-slate-700 outline-none focus:border-blue-500">
                        <option value="">Cargando cursos...</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nombre</label>
                        <input type="text" id="glob-nombre" class="w-full p-2.5 border border-slate-200 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Apellido</label>
                        <input type="text" id="glob-apellido" class="w-full p-2.5 border border-slate-200 rounded-lg text-sm">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">DNI (Sin puntos)</label>
                    <input type="text" id="glob-dni" class="w-full p-2.5 border border-slate-200 rounded-lg text-sm" placeholder="Ej: 30123456">
                </div>

                <button onclick="guardarMatriculaGlobal()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition shadow-lg mt-2">
                    Confirmar Inscripción
                </button>
            </div>
        </div>
    </div>

    <script>
        const PROJECT_URL = 'https://vxggatcfrywyodovjwxj.supabase.co';
        const PUBLIC_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4Z2dhdGNmcnl3eW9kb3Zqd3hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzM5MjgsImV4cCI6MjA4MzgwOTkyOH0.RZ9jhEASO6nCV8EnzrHQBhglP4G1nik9Z5osPXysGNg';
        const db = supabase.createClient(PROJECT_URL, PUBLIC_KEY);

        let currentProfile = null;
        let cursosDisponibles = [];

        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            await verificarSesion();
        });

        async function verificarSesion() {
            const { data: { session } } = await db.auth.getSession();
            if (!session) return window.location.href = '../index.html';

            const { data: perfil } = await db.from('perfiles').select('*, instituciones(*)').eq('id', session.user.id).single();
            if (!perfil) return;
            currentProfile = perfil;

            cargarBranding(perfil);
            cargarDatos();
        }

        function cargarBranding(perfil) {
            document.getElementById('user-name').innerText = perfil.nombre_completo;
            document.getElementById('user-initials').innerText = (perfil.nombre_completo || 'U').charAt(0).toUpperCase();
            
            if(perfil.instituciones) {
                const inst = perfil.instituciones;
                if(inst.logo_url) {
                    const l = document.getElementById('sidebar-logo');
                    l.src = inst.logo_url; l.classList.remove('hidden');
                }
                if(inst.color_primario) document.getElementById('sidebar').style.background = inst.color_primario;
                if(inst.nombre) document.getElementById('sidebar-brand-text').innerHTML = `<h1 class="font-bold text-lg leading-tight">${inst.nombre}</h1>`;
            }
        }

        async function cargarDatos() {
            // 1. Cargar Cursos (Para KPI y Select)
            let q = db.from('cursos_oficiales').select('id, nombre, registro_id');
            if(currentProfile.rol !== 'superadmin') q = q.eq('institution_id', currentProfile.institucion_id);
            const { data: cursos } = await q;
            
            if(cursos) {
                cursosDisponibles = cursos;
                document.getElementById('kpi-cursos').innerText = cursos.length;
                llenarSelectCursos(cursos);
            }

            // 2. Cargar Matriculas (Para KPI y Tabla)
            // Traemos las últimas 10
            let qm = db.from('matriculas').select('*').order('created_at', { ascending: false }).limit(10);
            if(currentProfile.rol !== 'superadmin') qm = qm.eq('institution_id', currentProfile.institucion_id);
            const { data: matriculas } = await qm;

            if(matriculas) {
                // Total aproximado (si quieres el total real, harías un count, pero por ahora usamos length de lo traido o hacemos otra query count)
                // Hacemos query count separada para KPI total
                const { count } = await db.from('matriculas').select('*', { count: 'exact', head: true }).eq('estado', 'ACTIVO');
                document.getElementById('kpi-alumnos').innerText = count || matriculas.length;

                renderizarTabla(matriculas);
            }
        }

        function renderizarTabla(filas) {
            const tbody = document.getElementById('tabla-matriculas');
            tbody.innerHTML = "";
            if(filas.length === 0) { tbody.innerHTML = `<tr><td colspan="5" class="p-6 text-center text-slate-400">Sin inscripciones recientes.</td></tr>`; return; }

            filas.forEach(m => {
                const fecha = new Date(m.created_at).toLocaleDateString();
                const html = `
                <tr class="hover:bg-slate-50 transition">
                    <td class="px-6 py-4 text-slate-500">${fecha}</td>
                    <td class="px-6 py-4 font-bold text-slate-700">${m.nombre} ${m.apellido}</td>
                    <td class="px-6 py-4 font-mono text-slate-500">${m.dni_alumno}</td>
                    <td class="px-6 py-4 text-blue-600 font-bold text-xs uppercase">${m.curso}</td>
                    <td class="px-6 py-4"><span class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">ACTIVO</span></td>
                </tr>`;
                tbody.innerHTML += html;
            });
        }

        // --- GESTIÓN GLOBAL DE MATRÍCULA ---

        function abrirModalMatricula() {
            document.getElementById('modal-global').classList.remove('hidden');
        }

        function llenarSelectCursos(cursos) {
            const sel = document.getElementById('glob-curso');
            sel.innerHTML = `<option value="">Selecciona un curso...</option>`;
            cursos.forEach(c => {
                sel.innerHTML += `<option value="${c.nombre}" data-reg="${c.registro_id}">${c.nombre}</option>`;
            });
        }

        async function guardarMatriculaGlobal() {
            const sel = document.getElementById('glob-curso');
            const cursoNombre = sel.value;
            const registroId = sel.options[sel.selectedIndex].getAttribute('data-reg') || 'remaep';
            
            const dni = document.getElementById('glob-dni').value.trim();
            const nombre = document.getElementById('glob-nombre').value;
            const apellido = document.getElementById('glob-apellido').value;

            if(!cursoNombre || !dni || !nombre) return alert("Completa todos los datos.");

            const btn = document.querySelector('button[onclick="guardarMatriculaGlobal()"]');
            btn.innerText = "Guardando..."; btn.disabled = true;

            const payload = {
                dni_alumno: dni, nombre, apellido,
                curso: cursoNombre,
                registro_id: registroId,
                institution_id: currentProfile.institucion_id,
                fecha_inicio: new Date().toISOString(),
                estado: 'ACTIVO'
            };

            const { error } = await db.from('matriculas').insert([payload]);

            if(error) alert("Error: " + error.message);
            else {
                alert("Alumno inscripto correctamente.");
                document.getElementById('modal-global').classList.add('hidden');
                cargarDatos(); // Refrescar tabla y KPIs
                // Limpiar form
                document.getElementById('glob-dni').value = "";
                document.getElementById('glob-nombre').value = "";
                document.getElementById('glob-apellido').value = "";
            }
            btn.innerText = "Confirmar Inscripción"; btn.disabled = false;
        }

        async function logout() { await db.auth.signOut(); window.location.href = '../index.html'; }
    </script>
</body>
</html>
