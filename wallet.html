<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mi Billetera Digital</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e293b" id="meta-theme-color">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f0f4f8; overflow-x: hidden; height: 100vh; width: 100vw; touch-action: pan-y; }
        
        :root { --brand-color: #1e293b; }
        .bg-brand { background-color: var(--brand-color) !important; }
        .text-brand { color: var(--brand-color) !important; }

        /* LOGIN */
        #login-screen { position: fixed; inset: 0; background: linear-gradient(135deg, var(--brand-color) 0%, #000 100%); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; transition: opacity 0.5s; }
        
        /* CARD SLIDER */
        .card-slider {
            display: flex; overflow-x: auto; scroll-snap-type: x mandatory; 
            gap: 20px; padding: 20px 30px; 
            height: 300px; /* Espacio reservado fijo */
            align-items: center;
        }
        .card-slider::-webkit-scrollbar { display: none; }

        .card-wrapper {
            flex: 0 0 85vw; /* Ancho relativo al celular */
            scroll-snap-align: center;
            perspective: 1000px;
            aspect-ratio: 1011/638; /* Proporción Mágica del Carnet */
            position: relative;
        }

        /* TARJETA */
        .digital-card { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; border-radius: 20px; box-shadow: 0 15px 40px -5px rgba(0,0,0,0.4); }
        .card-wrapper.flipped .digital-card { transform: rotateY(180deg); }
        .card-face { position: absolute; inset: 0; backface-visibility: hidden; border-radius: 20px; overflow: hidden; background: white; -webkit-mask-image: -webkit-radial-gradient(white, black); /* Fix bordes safari */ }
        .card-back { transform: rotateY(180deg); background: #eee; display:flex; align-items:center; justify-content:center; }

        /* ESCALADOR CSS (SOLUCIÓN CRÍTICA) */
        .scaler-container { width: 100%; height: 100%; position: relative; overflow: hidden; }
        .scaler {
            width: 1011px; height: 638px;
            position: absolute; top: 0; left: 0;
            transform-origin: 0 0; /* Punto de anclaje esquina superior izquierda */
            background: white;
            pointer-events: none; /* Mejorar scroll táctil */
        }

        /* DISEÑO INTERNO (Heredado del generador V3) */
        .front-left { width: 380px; height: 100%; position: absolute; left: 0; top: 0; background: #d4d4d4; border-top-left-radius: 40px; border-bottom-left-radius: 40px; overflow: hidden; z-index: 2; }
        .front-right { width: 631px; height: 100%; position: absolute; right: 0; top: 0; background: #0033cc; color: white; padding: 25px 35px; display: flex; flex-direction: column; justify-content: space-between; border-top-right-radius: 40px; border-bottom-right-radius: 40px; }
        .reg-sigla { position: absolute; bottom: 15px; width: 100%; text-align: center; color: white; font-size: 26px; font-weight: 900; z-index: 10; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); }
        .header-text { font-size: 80px; font-weight: 900; text-transform: uppercase; line-height: 0.9; }
        .student-name { font-size: 38px; font-weight: 700; text-transform: uppercase; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; margin-bottom: 10px; }
        .data-row { font-size: 32px; font-weight: 700; display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px; }
        .qr-box { position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); width: 160px; height: 160px; background: white; padding: 10px; border-radius: 15px; z-index: 5; }
    </style>
</head>
<body class="bg-slate-100 flex flex-col h-screen">

    <div id="login-screen">
        <div class="mb-8 text-center animate-fade-in">
            <div class="w-24 h-24 bg-white/10 rounded-3xl flex items-center justify-center mx-auto mb-6 backdrop-blur-md border border-white/20">
                <i data-lucide="wallet" class="text-white w-12 h-12"></i>
            </div>
            <h1 class="text-3xl font-black text-white">Mi Billetera</h1>
            <p class="text-white/60 text-sm">Credenciales Oficiales</p>
        </div>
        <div class="w-full max-w-xs space-y-4">
            <input type="tel" id="dni-input" class="w-full bg-white/10 border border-white/20 text-white font-bold text-xl px-4 py-4 rounded-2xl text-center placeholder-white/20 backdrop-blur-sm" placeholder="Ingrese DNI">
            <button onclick="ingresarWallet()" class="w-full bg-white text-slate-900 font-black py-4 rounded-2xl shadow-xl flex items-center justify-center gap-2">INGRESAR</button>
            <p id="login-error" class="text-red-300 text-center text-xs font-bold hidden bg-red-900/50 p-2 rounded"></p>
        </div>
    </div>

    <div id="app-interface" class="hidden flex-1 flex flex-col h-full overflow-hidden">
        
        <header class="bg-brand text-white p-6 pt-10 pb-6 rounded-b-[30px] shadow-lg z-20 flex-shrink-0">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <p class="text-white/60 text-xs font-bold uppercase" id="inst-label">Hola,</p>
                    <h2 class="text-xl font-black truncate max-w-[200px]" id="user-name">Usuario</h2>
                </div>
                <div class="w-12 h-12 rounded-full bg-white p-0.5 shadow overflow-hidden">
                    <img id="header-avatar" src="https://via.placeholder.com/100" class="w-full h-full rounded-full object-cover">
                </div>
            </div>
        </header>

        <main class="flex-1 flex flex-col relative overflow-y-auto">
            <p class="text-center text-[10px] font-bold text-slate-400 uppercase mt-6 tracking-widest">Tus Credenciales</p>
            
            <div class="card-slider" id="card-container">
                </div>

            <div class="px-5 mb-6">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-slate-800 text-sm mb-3 flex items-center gap-2"><i data-lucide="file-text" class="w-4 h-4 text-brand"></i> Documentos</h3>
                    <div id="docs-buttons" class="space-y-2">
                        <p class="text-xs text-slate-400 text-center italic">Selecciona una tarjeta arriba...</p>
                    </div>
                </div>
            </div>
        </main>

        <nav class="bg-white border-t border-slate-200 p-3 flex justify-around items-center z-30 flex-shrink-0 safe-area-pb">
            <button class="flex flex-col items-center gap-1 text-brand"><i data-lucide="wallet-cards" class="w-6 h-6"></i><span class="text-[10px] font-bold">Wallet</span></button>
            <button onclick="logout()" class="flex flex-col items-center gap-1 text-slate-400"><i data-lucide="log-out" class="w-6 h-6"></i><span class="text-[10px] font-bold">Salir</span></button>
        </nav>
    </div>

    <script>
        const PROJECT_URL = 'https://vxggatcfrywyodovjwxj.supabase.co';
        const PUBLIC_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4Z2dhdGNmcnl3eW9kb3Zqd3hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzM5MjgsImV4cCI6MjA4MzgwOTkyOH0.RZ9jhEASO6nCV8EnzrHQBhglP4G1nik9Z5osPXysGNg';
        const db = supabase.createClient(PROJECT_URL, PUBLIC_KEY);
        let misMatriculas = [];

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            const savedDNI = localStorage.getItem('asari_wallet_dni');
            if(savedDNI) document.getElementById('dni-input').value = savedDNI;
            // Re-calcular si se gira el celular
            window.addEventListener('resize', () => {
                setTimeout(ajustarTodasLasEscalas, 100);
            });
        });

        async function ingresarWallet() {
            const dni = document.getElementById('dni-input').value.trim();
            const btn = document.querySelector('#login-screen button');
            const errDiv = document.getElementById('login-error');
            
            if(!dni) return;
            
            btn.innerText = "BUSCANDO...";
            errDiv.classList.add('hidden');

            try {
                // 1. Obtener Matrículas
                const { data: alumnos, error } = await db.from('matriculas').select('*').eq('dni_alumno', dni);
                if (error) throw error;
                if (!alumnos || alumnos.length === 0) throw new Error("DNI no encontrado en el sistema.");

                // 2. Unir Documentos (Manual Join)
                const datos = await Promise.all(alumnos.map(async (al) => {
                    const { data: curso } = await db.from('cursos_oficiales').select('diploma_bg_url, analitico_bg_url').eq('nombre', al.curso).single();
                    return { ...al, cursos_oficiales: curso || { diploma_bg_url: null, analitico_bg_url: null } };
                }));

                misMatriculas = datos;
                localStorage.setItem('asari_wallet_dni', dni);
                iniciarApp(datos);

            } catch (err) {
                console.error(err);
                errDiv.innerText = err.message || "Error de conexión.";
                errDiv.classList.remove('hidden');
                btn.innerText = "INGRESAR";
            }
        }

        function iniciarApp(data) {
            // Transición UI
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-interface').classList.remove('hidden');
            
            // Forzar reflow para asegurar que el navegador vea el cambio
            document.getElementById('app-interface').style.opacity = 1;

            const alumno = data[0];
            document.getElementById('user-name').innerText = alumno.nombre.split(' ')[0] + ' ' + alumno.apellido;
            if(alumno.foto_url) document.getElementById('header-avatar').src = alumno.foto_url;

            // Determinar Color App (Usando el primer registro)
            const colorConfig = obtenerConfigColor(alumno.registro_id);
            document.documentElement.style.setProperty('--brand-color', colorConfig.c2);
            document.getElementById('meta-theme-color').setAttribute('content', colorConfig.c2);

            renderizarTarjetas(data);
        }

        function renderizarTarjetas(matriculas) {
            const container = document.getElementById('card-container');
            container.innerHTML = "";

            matriculas.forEach((mat, i) => {
                const cfg = obtenerConfigColor(mat.registro_id);
                
                container.innerHTML += `
                <div class="card-wrapper" onclick="this.classList.toggle('flipped')">
                    <div class="digital-card">
                        <div class="card-face">
                            <div class="scaler-container">
                                <div class="scaler" id="scaler-${i}">
                                    <div class="front-left">
                                        <img src="${mat.foto_url || ''}" class="student-photo">
                                        <div class="reg-sigla">${cfg.sigla}</div>
                                        <div class="qr-box" id="qr-${i}"></div>
                                        <svg style="position:absolute;bottom:0;left:0;width:100%;height:100%;z-index:2;" viewBox="0 0 380 638" preserveAspectRatio="none"><path d="M -50 680 L 350 680 L -50 280 Z" fill="${cfg.c2}" style="opacity:0.9"/></svg>
                                    </div>
                                    <div class="front-right" style="background:${cfg.c2};color:${cfg.txt}">
                                        <div style="display:flex;justify-content:space-between;border-bottom:4px solid rgba(255,255,255,0.5);padding-bottom:5px;">
                                            <span class="header-text">CARNET</span><span class="header-text">${new Date(mat.fecha_inicio||new Date()).getFullYear()}</span>
                                        </div>
                                        <div style="flex:1;display:flex;flex-direction:column;justify-content:center;">
                                            <div style="font-size:55px;font-weight:900;text-transform:uppercase;text-align:center;line-height:1;margin-bottom:15px;">${mat.curso}</div>
                                            <div class="student-name" style="text-align:center;">${mat.nombre} ${mat.apellido}</div>
                                            <div class="data-row"><span>DNI:</span><span>${mat.dni_alumno}</span></div>
                                            <div class="data-row"><span>MATRÍCULA:</span><span>${generarHash(mat.dni_alumno)}</span></div>
                                            <div class="data-row"><span>VENCE:</span><span>${calcularVencimiento(mat.fecha_inicio)}</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-face card-back">
                            <img src="reverso.jpg" style="width:100%;height:100%;object-fit:cover;" onerror="this.src='https://via.placeholder.com/1011x638?text=REVERSO'">
                        </div>
                    </div>
                </div>`;
            });

            // 1. Generar QRs
            matriculas.forEach((mat, i) => {
                new QRCode(document.getElementById(`qr-${i}`), { text: `https://instructormap.github.io/registro-de-matriculas/validador.html?id=${mat.id}`, width: 140, height: 140 });
            });

            // 2. Ejecutar Ajuste de Escala (Con Retry por seguridad)
            setTimeout(ajustarTodasLasEscalas, 50);
            setTimeout(ajustarTodasLasEscalas, 500); // Segundo intento por si el navegador es lento

            // 3. Listener Scroll
            container.addEventListener('scroll', () => {
                const center = container.scrollLeft + (container.offsetWidth/2);
                document.querySelectorAll('.card-wrapper').forEach((el, i) => {
                    if(Math.abs(center - (el.offsetLeft + el.offsetWidth/2)) < el.offsetWidth/2) mostrarDocs(i);
                });
            });
            
            // Mostrar documentos del primero por defecto
            if(matriculas.length > 0) mostrarDocs(0);
        }

        // FUNCIÓN CRÍTICA REPARADA: Cálculo de Escala
        function ajustarTodasLasEscalas() {
            const wrappers = document.querySelectorAll('.card-wrapper');
            if(wrappers.length === 0) return;

            // Obtenemos el ancho real del contenedor en pantalla
            const cardWidth = wrappers[0].getBoundingClientRect().width;
            
            if (cardWidth === 0) return; // Si aún no se pintó, salimos

            // El diseño original mide 1011px de ancho
            const scale = cardWidth / 1011; 

            document.querySelectorAll('.scaler').forEach(el => {
                el.style.transform = `scale(${scale})`;
                // Forzamos el tamaño del contenedor "falso" para que el scale no lo rompa
                el.style.width = '1011px';
                el.style.height = '638px';
            });
        }

        function mostrarDocs(i) {
            if(!misMatriculas[i]) return;
            const mat = misMatriculas[i];
            const docs = mat.cursos_oficiales;
            const div = document.getElementById('docs-buttons');
            
            let html = `<p class="text-[10px] font-bold text-slate-400 uppercase mb-2 text-center">Curso: ${mat.curso}</p>`;
            
            const btn = (lbl, sub, icon, url) => `
            <button onclick="${url ? `window.open('${url}','_blank')` : "alert('No disponible')"}" class="w-full bg-white border border-slate-200 text-slate-700 font-bold py-3 px-4 rounded-xl flex items-center gap-3 shadow-sm active:bg-slate-50 mb-2 transition">
                <div class="bg-slate-100 p-2 rounded-lg text-brand"><i data-lucide="${icon}"></i></div>
                <div class="text-left flex-1"><p class="text-sm">${lbl}</p><p class="text-[10px] text-slate-400">${sub}</p></div>
                <i data-lucide="chevron-right" class="text-slate-300"></i>
            </button>`;

            if(docs && docs.diploma_bg_url) html += btn('Diploma Oficial', 'Descargar Certificado', 'scroll-text', `credencial_v3.html?dni=${mat.dni_alumno}`);
            else html += `<div class="text-center text-xs text-slate-300 py-2">Sin Diploma</div>`;

            if(docs && docs.analitico_bg_url) html += btn('Analítico', 'Historial Académico', 'file-check', `credencial_v3.html?dni=${mat.dni_alumno}`);

            div.innerHTML = html;
            lucide.createIcons();
        }

        function logout() { localStorage.removeItem('asari_wallet_dni'); location.reload(); }

        // --- LÓGICA DE COLORES ROBUSTA ---
        function obtenerConfigColor(rid) {
            // Limpieza de datos (Trim + LowerCase) para evitar errores de tipeo en DB
            const key = String(rid || '').trim().toLowerCase();
            
            const map = {
                'remaep': { c2:'#0033cc', sigla:'R.E.M.A.E.P', txt:'white' },
                'rniue':  { c2:'#b8860b', sigla:'R.N.I.U.E',   txt:'white' },
                'rubra':  { c2:'#cc0000', sigla:'R.U.B.R.A',   txt:'white' },
                'rmts':   { c2:'#2f4f4f', sigla:'R.M.T.S',     txt:'white' },
                'rce':    { c2:'#ffcc00', sigla:'R.C.E',       txt:'black' },
                'rpde':   { c2:'#0099ff', sigla:'R.P.D.E',     txt:'white' },
                'asarin': { c2:'#800000', sigla:'ASARIN',      txt:'white' }
            };
            return map[key] || map['remaep']; // Si no encuentra, usa remaep (azul)
        }

        function generarHash(d) { let h=0; for(let i=0;i<d.length;i++) h=((h<<5)-h)+d.charCodeAt(i)|0; return String(Math.abs(h)).substring(0,6).padStart(6,'9'); }
        function calcularVencimiento(f) { const d=new Date(f||new Date()); d.setFullYear(d.getFullYear()+1); return d.toLocaleDateString('es-AR'); }
    </script>
</body>
</html>
