<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Campus | Panel Alumno</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .hover-lift { transition: transform 0.2s; }
        .hover-lift:hover { transform: translateY(-4px); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav id="navbar" class="h-16 border-b border-white/5 bg-slate-900/90 backdrop-blur-sm sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div id="logo-container" class="h-9 w-auto bg-white/90 rounded-lg p-1 shadow-lg shadow-white/10 items-center justify-center hidden">
                    <img id="inst-logo" src="" class="h-full w-auto object-contain">
                </div>
                <div class="h-6 w-px bg-white/10"></div>
                <span class="font-bold text-white text-sm md:text-base" id="inst-name">Campus Virtual</span>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="text-right hidden sm:block">
                    <p class="text-sm font-semibold text-white" id="user-name">Alumno</p>
                    <p class="text-[10px] text-slate-400">Mi Panel</p>
                </div>
                <div class="w-8 h-8 rounded-full overflow-hidden border-2 border-white/20" id="user-avatar">
                    <img id="user-photo" src="" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentElement.innerHTML='<i data-lucide=\"user\" class=\"w-4 h-4 m-auto\"></i>'; lucide.createIcons();">
                </div>
                <button onclick="logout()" class="p-1.5 text-slate-400 hover:text-red-400 transition" title="Salir">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 p-4 md:p-6">
        <div class="max-w-7xl mx-auto space-y-8">
            
            <!-- Welcome Section -->
            <div class="bg-gradient-to-r from-slate-800 to-slate-900 rounded-2xl p-6 md:p-8 border border-white/5">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-white mb-2">
                            Hola, <span class="text-indigo-300" id="welcome-name">Alumno</span>
                        </h1>
                        <p class="text-slate-400 text-sm">
                            Tus cursos están listos para continuar.
                        </p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="generarDiploma()" class="bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white text-sm font-bold px-4 py-2.5 rounded-lg transition-all flex items-center gap-2 shadow-lg shadow-emerald-900/30">
                            <i data-lucide="award" class="w-4 h-4"></i>
                            Diploma Analítico
                        </button>
                        <button onclick="generarCarnet()" class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white text-sm font-bold px-4 py-2.5 rounded-lg transition-all flex items-center gap-2 shadow-lg shadow-blue-900/30">
                            <i data-lucide="id-card" class="w-4 h-4"></i>
                            Carnet Digital
                        </button>
                    </div>
                </div>
            </div>

            <!-- Courses Grid -->
            <div>
                <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                    <i data-lucide="book-open" class="text-indigo-400 w-5 h-5"></i> 
                    Mis Cursos
                </h2>
                
                <div id="courses-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    <!-- Loading State -->
                    <div class="col-span-full py-12 text-center text-slate-500">
                        <i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto mb-3"></i>
                        <p class="text-sm">Cargando tus cursos...</p>
                    </div>
                </div>

                <!-- No Courses State -->
                <div id="no-courses" class="hidden col-span-full text-center py-12 bg-slate-800/30 rounded-xl border border-dashed border-slate-700">
                    <i data-lucide="book-x" class="w-10 h-10 text-slate-600 mx-auto mb-3"></i>
                    <p class="text-slate-400 mb-2">No tienes cursos activos</p>
                    <p class="text-sm text-slate-500">Contacta a tu institución para matricularte</p>
                </div>
            </div>

        </div>
    </main>

    <script>
        // ============================================
        // CONFIGURACIÓN SUPABASE
        // ============================================
        const PROJECT_URL = 'https://vxggatcfrywyodovjwxj.supabase.co';
        const PUBLIC_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4Z2dhdGNmcnl3eW9kb3Zqd3hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzM5MjgsImV4cCI6MjA4MzgwOTkyOH0.RZ9jhEASO6nCV8EnzrHQBhglP4G1nik9Z5osPXysGNg';
        const db = supabase.createClient(PROJECT_URL, PUBLIC_KEY);

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let currentUser = null;
        let currentInstitutionId = null;
        let studentData = null;

       // ============================================
        // 1. INICIALIZACIÓN Y VERIFICACIÓN DE SEGURIDAD
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            
            // 1. Obtener sesión
            const { data: { session } } = await db.auth.getSession();
            
            // 2. Si no hay sesión, al login de esta carpeta
            if (!session) {
                window.location.href = './login.html'; // El ./ es clave
                return;
            }

            // 3. Verificar que sea ALUMNO (Seguridad SaaS)
            // Esto evita que tú como admin entres por error al panel de alumnos
            const userRole = session.user.user_metadata.rol;
            if (userRole !== 'alumno') {
                console.warn("Acceso denegado: Rol no autorizado para este panel");
                window.location.href = '/admin/panel.html'; // Te expulsa a la raíz
                return;
            }
            
            // 4. Si todo está OK, cargamos los datos reales de tus tablas
            currentUser = session.user;
            await loadStudentData();       // Carga nombre/apellido desde 'perfiles' o 'matriculas'
            await loadInstitutionBranding(); // Carga el color del instituto (Camaleón)
            await loadStudentCourses();    // Carga las múltiples tarjetas de curso
        });

        // ============================================
        // 2. CARGAR DATOS DEL ALUMNO (PERFIL SUPERIOR)
        // ============================================
        async function loadStudentData() {
            try {
                // Obtener DNI del perfil del usuario
                const { data: perfil, error: perfilError } = await db
                    .from('perfiles')
                    .select('dni')
                    .eq('id', currentUser.id)
                    .maybeSingle();
                    
                if (perfilError || !perfil || !perfil.dni) {
                    console.error('Error obteniendo DNI del perfil:', perfilError);
                    showError('Error al cargar datos del estudiante');
                    return;
                }

                // Buscar datos del alumno en la tabla matriculas usando el DNI
                const { data: matriculas, error: matError } = await db
                    .from('matriculas')
                    .select('nombre, apellido, foto_url, institution_id')
                    .eq('dni_alumno', perfil.dni)
                    .limit(1);
                    
                if (matError || !matriculas || matriculas.length === 0) {
                    console.error('Alumno no encontrado en matrículas:', matError);
                    return;
                }

                studentData = matriculas[0];
                currentInstitutionId = studentData.institution_id;

                // Actualizar UI con datos del alumno
                const nombreCompleto = `${studentData.nombre} ${studentData.apellido}`;
                document.getElementById('user-name').textContent = nombreCompleto;
                document.getElementById('welcome-name').textContent = studentData.nombre;

                // Foto del alumno (si existe)
                const userPhoto = document.getElementById('user-photo');
                const userAvatar = document.getElementById('user-avatar');
                if (studentData.foto_url) {
                    userPhoto.src = studentData.foto_url;
                    userAvatar.classList.add('bg-transparent');
                } else {
                    userAvatar.innerHTML = '<i data-lucide="user" class="w-4 h-4 m-auto text-white"></i>';
                    lucide.createIcons();
                }

            } catch (error) {
                console.error('Error cargando datos del alumno:', error);
            }
        }

        // ============================================
        // 3. BRANDING CAMALEÓNICO (INSTITUCIÓN)
        // ============================================
        async function loadInstitutionBranding() {
            if (!currentInstitutionId) return;

            try {
                const { data: institucion, error } = await db
                    .from('instituciones')
                    .select('nombre, logo_url, color_primario')
                    .eq('id', currentInstitutionId)
                    .maybeSingle();
                    
                if (error || !institucion) return;

                // Actualizar nombre de la institución
                document.getElementById('inst-name').textContent = institucion.nombre;

                // Logo de la institución
                const logoContainer = document.getElementById('logo-container');
                const logoImg = document.getElementById('inst-logo');
                if (institucion.logo_url && institucion.logo_url.startsWith('http')) {
                    logoImg.src = institucion.logo_url;
                    logoContainer.classList.remove('hidden');
                    logoContainer.classList.add('flex');
                }

                // Color principal (Branding)
                if (institucion.color_primario) {
                    const color = institucion.color_primario;
                    
                    // Aplicar color a elementos clave
                    document.getElementById('navbar').style.borderBottomColor = color + '30';
                    document.getElementById('welcome-name').style.color = color;
                    
                    // Fondo sutil con el color
                    document.body.style.background = `linear-gradient(135deg, #0f172a 0%, ${color}15 100%)`;
                }

            } catch (error) {
                console.error('Error cargando branding:', error);
            }
        }

        // ============================================
        // 4. CARGAR CURSOS DEL ALUMNO (CORREGIDO POR NOMBRE)
        // ============================================
        async function loadStudentCourses() {
            const grid = document.getElementById('courses-grid');
            const noCourses = document.getElementById('no-courses');
            
            try {
                // 1. OBTENER DNI (Lógica Blindada)
                let dniDelAlumno = currentUser.user_metadata?.dni;
                
                // Si no está en metadata, buscar en perfil
                if (!dniDelAlumno) {
                    const { data: perfil } = await db
                        .from('perfiles')
                        .select('dni')
                        .eq('id', currentUser.id)
                        .maybeSingle();
                    if (perfil) dniDelAlumno = perfil.dni;
                }

                if (!dniDelAlumno) {
                    console.error("No se encontró DNI para el usuario");
                    grid.innerHTML = '';
                    noCourses.classList.remove('hidden');
                    return;
                }

                console.log("Buscando cursos para DNI:", dniDelAlumno);

                // 2. BUSCAR MATRÍCULAS (Traemos el nombre del curso)
                // Usamos 'dni_alumno' y 'curso' según tu tabla real
                const { data: matriculasAlumno, error: matError } = await db
                    .from('matriculas')
                    .select('curso, estado, registro_id, institution_id') 
                    .eq('dni_alumno', dniDelAlumno);

                if (matError) throw matError;

                // Si no tiene matrículas
                if (!matriculasAlumno || matriculasAlumno.length === 0) {
                    grid.innerHTML = '';
                    noCourses.classList.remove('hidden');
                    return;
                }

                // 3. EXTRAER LOS NOMBRES EXACTOS DE LOS CURSOS
                // Esto es clave: filtramos por nombre, no por ID de registro
                const nombresCursos = matriculasAlumno.map(m => m.curso);
                
                // 4. BUSCAR DETALLES EN CURSOS OFICIALES
                const { data: cursos, error: cursosError } = await db
                    .from('cursos_oficiales')
                    .select('id, nombre, imagen_portada_url, registro_id')
                    .in('nombre', nombresCursos); // ¡Conexión Correcta!
                    
                if (cursosError) throw cursosError;

                grid.innerHTML = '';
                
                if (!cursos || cursos.length === 0) {
                    console.warn("Hay matrículas pero no coinciden con cursos oficiales (Revisar nombres exactos)");
                    noCourses.classList.remove('hidden');
                    return;
                }

                noCourses.classList.add('hidden');
                
                // 5. RENDERIZAR TARJETAS
                cursos.forEach(curso => {
                    // Buscar la matrícula correspondiente a este curso específico
                    // Comparamos NOMBRE con NOMBRE
                    const matricula = matriculasAlumno.find(m => m.curso === curso.nombre);
                    const estado = matricula ? matricula.estado : 'SUSPENDIDO';
                    
                    // Imagen por defecto si viene null
                    const imagenCurso = curso.imagen_portada_url || 
                        'https://images.unsplash.com/photo-1516321318423-f06f85e504b3?q=80&w=800&auto=format&fit=crop';
                    
                    const isActive = estado === 'ACTIVO';
                    
                    const card = document.createElement('div');
                    card.className = `bg-slate-800 rounded-xl border border-white/5 overflow-hidden hover-lift transition-all duration-300 ${isActive ? 'cursor-pointer hover:border-indigo-500/50 shadow-lg hover:shadow-indigo-500/10' : 'opacity-75 grayscale'}`;
                    
                    card.innerHTML = `
                        <div class="h-48 relative overflow-hidden group">
                            <img src="${imagenCurso}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                            <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/20 to-transparent"></div>
                            
                            <div class="absolute top-3 right-3 ${isActive ? 'bg-emerald-500' : 'bg-red-500'} text-white text-[10px] px-2.5 py-1 rounded-full font-bold shadow-lg tracking-wide uppercase">
                                ${isActive ? 'Cursando' : estado}
                            </div>
                        </div>
                        
                        <div class="p-5">
                            <div class="mb-4">
                                <span class="text-[10px] font-bold text-indigo-400 uppercase tracking-wider bg-indigo-500/10 px-2 py-1 rounded">
                                    ${curso.registro_id || 'Curso'}
                                </span>
                            </div>
                            
                            <h3 class="font-bold text-white text-lg mb-2 line-clamp-2 leading-tight min-h-[3.5rem]">
                                ${curso.nombre}
                            </h3>
                            
                            <div class="mt-4 pt-4 border-t border-white/5">
                                ${isActive ? 
                                    `<button onclick="irAlAula('${curso.id}', '${curso.nombre}')" 
                                            class="w-full bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-bold py-3 rounded-xl transition-all shadow-lg shadow-indigo-900/20 flex items-center justify-center gap-2 group">
                                        <div class="bg-white/20 p-1 rounded-full group-hover:bg-white/30 transition">
                                            <i data-lucide="play" class="w-3 h-3 fill-current"></i>
                                        </div>
                                        Ingresar al Aula
                                    </button>` 
                                    :
                                    `<div class="w-full bg-slate-700/30 text-slate-400 text-sm font-medium py-3 rounded-xl text-center border border-slate-700/50 flex items-center justify-center gap-2">
                                        <i data-lucide="lock" class="w-4 h-4"></i> Acceso Restringido
                                    </div>`
                                }
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
                
                lucide.createIcons();

            } catch (error) {
                console.error('Error cargando cursos:', error);
                grid.innerHTML = '';
                noCourses.classList.remove('hidden');
                showError('Error técnico al cargar cursos');
            }
        }

        // ============================================
        // 5. FUNCIONES AUXILIARES
        // ============================================
        function irAlAula(cursoId, cursoNombre) {
            // Redirigir al aula.html en la misma carpeta student/
            window.location.href = `./aula.html?id=${cursoId}&curso=${encodeURIComponent(cursoNombre)}`;
        }

        async function logout() {
            // 1. Cerrar sesión en Supabase
            await db.auth.signOut();

            // 2. Limpiar TODA la memoria del navegador
            // Esto evita que el login detecte sesiones viejas
            localStorage.clear();
            sessionStorage.clear();

            // 3. Redirigir al login usando replace
            // window.location.replace impide que el alumno pueda volver atrás con la flecha del navegador
            window.location.replace('./login.html');
        }
        
        function generarDiploma() {
            // Función para generar diploma analítico
            alert('Funcionalidad de Diploma Analítico en desarrollo.\nPróximamente disponible.');
            // Aquí puedes implementar la lógica para generar PDFs o redirigir a otra página
        }

        function generarCarnet() {
            // Función para generar carnet digital
            alert('Funcionalidad de Carnet Digital en desarrollo.\nPróximamente disponible.');
            // Aquí puedes implementar la lógica para generar carnet o redirigir a otra página
        }

        function showError(message) {
            // Crear toast de error simple
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium z-50 animate-fade-in';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }
    </script>
</body>
</html>
