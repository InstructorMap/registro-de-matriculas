<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Virtual</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        /* Transición suave para el cambio de marca */
        .brand-transition { transition: background-color 0.5s ease, border-color 0.5s ease; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 flex h-screen overflow-hidden font-sans">

    <aside id="sidebar-panel" class="w-64 bg-slate-950 border-r border-slate-800 flex flex-col hidden md:flex brand-transition">
        
        <div class="p-6 h-24 flex items-center justify-center border-b border-white/10">
            <img id="brand-logo-img" src="" class="h-16 w-auto object-contain hidden transition-all duration-500">
            
            <h1 id="brand-text" class="font-bold text-xl tracking-wide text-white">
                ASARI <span class="text-xs text-blue-500">Campus</span>
            </h1>
        </div>
        
        <nav class="flex-1 p-4 space-y-2">
            <div class="px-4 py-3 bg-white/10 text-white rounded-xl border border-white/20 transition-all flex items-center gap-3">
                <i data-lucide="layout" class="w-5 h-5"></i>
                <span class="font-bold text-sm">Mis Cursos</span>
            </div>
            
            <div class="mt-auto pt-10">
                <div class="px-4 py-2 text-[10px] font-bold text-white/50 uppercase tracking-wider">Tu Cuenta</div>
                <div class="px-4 py-3 bg-black/20 rounded-lg border border-white/5 mx-2">
                    <p class="text-xs text-white/60 font-bold mb-1">DNI Vinculado:</p>
                    <p class="text-sm font-mono text-yellow-400 tracking-wider font-bold" id="user-dni">
                        <span class="animate-pulse">...</span>
                    </p>
                </div>
            </div>
        </nav>

        <div class="p-4 border-t border-white/10">
            <button onclick="logout()" class="flex items-center gap-2 text-white/60 hover:text-white transition text-xs font-bold uppercase w-full p-2 hover:bg-white/5 rounded-lg">
                <i data-lucide="log-out" class="w-4 h-4"></i> Cerrar Sesión
            </button>
        </div>
    </aside>

    <div class="flex-1 flex flex-col min-w-0">
        
        <header id="top-header" class="h-20 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-8 z-20 shadow-md brand-transition">
            <div>
                <h2 class="text-2xl font-black text-white tracking-tight" id="header-title">Mis Cursos</h2>
                <p class="text-xs text-slate-400 font-medium" id="header-subtitle">Panel de Estudiante</p>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="text-right hidden sm:block">
                    <p class="text-sm font-bold text-white" id="student-name">Cargando...</p>
                    <p class="text-[10px] text-green-400 font-bold uppercase flex justify-end items-center gap-1">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Online
                    </p>
                </div>
                <div id="user-avatar" class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center font-bold text-white shadow-lg border border-white/10">
                    <i data-lucide="user" class="w-5 h-5"></i>
                </div>
            </div>
        </header>

        <main class="flex-1 p-8 overflow-y-auto relative bg-slate-900" id="main-area">
            <div id="active-courses-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="col-span-3 text-center py-20">
                    <i data-lucide="loader-2" class="w-10 h-10 animate-spin mx-auto text-blue-500"></i>
                    <p class="text-slate-500 mt-4 text-sm animate-pulse">Sincronizando perfil...</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        const PROJECT_URL = 'https://vxggatcfrywyodovjwxj.supabase.co';
        const PUBLIC_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4Z2dhdGNmcnl3eW9kb3Zqd3hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzM5MjgsImV4cCI6MjA4MzgwOTkyOH0.RZ9jhEASO6nCV8EnzrHQBhglP4G1nik9Z5osPXysGNg';
        const db = supabase.createClient(PROJECT_URL, PUBLIC_KEY, { auth: { persistSession: true } });

        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            await iniciarDashboard();
        });

        async function iniciarDashboard() {
            try {
                // 1. Validar Sesión
                const { data: { session }, error: errSession } = await db.auth.getSession();
                if (errSession || !session) return window.location.href = '../campus.html';

                // 2. Cargar Perfil
                const { data: perfil, error: errPerfil } = await db.from('perfiles').select('*').eq('id', session.user.id).single();
                
                if (errPerfil) {
                    if (errPerfil.message.includes("aborted")) return setTimeout(() => window.location.reload(), 1000); // Retry
                    throw errPerfil;
                }

                if (perfil) {
                    document.getElementById('student-name').innerText = perfil.nombre_completo || "Alumno";
                    
                    if (perfil.dni) {
                        document.getElementById('user-dni').innerText = perfil.dni;
                        // AQUÍ ESTÁ LA CLAVE: Cargamos cursos Y Branding
                        await cargarCursosYBranding(perfil.dni);
                    } else {
                        mostrarBloqueoDNI(session.user.id);
                    }
                }

            } catch (e) {
                console.error("Error Dashboard:", e);
                // Manejo de error silencioso o visual si es crítico
                if(!e.message.includes("aborted")) {
                    document.getElementById('active-courses-grid').innerHTML = `<div class="col-span-3 text-center text-red-400 p-10">Error de conexión: ${e.message}</div>`;
                }
            }
        }

        // --- FUNCIÓN HÍBRIDA: Carga Cursos + Aplica Marca ---
        async function cargarCursosYBranding(dni) {
            const container = document.getElementById('active-courses-grid');

            // A. Buscar Matrículas (y de paso obtenemos el ID de institución)
            const { data: matriculas, error: errMat } = await db
                .from('matriculas')
                .select('curso, institution_id') // Pedimos también la institución
                .eq('dni_alumno', dni)
                .eq('estado', 'ACTIVO');

            if (errMat) throw errMat;

            if (!matriculas || matriculas.length === 0) {
                container.innerHTML = `
                <div class="col-span-3 text-center py-16 bg-white/5 rounded-2xl border border-dashed border-white/10">
                    <i data-lucide="book-x" class="w-12 h-12 text-slate-500 mx-auto mb-4"></i>
                    <h3 class="font-bold text-white">Sin cursos activos</h3>
                    <p class="text-slate-400 text-sm mt-1">El DNI ${dni} no tiene inscripciones.</p>
                </div>`;
                lucide.createIcons();
                return;
            }

            // --- B. APLICAR BRANDING (SAAS LOGIC) ---
            // Tomamos el ID de institución de la primera matrícula encontrada
            const instId = matriculas[0].institution_id;
            if (instId) {
                aplicarEstiloInstitucional(instId);
            }

            // C. Procesar Cursos (Usando la búsqueda flexible que arreglamos antes)
            const nombresCursos = matriculas.map(m => m.curso ? m.curso.trim() : "").filter(n => n !== "");
            
            // Usamos la función SQL 'buscar_cursos_flexible'
            const { data: cursos, error: errCur } = await db.rpc('buscar_cursos_flexible', { lista_nombres: nombresCursos });

            if (errCur) throw errCur;

            // D. Renderizar
            container.innerHTML = "";
            if (!cursos || cursos.length === 0) {
                 container.innerHTML = `<div class="col-span-3 text-center text-slate-500 p-10">Matriculado en: <b class="text-blue-400">${nombresCursos.join(", ")}</b><br>Pero no se encontró contenido oficial.</div>`;
                 return;
            }

            cursos.forEach(curso => {
                const cantModulos = curso.contenido ? curso.contenido.length : 0;
                const bgImg = curso.imagen_portada_url || 'https://images.unsplash.com/photo-1497633762265-9d179a990aa6?auto=format&fit=crop&q=80&w=400';

                // Tarjeta con diseño neutro oscuro
                const html = `
                <article class="bg-slate-800 rounded-2xl border border-slate-700 shadow-lg hover:border-white/30 transition-all overflow-hidden flex flex-col h-full group">
                    <div class="h-44 relative overflow-hidden bg-black">
                        <img src="${bgImg}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500 opacity-70 group-hover:opacity-100">
                        <div class="absolute top-3 right-3 bg-green-500 text-white text-[10px] font-bold px-2 py-1 rounded shadow">CURSANDO</div>
                    </div>
                    <div class="p-6 flex-1 flex flex-col">
                        <h3 class="font-bold text-white text-lg mb-2 leading-tight">${curso.nombre}</h3>
                        <p class="text-xs text-slate-400 mb-6 line-clamp-2">${curso.descripcion || 'Formación profesional.'}</p>
                        <div class="mt-auto pt-4 border-t border-slate-700 flex items-center justify-between">
                            <span class="text-xs font-bold text-slate-500 flex items-center gap-1"><i data-lucide="layers" class="w-3 h-3"></i> ${cantModulos} Módulos</span>
                            <a href="aula.html?id=${curso.id}" class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg text-xs font-bold transition flex items-center gap-2 border border-white/10">
                                Entrar <i data-lucide="arrow-right" class="w-3 h-3"></i>
                            </a>
                        </div>
                    </div>
                </article>`;
                container.innerHTML += html;
            });
            lucide.createIcons();
        }

        // --- FUNCIÓN QUIRÚRGICA DE MARCA ---
        async function aplicarEstiloInstitucional(instId) {
            try {
                const { data: inst } = await db.from('instituciones').select('*').eq('id', instId).single();
                if (!inst) return;

                console.log("Aplicando Branding:", inst.nombre);

                // 1. Cambiar Logos
                if (inst.logo_url) {
                    const logoImg = document.getElementById('brand-logo-img');
                    const textBrand = document.getElementById('brand-text');
                    
                    logoImg.src = inst.logo_url;
                    logoImg.classList.remove('hidden'); // Mostrar logo
                    textBrand.classList.add('hidden');  // Ocultar texto ASARI
                }

                // 2. Cambiar Colores (Sidebar y Header)
                if (inst.color_primario) {
                    const sidebar = document.getElementById('sidebar-panel');
                    const header = document.getElementById('top-header');
                    const avatar = document.getElementById('user-avatar');
                    
                    // Aplicar color primario
                    sidebar.style.backgroundColor = inst.color_primario;
                    sidebar.style.borderColor = "rgba(255,255,255,0.1)"; // Ajuste fino de borde
                    
                    // Header un poco más oscuro o igual
                    header.style.backgroundColor = inst.color_primario; 
                    // Opcional: header.style.filter = "brightness(0.9)"; // Un toque más oscuro
                    
                    avatar.style.backgroundColor = "rgba(255,255,255,0.2)";
                    
                    // Cambiar título de la página
                    if(inst.nombre) document.title = `Campus Virtual | ${inst.nombre}`;
                }

            } catch (e) {
                console.error("Error aplicando branding:", e);
                // Si falla, se queda con el estilo ASARI por defecto
            }
        }

        // --- VINCULACIÓN DE DNI ---
        function mostrarBloqueoDNI(userId) {
            const container = document.getElementById('active-courses-grid');
            document.getElementById('user-dni').innerText = "Pendiente";
            container.innerHTML = `
                <div class="col-span-3 bg-gradient-to-br from-blue-900 to-slate-900 border border-blue-500/30 rounded-2xl p-10 text-center max-w-lg mx-auto mt-10 shadow-2xl">
                    <i data-lucide="shield-check" class="w-12 h-12 text-blue-400 mx-auto mb-4"></i>
                    <h3 class="text-xl font-bold text-white mb-2">Validación de Alumno</h3>
                    <p class="text-slate-400 mb-6 text-sm">Ingresa tu DNI para sincronizar tus cursos y personalizar tu experiencia.</p>
                    <div class="flex gap-2">
                        <input type="text" id="input-dni-sync" placeholder="DNI sin puntos" class="flex-1 p-3 bg-black/30 border border-blue-500/50 rounded-lg outline-none font-bold text-center text-white focus:bg-black/50 transition">
                        <button onclick="guardarDNI('${userId}')" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold transition">Validar</button>
                    </div>
                    <p id="dni-error-msg" class="text-xs text-red-400 mt-4 hidden font-bold"></p>
                </div>`;
            lucide.createIcons();
        }

        async function guardarDNI(userId) {
            const input = document.getElementById('input-dni-sync');
            const errorMsg = document.getElementById('dni-error-msg');
            const dni = input.value.replace(/\./g, '').trim();

            errorMsg.classList.add('hidden');
            if(dni.length < 6) { errorMsg.innerText = "DNI inválido."; errorMsg.classList.remove('hidden'); return; }

            const { data } = await db.from('matriculas').select('id').eq('dni_alumno', dni);
            if(!data || data.length === 0) { errorMsg.innerText = "DNI no encontrado en el padrón."; errorMsg.classList.remove('hidden'); return; }

            await db.from('perfiles').update({ dni: dni }).eq('id', userId);
            window.location.reload();
        }

        async function logout() { await db.auth.signOut(); window.location.href = '../campus.html'; }
    </script>
</body>
</html>
