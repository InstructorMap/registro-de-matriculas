<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aula Virtual</title>
    <script src='https://meet.jit.si/external_api.js'></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> <style>
        /* Estilos Base */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        
        /* Animaciones */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .chat-bubble { animation: popIn 0.3s ease-out; }
        @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Utilidades */
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; background: black; border-radius: 12px; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 h-screen flex flex-col overflow-hidden font-sans">

    <header id="top-header" class="h-16 bg-slate-950 border-b border-slate-800 flex items-center justify-between px-4 md:px-6 shrink-0 z-20 transition-all duration-500">
        <div class="flex items-center gap-4">
            <a href="dashboard.html" class="p-2 hover:bg-white/10 rounded-lg transition text-slate-400 hover:text-white" title="Volver al Campus">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </a>
            <div class="flex items-center gap-3">
                <img id="header-logo" src="" class="h-8 w-8 object-contain hidden bg-white/10 rounded p-0.5">
                <div>
                    <h1 class="font-bold text-white text-sm md:text-lg leading-tight truncate max-w-[200px] md:max-w-md" id="course-title">Cargando Aula...</h1>
                    <p class="text-[10px] text-white/60 font-bold uppercase tracking-wider" id="inst-name-header">Campus Virtual</p>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="hidden md:block text-right">
                <p class="text-sm font-bold text-white" id="student-name">Estudiante</p>
                <div class="flex items-center justify-end gap-1.5">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <p class="text-[10px] text-green-400 font-bold uppercase">Conectado</p>
                </div>
            </div>
            <div id="user-avatar-ui" class="w-9 h-9 bg-white/10 rounded-full flex items-center justify-center font-bold text-white shadow-lg border border-white/10">
                <i data-lucide="user" class="w-4 h-4"></i>
            </div>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden relative">
        
        <main class="flex-1 flex flex-col min-w-0 bg-slate-900 relative z-10">
            <div class="flex-1 p-4 md:p-8 overflow-y-auto flex flex-col">
                <div class="w-full max-w-6xl mx-auto space-y-6 h-full flex flex-col">
                    
                    <div id="player-wrapper" class="w-full bg-black rounded-2xl shadow-2xl overflow-hidden border border-slate-800 relative aspect-video flex-shrink-0 flex items-center justify-center group">
                        <div id="player-placeholder" class="text-center p-8">
                            <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
                                <i data-lucide="loader-2" class="w-8 h-8 text-slate-600 animate-spin"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-500">Cargando contenido...</h3>
                        </div>
                        <div id="player-content" class="w-full h-full hidden"></div>
                    </div>

                    <div class="flex flex-col md:flex-row gap-4 justify-between items-start md:items-center pb-10 bg-slate-900 sticky bottom-0 z-20 py-4 border-t border-slate-800/50">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-1">
                                <h2 id="current-lesson-title" class="text-xl md:text-2xl font-bold text-white leading-tight">...</h2>
                                <span id="check-completed" class="hidden bg-green-500/20 text-green-400 text-[10px] px-2 py-0.5 rounded font-bold uppercase border border-green-500/30 flex items-center gap-1">
                                    <i data-lucide="check" class="w-3 h-3"></i> Completada
                                </span>
                            </div>
                            <button onclick="marcarComoCompletada()" id="btn-mark-done" class="text-xs font-bold text-slate-400 hover:text-white flex items-center gap-2 transition-colors cursor-pointer select-none">
                                <div class="w-4 h-4 border-2 border-slate-500 rounded-sm flex items-center justify-center group-hover:border-white transition-colors" id="btn-mark-icon"></div> 
                                Marcar como vista
                            </button>
                        </div>
                        <div class="flex gap-3 w-full md:w-auto">
                            <button id="btn-prev" class="flex-1 md:flex-none px-5 py-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold text-sm disabled:opacity-50 transition-all flex items-center justify-center gap-2" disabled>
                                <i data-lucide="chevron-left" class="w-4 h-4"></i> Anterior
                            </button>
                            <button id="btn-next" class="flex-1 md:flex-none px-5 py-2.5 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold text-sm shadow-lg disabled:opacity-50 transition-all flex items-center justify-center gap-2" disabled>
                                Siguiente <i data-lucide="chevron-right" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <aside class="w-80 bg-slate-950 border-l border-slate-800 flex flex-col shrink-0 overflow-hidden absolute md:relative right-0 h-full z-20 transition-transform transform translate-x-full md:translate-x-0" id="playlist-sidebar">
            <div class="p-4 border-b border-slate-800 bg-slate-950 sticky top-0 z-10">
                <h3 class="font-bold text-slate-300 text-xs uppercase tracking-wider flex items-center gap-2">
                    <i data-lucide="list" class="w-3 h-3"></i> Temario del Curso
                </h3>
                <div class="h-1.5 w-full bg-slate-800 rounded-full mt-3 overflow-hidden">
                    <div class="h-full bg-green-500 w-0 transition-all duration-500" id="progress-bar"></div>
                </div>
                <p class="text-[10px] text-slate-500 mt-1 text-right"><span id="progress-text">0%</span> Completado</p>
            </div>
            <div id="modules-list" class="flex-1 overflow-y-auto p-3 space-y-3 pb-20">
                 <p class="text-center text-slate-600 text-xs py-10"><i data-lucide="loader-2" class="w-5 h-5 animate-spin mx-auto mb-2"></i> Cargando...</p>
            </div>
        </aside>

        <button onclick="toggleMobileMenu()" class="md:hidden absolute bottom-6 right-6 z-30 bg-blue-600 text-white p-4 rounded-full shadow-xl">
            <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
        
        <button id="btn-tutor-toggle" onclick="toggleTutor()" class="fixed bottom-8 right-8 z-[100] group transition-all duration-300 hover:scale-110 cursor-pointer hidden md:block">
            <div class="relative">
                <div class="w-16 h-16 rounded-full bg-slate-900 p-1 shadow-2xl border-4 border-indigo-500 overflow-hidden relative z-10" id="tutor-btn-border">
                    <img id="tutor-btn-img" src="https://cdn-icons-png.flaticon.com/512/4712/4712009.png" class="w-full h-full object-contain bg-white rounded-full">
                </div>
                <div class="absolute bottom-0 right-0 w-4 h-4 bg-green-500 border-2 border-slate-900 rounded-full z-20 animate-pulse"></div>
            </div>
        </button>

        <div id="tutor-window" class="fixed bottom-28 right-4 md:right-8 z-[100] w-80 md:w-96 bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl flex flex-col hidden origin-bottom-right transform scale-95 opacity-0 h-[500px] transition-all duration-300">
            <div class="p-4 bg-gradient-to-r from-slate-900 to-slate-800 border-b border-slate-700 rounded-t-2xl flex justify-between items-center" id="tutor-header">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-white p-0.5 border border-white/10 overflow-hidden"><img id="tutor-header-img" src="https://cdn-icons-png.flaticon.com/512/4712/4712009.png" class="w-full h-full object-contain"></div>
                    <div>
                        <h3 class="font-bold text-white text-sm" id="tutor-name">Tutor Virtual</h3>
                        <p class="text-[10px] text-green-400 font-medium">Online ‚Ä¢ Contexto Activo</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="borrarHistorial()" class="text-slate-500 hover:text-red-400 p-1" title="Borrar Chat"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    <button onclick="toggleTutor()" class="text-slate-400 hover:text-white p-1"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
            </div>
            
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-900/95 text-sm">
                </div>
            
            <div class="px-3 py-2 bg-slate-950 flex gap-2 overflow-x-auto border-t border-slate-800 no-scrollbar">
                <button onclick="accionarTutor('quiz')" class="text-[10px] bg-slate-800 hover:bg-blue-600 text-blue-300 border border-slate-700 px-3 py-1.5 rounded-full whitespace-nowrap flex items-center gap-1 transition">üìù Hazme un Quiz</button>
                <button onclick="accionarTutor('resumen')" class="text-[10px] bg-slate-800 hover:bg-purple-600 text-purple-300 border border-slate-700 px-3 py-1.5 rounded-full whitespace-nowrap flex items-center gap-1 transition">‚ö° Resumir Clase</button>
                <button onclick="accionarTutor('explicar')" class="text-[10px] bg-slate-800 hover:bg-green-600 text-green-300 border border-slate-700 px-3 py-1.5 rounded-full whitespace-nowrap flex items-center gap-1 transition">üí° Explicar Sencillo</button>
            </div>
            
            <div class="p-3 bg-slate-950 border-t border-slate-800 rounded-b-2xl">
                <form id="chat-form" class="flex gap-2 relative" onsubmit="enviarMensajeTutor(event)">
                    <input type="text" id="chat-input" class="flex-1 bg-slate-900 border border-slate-700 rounded-xl pl-4 pr-10 py-3 text-sm text-white focus:outline-none focus:border-indigo-500 transition shadow-inner" placeholder="Pregunta sobre la clase..." autocomplete="off">
                    <button type="submit" class="absolute right-4 top-1/2 -translate-y-1/2 text-indigo-500 hover:text-indigo-400"><i data-lucide="send-horizontal" class="w-5 h-5"></i></button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const PROJECT_URL = 'https://vxggatcfrywyodovjwxj.supabase.co';
        const PUBLIC_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4Z2dhdGNmcnl3eW9kb3Zqd3hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzM5MjgsImV4cCI6MjA4MzgwOTkyOH0.RZ9jhEASO6nCV8EnzrHQBhglP4G1nik9Z5osPXysGNg';
        const db = supabase.createClient(PROJECT_URL, PUBLIC_KEY);

        // Variables Globales
        let flatLessons = [];
        let currentLessonIndex = -1;
        let completedLessons = new Set();
        let currentCourseId = null;
        let currentUserId = null;
        let institutionContext = ""; // Dossier de la instituci√≥n
        let areaContext = ""; // Dossier del √°rea
        let isChatOpen = false;

        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            
            // 1. Verificar Sesi√≥n
            const { data: { session } } = await db.auth.getSession();
            if(!session) return window.location.href = 'index.html'; // Vuelta al Login
            currentUserId = session.user.id;
            
            // 2. Cargar Perfil
            const { data: perfil } = await db.from('perfiles').select('nombre_completo').eq('id', currentUserId).single();
            if(perfil) document.getElementById('student-name').innerText = perfil.nombre_completo;

            // 3. Obtener Curso de URL
            const params = new URLSearchParams(window.location.search);
            currentCourseId = params.get('id');
            const cursoNombre = params.get('curso');

            if(currentCourseId) {
                // Prioridad ID oficial (si viene del dashboard)
                if (currentCourseId === 'general' && cursoNombre) {
                    // Fallback para cursos viejos sin ID en tabla
                    alert("Est√°s accediendo a un curso antiguo. Algunas funciones IA pueden estar limitadas.");
                    // Aqu√≠ podr√≠as cargar una estructura gen√©rica si quisieras
                    window.location.href = 'dashboard.html';
                } else {
                    await cargarCurso(currentCourseId);
                }
            } else {
                window.location.href = 'dashboard.html';
            }
        });

        // --- CARGA DEL CURSO Y CONTEXTO ---
        async function cargarCurso(id) {
            // Buscamos curso + √°rea + instituci√≥n (JOIN Triple virtual)
            const { data: curso, error } = await db.from('cursos_oficiales').select('*, areas(*), instituciones(*)').eq('id', id).single();
            
            if(error || !curso) {
                alert("No se pudo cargar el contenido del curso.");
                return window.location.href = 'dashboard.html';
            }

            // A. Pintar Datos B√°sicos
            document.getElementById('course-title').innerText = curso.nombre;
            
            // B. Aplicar Identidad (Institution)
            if (curso.instituciones) {
                const inst = curso.instituciones;
                document.getElementById('inst-name-header').innerText = inst.nombre;
                
                if (inst.color_primario) {
                    const color = inst.color_primario;
                    document.getElementById('top-header').style.backgroundColor = color;
                    document.getElementById('tutor-header').style.background = `linear-gradient(to right, ${color}, #1e293b)`;
                    document.getElementById('tutor-btn-border').style.borderColor = color;
                }
                
                if (inst.logo_url) {
                    const logo = document.getElementById('header-logo');
                    logo.src = inst.logo_url;
                    logo.classList.remove('hidden');
                    
                    document.getElementById('tutor-header-img').src = inst.logo_url;
                    document.getElementById('tutor-btn-img').src = inst.logo_url;
                }
                
                // C. Cargar Dossier Institucional (Para la IA)
                // (En un sistema real, guardar√≠as el dossier en la tabla instituciones. 
                //  Aqu√≠ usaremos el nombre como placeholder si no hay campo dossier)
                institutionContext = `Instituci√≥n: ${inst.nombre}.`;
            }

            // D. Cargar Contexto de √Årea (Para la IA)
            if (curso.areas) {
                areaContext = curso.areas.dossier_txt || "";
                if(curso.areas.prompt_especifico) {
                    // Personalizar saludo del bot si hay prompt
                    document.getElementById('tutor-name').innerText = "Tutor Especializado";
                }
            }

            // E. Cargar Progreso del Alumno
            const { data: progreso } = await db.from('progreso_alumnos')
                .select('clases_vistas')
                .eq('student_id', currentUserId)
                .eq('curso_id', id)
                .single();
                
            if(progreso && progreso.clases_vistas) {
                completedLessons = new Set(progreso.clases_vistas);
            }

            // F. Renderizar Clases
            renderizarTemario(curso.contenido);
            
            // G. Ir a la √∫ltima clase vista (o la primera sin ver)
            let targetIndex = 0;
            for(let i=0; i<flatLessons.length; i++) {
                if(!completedLessons.has(flatLessons[i].uniqueId)) {
                    targetIndex = i;
                    break;
                }
            }
            // Si termin√≥ todo, ir a la √∫ltima
            if(completedLessons.size === flatLessons.length && flatLessons.length > 0) targetIndex = flatLessons.length - 1;
            
            cargarClase(targetIndex);
            
            // H. Mensaje inicial del Bot
            agregarBurbujaTutor(`¬°Hola! Soy tu tutor de <b>${curso.nombre}</b>. Estoy conectado a la base de conocimiento de la instituci√≥n para ayudarte.`, 'bot');
        }

        // --- RENDERIZADO DE CLASES ---
        function renderizarTemario(modulos) {
            const container = document.getElementById('modules-list');
            container.innerHTML = "";
            flatLessons = [];

            if (!modulos) return;

            modulos.forEach((mod, modIdx) => {
                const modDiv = document.createElement('div');
                modDiv.className = "space-y-1 mb-4";
                modDiv.innerHTML = `<div class="px-3 py-2 bg-slate-900/50 rounded-lg text-[10px] font-bold text-slate-400 uppercase tracking-wider border border-slate-800/50">${mod.titulo}</div><div class="space-y-1 pl-1" id="mod-content-${modIdx}"></div>`;
                container.appendChild(modDiv);

                if(mod.lecciones) {
                    mod.lecciones.forEach((lec, lecIdx) => {
                        const idx = flatLessons.length;
                        const uniqueId = `${modIdx}-${lecIdx}`;
                        flatLessons.push({ ...lec, modIdx, uniqueId });

                        const btn = document.createElement('button');
                        btn.id = `btn-lec-${idx}`;
                        const isCompleted = completedLessons.has(uniqueId);
                        
                        btn.className = `w-full text-left px-3 py-3 rounded-lg flex items-center justify-between text-xs transition-all border border-transparent group ${isCompleted ? 'text-green-400' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`;
                        
                        let icon = 'play-circle';
                        if(lec.tipo === 'PDF') icon = 'file-text';
                        if(lec.tipo === 'LIVE' || lec.tipo === 'ZOOM') icon = 'video';

                        const leftIcon = isCompleted ? `<i data-lucide="check-circle-2" class="w-4 h-4 text-green-500"></i>` : `<i data-lucide="${icon}" class="w-4 h-4 opacity-50 group-hover:opacity-100"></i>`;

                        btn.innerHTML = `<div class="flex items-center gap-3 overflow-hidden"><span class="shrink-0">${leftIcon}</span> <span class="truncate font-medium">${lec.titulo}</span></div>`;
                        btn.onclick = () => cargarClase(idx);
                        modDiv.querySelector(`#mod-content-${modIdx}`).appendChild(btn);
                    });
                }
            });
            lucide.createIcons();
            actualizarBarraGlobal();
        }

        function cargarClase(index) {
            if(index < 0 || index >= flatLessons.length) return;
            
            // UI Update
            document.querySelectorAll('[id^="btn-lec-"]').forEach(b => b.classList.remove('bg-blue-600/20', 'border-blue-500/30'));
            const activeBtn = document.getElementById(`btn-lec-${index}`);
            if(activeBtn) activeBtn.classList.add('bg-blue-600/20', 'border-blue-500/30');

            currentLessonIndex = index;
            const lec = flatLessons[index];
            document.getElementById('current-lesson-title').innerText = lec.titulo;
            actualizarBotonCompletado(completedLessons.has(lec.uniqueId));

            // Content Loader
            const container = document.getElementById('player-content');
            const placeholder = document.getElementById('player-placeholder');
            container.innerHTML = "";
            
            placeholder.classList.add('hidden');
            container.classList.remove('hidden');

            if(lec.tipo === 'VIDEO') {
                let url = lec.url || "";
                if(url.includes('youtu')) {
                    const videoId = url.split('v=')[1] || url.split('/').pop().split('?')[0];
                    container.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1" class="w-full h-full" frameborder="0" allowfullscreen></iframe>`;
                } else {
                    container.innerHTML = `<video src="${url}" controls class="w-full h-full bg-black"></video>`;
                }
            } 
            else if (lec.tipo === 'PDF') {
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-center p-10 bg-slate-900 w-full"><i data-lucide="file-text" class="w-16 h-16 text-red-500 mb-4"></i><h3 class="text-xl font-bold text-white mb-2">Lectura Obligatoria</h3><a href="${lec.url}" target="_blank" onclick="marcarComoCompletada()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-bold flex gap-2 transition"><i data-lucide="download" class="w-4 h-4"></i> Abrir Documento</a></div>`;
                lucide.createIcons();
            }

            updateNavButtons();
            
            // En m√≥vil, cerrar men√∫ lateral al elegir
            if(window.innerWidth < 768) document.getElementById('playlist-sidebar').classList.add('translate-x-full');
        }

        async function marcarComoCompletada() {
            if(currentLessonIndex === -1) return;
            const lec = flatLessons[currentLessonIndex];

            // Si ya estaba, solo avanzar
            if(completedLessons.has(lec.uniqueId)) {
                if(currentLessonIndex < flatLessons.length - 1) cargarClase(currentLessonIndex + 1);
                return;
            }

            completedLessons.add(lec.uniqueId);
            actualizarBotonCompletado(true);
            
            // Actualizar visualmente la lista
            const btn = document.getElementById(`btn-lec-${currentLessonIndex}`);
            if(btn) {
                btn.classList.remove('text-slate-400');
                btn.classList.add('text-green-400');
                btn.querySelector('span:first-child').innerHTML = `<i data-lucide="check-circle-2" class="w-4 h-4 text-green-500"></i>`;
                lucide.createIcons();
            }
            actualizarBarraGlobal();

            // Guardar en DB
            await db.from('progreso_alumnos').upsert({ 
                student_id: currentUserId, 
                curso_id: currentCourseId, 
                clases_vistas: Array.from(completedLessons),
                updated_at: new Date().toISOString()
            }, { onConflict: 'student_id, curso_id' });

            // Auto-avance
            setTimeout(() => {
                if(currentLessonIndex < flatLessons.length - 1) cargarClase(currentLessonIndex + 1);
            }, 800);
        }

        function actualizarBotonCompletado(isDone) {
            const btn = document.getElementById('btn-mark-done');
            const badge = document.getElementById('check-completed');
            if(isDone) {
                badge.classList.remove('hidden');
                btn.innerHTML = `<span class="text-green-400 flex items-center gap-1">Siguiente Lecci√≥n <i data-lucide="arrow-right" class="w-3 h-3"></i></span>`;
            } else {
                badge.classList.add('hidden');
                btn.innerHTML = `<div class="w-4 h-4 border-2 border-slate-500 rounded-sm flex items-center justify-center mr-2"></div> Marcar como vista`;
            }
        }

        function actualizarBarraGlobal() {
            if(flatLessons.length === 0) return;
            const percent = Math.round((completedLessons.size / flatLessons.length) * 100);
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-text').innerText = `${percent}%`;
        }

        function updateNavButtons() {
            document.getElementById('btn-prev').disabled = currentLessonIndex <= 0;
            document.getElementById('btn-next').disabled = currentLessonIndex >= flatLessons.length - 1;
            document.getElementById('btn-prev').onclick = () => cargarClase(currentLessonIndex - 1);
            document.getElementById('btn-next').onclick = () => cargarClase(currentLessonIndex + 1);
        }

        // --- L√ìGICA TUTOR IA (GEMINI) ---
        function toggleTutor() {
            const win = document.getElementById('tutor-window');
            isChatOpen = !isChatOpen;
            if(isChatOpen) {
                win.classList.remove('hidden');
                requestAnimationFrame(() => {
                    win.classList.remove('scale-95', 'opacity-0');
                    document.getElementById('chat-input').focus();
                });
            } else {
                win.classList.add('scale-95', 'opacity-0');
                setTimeout(() => win.classList.add('hidden'), 300);
            }
        }

        function toggleMobileMenu() {
            document.getElementById('playlist-sidebar').classList.toggle('translate-x-full');
        }

        async function enviarMensajeTutor(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;

            agregarBurbujaTutor(text, 'user');
            input.value = "";

            // Contexto Din√°mico
            const leccionActual = document.getElementById('current-lesson-title').innerText;
            const prompt = `
            ROL: Eres un tutor experto de la instituci√≥n.
            CONTEXTO INSTITUCIONAL: ${institutionContext}
            CONTEXTO DEL √ÅREA: ${areaContext}
            CLASE ACTUAL: ${leccionActual}
            PREGUNTA DEL ALUMNO: "${text}"
            
            Instrucciones: Responde de forma pedag√≥gica, breve y alentadora. Usa formato Markdown.
            `;

            consultarGemini(prompt);
        }

        async function consultarGemini(prompt) {
            const loadingId = mostrarLoading();
            
            try {
                const { data: secret } = await db.from('app_secrets').select('value').eq('name', 'gemini_api_key').single();
                if(!secret) throw new Error("Falta configuraci√≥n de IA.");

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite:generateContent?key=${secret.value}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                removerLoading(loadingId);
                
                const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "Lo siento, no pude procesar eso.";
                agregarBurbujaTutor(marked.parse(reply), 'bot');

            } catch(e) {
                removerLoading(loadingId);
                agregarBurbujaTutor("‚ö†Ô∏è Error de conexi√≥n con el Tutor.", 'bot');
            }
        }

        function agregarBurbujaTutor(htmlContent, type) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            
            if (type === 'user') {
                div.className = "flex gap-3 flex-row-reverse chat-bubble";
                div.innerHTML = `<div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center shrink-0"><i data-lucide="user" class="w-4 h-4 text-slate-300"></i></div><div class="bg-blue-600 text-white text-sm p-3 rounded-2xl rounded-tr-none shadow-md max-w-[85%]">${htmlContent}</div>`;
            } else {
                div.className = "flex gap-3 chat-bubble";
                div.innerHTML = `<div class="w-8 h-8 rounded-full bg-white overflow-hidden shrink-0 border border-indigo-500 mt-1 p-0.5"><img src="${document.getElementById('tutor-header-img').src}" class="w-full h-full object-contain"></div><div class="bg-slate-800 text-slate-200 text-sm p-3 rounded-2xl rounded-tl-none border border-slate-700 shadow-md max-w-[90%] prose prose-invert prose-sm leading-snug">${htmlContent}</div>`;
            }
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            lucide.createIcons();
        }

        function mostrarLoading() {
            const container = document.getElementById('chat-messages');
            const id = 'load-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex gap-3 chat-bubble";
            div.innerHTML = `<div class="w-8 h-8 rounded-full bg-white overflow-hidden shrink-0 border border-indigo-500 mt-1 p-0.5"><img src="${document.getElementById('tutor-header-img').src}" class="w-full h-full object-contain"></div><div class="bg-slate-800 p-4 rounded-2xl rounded-tl-none border border-slate-700 flex gap-1 items-center h-10"><span class="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-bounce"></span><span class="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-bounce delay-100"></span><span class="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-bounce delay-200"></span></div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return id;
        }

        function removerLoading(id) {
            const el = document.getElementById(id);
            if(el) el.remove();
        }

        function borrarHistorial() {
            document.getElementById('chat-messages').innerHTML = "";
            agregarBurbujaTutor("Historial borrado. ¬øEn qu√© te ayudo?", 'bot');
        }

        function accionarTutor(accion) {
            const leccion = document.getElementById('current-lesson-title').innerText;
            if(accion === 'quiz') {
                agregarBurbujaTutor('Hazme un examen r√°pido.', 'user');
                consultarGemini(`Genera un examen corto de 3 preguntas multiple choice sobre: "${leccion}". Formato Markdown. Pon las respuestas correctas ocultas al final.`);
            } else if (accion === 'resumen') {
                agregarBurbujaTutor('Resumir esta clase.', 'user');
                consultarGemini(`Dame los 3 puntos clave m√°s importantes de: "${leccion}".`);
            } else if (accion === 'explicar') {
                agregarBurbujaTutor('Expl√≠came esto como si tuviera 10 a√±os.', 'user');
                consultarGemini(`Explica el concepto principal de "${leccion}" con una analog√≠a simple.`);
            }
        }
    </script>
</body>
</html>
