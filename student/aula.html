<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aula Virtual - ASARI</title>
    <script src='https://meet.jit.si/external_api.js'></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; background: black; border-radius: 12px; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        
        /* Animaciones del Chat */
        #tutor-window { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .chat-bubble { animation: popIn 0.3s ease-out; }
        @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 h-screen flex flex-col overflow-hidden font-sans">

    <header class="h-16 bg-slate-950 border-b border-slate-800 flex items-center justify-between px-4 md:px-6 shrink-0 z-20">
        <div class="flex items-center gap-4">
            <a href="dashboard.html" class="p-2 hover:bg-slate-800 rounded-lg transition text-slate-400 hover:text-white"><i data-lucide="arrow-left" class="w-5 h-5"></i></a>
            <div>
                <h1 class="font-bold text-white text-sm md:text-lg leading-tight truncate max-w-[200px] md:max-w-md" id="course-title">Cargando...</h1>
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Campus Virtual</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="hidden md:block text-right">
                <p class="text-sm font-bold text-white" id="student-name">Estudiante</p>
                <div class="flex items-center justify-end gap-1.5"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span><p class="text-[10px] text-green-500 font-bold uppercase">En L√≠nea</p></div>
            </div>
            <div class="w-9 h-9 bg-blue-600 rounded-full flex items-center justify-center font-bold text-white shadow-lg"><i data-lucide="user" class="w-4 h-4"></i></div>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden relative">
        <main class="flex-1 flex flex-col min-w-0 bg-slate-900 relative z-10">
            <div class="flex-1 p-4 md:p-8 overflow-y-auto flex flex-col">
                <div class="w-full max-w-6xl mx-auto space-y-6 h-full flex flex-col">
                    
                    <div id="player-wrapper" class="w-full bg-black rounded-2xl shadow-2xl overflow-hidden border border-slate-800 relative aspect-video flex-shrink-0 flex items-center justify-center">
                        <div id="player-placeholder" class="text-center p-8">
                            <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse"><i data-lucide="play" class="w-8 h-8 text-slate-600 pl-1"></i></div>
                            <h3 class="text-xl font-bold text-slate-500">Selecciona una clase</h3>
                        </div>
                        <div id="player-content" class="w-full h-full hidden"></div>
                        
                        <div id="jitsi-rescue" class="hidden absolute top-4 right-4 z-50">
                            <a id="jitsi-external-link" href="#" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold px-4 py-2 rounded-full shadow-lg flex items-center gap-2 transition-all opacity-50 hover:opacity-100"><i data-lucide="external-link" class="w-3 h-3"></i> Abrir Sala en Nueva Pesta√±a</a>
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row gap-4 justify-between items-start md:items-center pb-10">
                        <div>
                            <h2 id="current-lesson-title" class="text-xl md:text-2xl font-bold text-white leading-tight">Bienvenido</h2>
                            <p class="text-slate-500 text-sm mt-1">Selecciona un m√≥dulo del men√∫.</p>
                        </div>
                        <div class="flex gap-3 w-full md:w-auto">
                            <button id="btn-prev" class="flex-1 md:flex-none px-5 py-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold text-sm disabled:opacity-50 transition-all flex items-center justify-center gap-2" disabled><i data-lucide="chevron-left" class="w-4 h-4"></i> Anterior</button>
                            <button id="btn-next" class="flex-1 md:flex-none px-5 py-2.5 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold text-sm shadow-lg disabled:opacity-50 transition-all flex items-center justify-center gap-2" disabled>Siguiente <i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <aside class="w-80 bg-slate-950 border-l border-slate-800 flex flex-col shrink-0 overflow-hidden absolute md:relative right-0 h-full z-20 transition-transform transform translate-x-full md:translate-x-0" id="playlist-sidebar">
            <div class="p-4 border-b border-slate-800 bg-slate-950 sticky top-0 z-10">
                <h3 class="font-bold text-slate-300 text-xs uppercase tracking-wider flex items-center gap-2"><i data-lucide="list" class="w-3 h-3"></i> Contenido</h3>
                <div class="h-1.5 w-full bg-slate-800 rounded-full mt-3 overflow-hidden"><div class="h-full bg-blue-500 w-0 transition-all duration-500" id="progress-bar"></div></div>
                <p class="text-[10px] text-slate-500 mt-1 text-right" id="progress-text">0%</p>
            </div>
            <div id="modules-list" class="flex-1 overflow-y-auto p-3 space-y-3">
                 <p class="text-center text-slate-600 text-xs py-10"><i data-lucide="loader-2" class="w-5 h-5 animate-spin mx-auto mb-2"></i> Cargando...</p>
            </div>
        </aside>

        <button onclick="toggleMobileMenu()" class="md:hidden absolute bottom-6 right-6 z-50 bg-blue-600 text-white p-4 rounded-full shadow-xl"><i data-lucide="menu" class="w-6 h-6"></i></button>

        <button onclick="toggleTutor()" class="fixed bottom-6 right-20 md:right-6 z-50 bg-gradient-to-r from-purple-600 to-pink-600 text-white p-3 rounded-full shadow-2xl hover:scale-105 transition-transform flex items-center gap-2 group border border-white/10">
            <i data-lucide="sparkles" class="w-6 h-6"></i>
            <span class="max-w-0 overflow-hidden group-hover:max-w-xs transition-all duration-500 text-xs font-bold whitespace-nowrap">Tutor IA</span>
        </button>

        <div id="tutor-window" class="fixed bottom-20 right-4 md:right-6 z-50 w-80 md:w-96 bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl flex flex-col hidden origin-bottom-right transform scale-95 opacity-0 h-[450px]">
            
            <div class="p-3 bg-slate-950 border-b border-slate-800 rounded-t-2xl flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-purple-600 rounded-lg flex items-center justify-center"><i data-lucide="bot" class="w-5 h-5 text-white"></i></div>
                    <div>
                        <h3 class="font-bold text-white text-xs">Tutor Inteligente</h3>
                        <p class="text-[10px] text-green-400">Impulsado por Gemini</p>
                    </div>
                </div>
                <button onclick="toggleTutor()" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>

            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-900">
                <div class="flex gap-3">
                    <div class="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center shrink-0 mt-1"><i data-lucide="bot" class="w-3 h-3 text-white"></i></div>
                    <div class="bg-slate-800 text-slate-200 text-xs p-3 rounded-r-xl rounded-bl-xl border border-slate-700 chat-bubble">
                        ¬°Hola! Soy tu tutor personal. Puedo explicarte conceptos de la clase actual o generarte un examen r√°pido. ¬øQu√© necesitas? ü§ñ
                    </div>
                </div>
            </div>

            <div class="px-3 py-2 bg-slate-900 flex gap-2 overflow-x-auto border-t border-slate-800/50">
                <button onclick="accionarTutor('quiz')" class="text-[10px] bg-blue-600/10 hover:bg-blue-600/30 text-blue-300 border border-blue-500/20 px-3 py-1 rounded-full whitespace-nowrap flex items-center gap-1 transition">
                    <i data-lucide="graduation-cap" class="w-3 h-3"></i> Tomar Examen
                </button>
                <button onclick="accionarTutor('resumen')" class="text-[10px] bg-purple-600/10 hover:bg-purple-600/30 text-purple-300 border border-purple-500/20 px-3 py-1 rounded-full whitespace-nowrap flex items-center gap-1 transition">
                    <i data-lucide="file-text" class="w-3 h-3"></i> Resumir Clase
                </button>
            </div>

            <div class="p-3 bg-slate-950 border-t border-slate-800 rounded-b-2xl">
                <form id="chat-form" class="flex gap-2" onsubmit="enviarMensajeTutor(event)">
                    <input type="text" id="chat-input" class="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-white focus:outline-none focus:border-purple-500" placeholder="Pregunta algo sobre el tema..." autocomplete="off">
                    <button type="submit" class="bg-purple-600 hover:bg-purple-500 text-white p-2 rounded-lg transition"><i data-lucide="send" class="w-4 h-4"></i></button>
                </form>
            </div>
        </div>
        </div>

    <script>
        const PROJECT_URL = 'https://vxggatcfrywyodovjwxj.supabase.co';
        const PUBLIC_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4Z2dhdGNmcnl3eW9kb3Zqd3hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzM5MjgsImV4cCI6MjA4MzgwOTkyOH0.RZ9jhEASO6nCV8EnzrHQBhglP4G1nik9Z5osPXysGNg';
        const db = supabase.createClient(PROJECT_URL, PUBLIC_KEY);
        let flatLessons = [], currentLessonIndex = -1, jitsiApi = null;

        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            const { data: { session } } = await db.auth.getSession();
            if(!session) return window.location.href = '../index.html';
            
            const { data: perfil } = await db.from('perfiles').select('nombre_completo').eq('id', session.user.id).single();
            if(perfil) document.getElementById('student-name').innerText = perfil.nombre_completo;

            const params = new URLSearchParams(window.location.search);
            const cursoId = params.get('id');
            if(cursoId) await cargarCurso(cursoId);
            else window.location.href = 'dashboard.html';
        });

        async function cargarCurso(id) {
            const { data, error } = await db.from('cursos_oficiales').select('*').eq('id', id).single();
            if(!error) { document.getElementById('course-title').innerText = data.nombre; renderizarTemario(data.contenido); }
        }

        function renderizarTemario(modulos) {
            const container = document.getElementById('modules-list');
            container.innerHTML = ""; flatLessons = [];
            if(!modulos || !modulos.length) { container.innerHTML = `<p class="text-center text-slate-500 text-xs mt-4">Sin contenido.</p>`; return; }
            
            modulos.forEach((mod, modIdx) => {
                const modDiv = document.createElement('div');
                modDiv.className = "space-y-1";
                modDiv.innerHTML = `<div class="px-3 py-2 bg-slate-900/50 rounded-lg text-[10px] font-bold text-slate-400 uppercase tracking-wider border border-slate-800/50">${mod.titulo}</div><div class="space-y-1 pl-1" id="mod-content-${modIdx}"></div>`;
                container.appendChild(modDiv);
                
                if(mod.lecciones) mod.lecciones.forEach(lec => {
                    const idx = flatLessons.length;
                    flatLessons.push({ ...lec, modIdx });
                    const btn = document.createElement('button');
                    btn.id = `btn-lec-${idx}`;
                    btn.className = "w-full text-left px-3 py-3 rounded-lg flex items-center gap-3 text-xs text-slate-400 hover:bg-slate-800 hover:text-white transition-all border border-transparent";
                    
                    let icon = 'play-circle', color = 'text-blue-500';
                    if(lec.tipo === 'PDF') { icon = 'file-text'; color = 'text-red-500'; }
                    if(lec.tipo === 'LIVE') { icon = 'radio'; color = 'text-purple-500'; }
                    if(lec.tipo === 'ZOOM') { icon = 'video-off'; color = 'text-cyan-500'; }

                    btn.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4 ${color} shrink-0"></i> <span class="truncate font-medium">${lec.titulo}</span>`;
                    btn.onclick = () => cargarClase(idx);
                    modDiv.querySelector(`#mod-content-${modIdx}`).appendChild(btn);
                });
            });
            lucide.createIcons();
            if(flatLessons.length > 0) cargarClase(0);
        }

        function cargarClase(index) {
            if(jitsiApi) { jitsiApi.dispose(); jitsiApi = null; }
            const container = document.getElementById('player-content');
            document.getElementById('player-placeholder').classList.add('hidden');
            document.getElementById('jitsi-rescue').classList.add('hidden');
            container.innerHTML = ""; container.classList.remove('hidden');

            document.querySelectorAll('[id^="btn-lec-"]').forEach(b => b.classList.remove('bg-blue-600', 'text-white', 'shadow-md'));
            document.getElementById(`btn-lec-${index}`).classList.add('bg-blue-600', 'text-white', 'shadow-md');

            currentLessonIndex = index;
            const lec = flatLessons[index];
            document.getElementById('current-lesson-title').innerText = lec.titulo;

            // L√≥gica de Tipos
            if(lec.tipo === 'VIDEO') {
                let url = lec.url || "";
                if(url.includes('youtu')) {
                    const videoId = url.split('v=')[1] || url.split('/').pop().split('?')[0];
                    container.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1" class="w-full h-full" frameborder="0" allowfullscreen></iframe>`;
                } else container.innerHTML = `<video src="${url}" controls autoplay class="w-full h-full bg-black"></video>`;
            } 
            else if (lec.tipo === 'PDF') {
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-center p-10 bg-slate-900 w-full"><i data-lucide="file-text" class="w-16 h-16 text-red-500 mb-4"></i><h3 class="text-xl font-bold text-white mb-2">Documento PDF</h3><a href="${lec.url}" target="_blank" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-bold flex gap-2"><i data-lucide="download" class="w-4 h-4"></i> Descargar PDF</a></div>`;
                lucide.createIcons();
            }
            else if (lec.tipo === 'ZOOM') {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center p-10 bg-slate-900 w-full relative">
                        <div class="absolute inset-0 bg-blue-900/10"></div>
                        <div class="z-10 bg-slate-800 p-8 md:p-10 rounded-2xl border border-slate-700 shadow-2xl max-w-lg w-full">
                            <div class="w-16 h-16 md:w-20 md:h-20 bg-blue-500/10 text-blue-400 rounded-full flex items-center justify-center mx-auto mb-6"><i data-lucide="video" class="w-8 h-8 md:w-10 md:h-10"></i></div>
                            <h3 class="text-xl md:text-2xl font-bold text-white mb-2">Clase en Plataforma Externa</h3>
                            <p class="text-slate-400 text-sm md:text-base mb-8">Esta clase se dictar√° mediante Zoom o Google Meet.</p>
                            <a href="${lec.url}" target="_blank" class="w-full bg-blue-600 hover:bg-blue-500 text-white text-base md:text-lg py-3 md:py-4 rounded-xl font-bold transition flex items-center justify-center gap-3 shadow-lg shadow-blue-900/50">üöÄ Abrir Reuni√≥n Ahora</a>
                        </div>
                    </div>`;
                lucide.createIcons();
            }
            else if (lec.tipo === 'LIVE') {
                const meetUrl = `https://meet.jit.si/${lec.url}`;
                document.getElementById('jitsi-external-link').href = meetUrl;
                document.getElementById('jitsi-rescue').classList.remove('hidden');
                
                const options = { 
                    roomName: lec.url, 
                    width: '100%', 
                    height: '100%', 
                    parentNode: container, 
                    lang: 'es', 
                    configOverwrite: { startWithAudioMuted: true, startWithVideoMuted: true, prejoinPageEnabled: false }, 
                    userInfo: { displayName: document.getElementById('student-name').innerText } 
                };
                jitsiApi = new JitsiMeetExternalAPI('meet.jit.si', options);
            }
            
            updateNavButtons();
            const percent = Math.round(((currentLessonIndex + 1) / flatLessons.length) * 100);
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-text').innerText = `${percent}%`;
            
            if(window.innerWidth < 768) document.getElementById('playlist-sidebar').classList.add('translate-x-full');
        }

        function updateNavButtons() {
            document.getElementById('btn-prev').disabled = currentLessonIndex <= 0;
            document.getElementById('btn-next').disabled = currentLessonIndex >= flatLessons.length - 1;
            document.getElementById('btn-prev').onclick = () => cargarClase(currentLessonIndex - 1);
            document.getElementById('btn-next').onclick = () => cargarClase(currentLessonIndex + 1);
        }

        function toggleMobileMenu() {
            document.getElementById('playlist-sidebar').classList.toggle('translate-x-full');
        }

        /* ============================================== */
        /* LOGICA DEL TUTOR IA (GEMINI)          */
        /* ============================================== */
        
        // API KEY SUMINISTRADA
        const GEMINI_KEY = 'AIzaSyC-P_Y77BBsAinIHvZKhlQbCOVmXThIHOw';
        let isChatOpen = false;

        function toggleTutor() {
            const win = document.getElementById('tutor-window');
            isChatOpen = !isChatOpen;
            if(isChatOpen) {
                win.classList.remove('hidden');
                setTimeout(() => win.classList.remove('scale-95', 'opacity-0'), 10);
            } else {
                win.classList.add('scale-95', 'opacity-0');
                setTimeout(() => win.classList.add('hidden'), 300);
            }
        }

        function accionarTutor(accion) {
            if(accion === 'quiz') {
                agregarBurbujaTutor('Generame un examen r√°pido de 3 preguntas (multiple choice) sobre el tema actual.', 'user');
                consultarGemini('Genera un examen corto de 3 preguntas de opci√≥n m√∫ltiple sobre el tema: ' + obtenerContexto() + '. Formato claro. Indica la respuesta correcta al final.');
            }
            if(accion === 'resumen') {
                agregarBurbujaTutor('Dame un resumen de esta clase.', 'user');
                consultarGemini('Haz un resumen conciso de 3 puntos clave sobre: ' + obtenerContexto());
            }
        }

        async function enviarMensajeTutor(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const texto = input.value.trim();
            if(!texto) return;

            agregarBurbujaTutor(texto, 'user');
            input.value = "";
            
            const prompt = `Act√∫a como un profesor experto. El alumno est√° viendo: "${obtenerContexto()}". Pregunta del alumno: "${texto}". Responde breve y did√°cticamente.`;
            consultarGemini(prompt);
        }

        function obtenerContexto() {
            const curso = document.getElementById('course-title').innerText;
            const leccion = document.getElementById('current-lesson-title').innerText;
            return `${leccion} (del curso ${curso})`;
        }

        async function consultarGemini(prompt) {
            const loadingId = mostrarLoading();
            
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                removerLoading(loadingId);

                if(data.error) throw new Error(data.error.message);
                const respuesta = data.candidates[0].content.parts[0].text;
                agregarBurbujaTutor(respuesta, 'bot');

            } catch (error) {
                removerLoading(loadingId);
                agregarBurbujaTutor("Lo siento, tuve un problema de conexi√≥n. Intenta de nuevo. üß†üí•", 'bot');
                console.error(error);
            }
        }

        function agregarBurbujaTutor(texto, tipo) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            
            // Formateo simple de Markdown (Negritas)
            const htmlText = texto.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');

            if(tipo === 'user') {
                div.className = "flex gap-3 flex-row-reverse chat-bubble";
                div.innerHTML = `
                    <div class="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center shrink-0 mt-1"><i data-lucide="user" class="w-3 h-3 text-white"></i></div>
                    <div class="bg-blue-600/20 text-blue-100 text-xs p-3 rounded-l-xl rounded-br-xl border border-blue-600/30 text-right">${htmlText}</div>`;
            } else {
                div.className = "flex gap-3 chat-bubble";
                div.innerHTML = `
                    <div class="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center shrink-0 mt-1"><i data-lucide="bot" class="w-3 h-3 text-white"></i></div>
                    <div class="bg-slate-800 text-slate-200 text-xs p-3 rounded-r-xl rounded-bl-xl border border-slate-700 leading-relaxed">${htmlText}</div>`;
            }
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            lucide.createIcons();
        }

        function mostrarLoading() {
            const container = document.getElementById('chat-messages');
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex gap-3 chat-bubble";
            div.innerHTML = `
                <div class="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center shrink-0 mt-1"><i data-lucide="bot" class="w-3 h-3 text-white"></i></div>
                <div class="bg-slate-800 p-3 rounded-r-xl rounded-bl-xl border border-slate-700 flex gap-1">
                    <span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce"></span>
                    <span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce delay-100"></span>
                    <span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce delay-200"></span>
                </div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            lucide.createIcons();
            return id;
        }

        function removerLoading(id) {
            const el = document.getElementById(id);
            if(el) el.remove();
        }
    </script>
</body>
</html>
