<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aula Virtual</title>
    <script src='https://meet.jit.si/external_api.js'></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> 
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        /* Estilos Base & Tema */
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; transition: background 0.5s ease; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        
        /* Animaciones */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .chat-bubble { animation: popIn 0.3s ease-out; }
        @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Animaci√≥n Doc (B√∫ho) */
        .doc-bounce { animation: docBounce 2s infinite; display: inline-block; }
        @keyframes docBounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

        /* Utilidades */
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; background: black; border-radius: 12px; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Toast Notifications */
        .toast { position: fixed; top: 20px; right: 20px; padding: 12px 16px; border-radius: 8px; z-index: 9999; animation: slideIn 0.3s ease-out; }
        .toast-success { background: #10b981; color: white; }
        .toast-error { background: #ef4444; color: white; }
        .toast-info { background: #3b82f6; color: white; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <header id="top-header" class="h-16 bg-slate-950 border-b border-white/5 flex items-center justify-between px-4 md:px-6 shrink-0 z-20 transition-all duration-500">
        <div class="flex items-center gap-4">
            <a href="index.html" class="p-2 hover:bg-white/10 rounded-lg transition text-slate-400 hover:text-white" title="Volver al Campus">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </a>
            <div class="flex items-center gap-3">
                <div id="header-logo-container" class="hidden h-9 w-9 bg-white/90 rounded-lg items-center justify-center p-1 shadow-lg shadow-white/10">
                    <img id="header-logo" src="" class="h-full w-full object-contain" onerror="this.parentElement.classList.add('hidden')">
                </div>
                <div>
                    <h1 class="font-bold text-white text-sm md:text-lg leading-tight truncate max-w-[200px] md:max-w-md" id="course-title">Cargando Aula...</h1>
                    <p class="text-[10px] text-white/60 font-bold uppercase tracking-wider" id="inst-name-header">Campus Virtual</p>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="hidden md:block text-right">
                <p class="text-sm font-bold text-white" id="student-name">Estudiante</p>
                <div class="flex items-center justify-end gap-1.5">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <p class="text-[10px] text-green-400 font-bold uppercase">En Clase</p>
                </div>
            </div>
            <div id="user-avatar-ui" class="w-9 h-9 bg-white/10 rounded-full flex items-center justify-center font-bold text-white shadow-lg border border-white/10">
                <i data-lucide="user" class="w-4 h-4"></i>
            </div>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden relative">
        
        <main class="flex-1 flex flex-col min-w-0 bg-slate-900/50 relative z-10 backdrop-blur-sm" id="main-container">
            <div class="flex-1 p-4 md:p-8 overflow-y-auto flex flex-col">
                <div class="w-full max-w-6xl mx-auto space-y-6 h-full flex flex-col">
                    
                    <div id="player-wrapper" class="w-full bg-black rounded-2xl shadow-2xl overflow-hidden border border-white/10 relative aspect-video flex-shrink-0 flex items-center justify-center group">
                        <div id="player-placeholder" class="text-center p-8">
                            <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
                                <i data-lucide="loader-2" class="w-8 h-8 text-slate-600 animate-spin"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-500">Cargando contenido...</h3>
                        </div>
                        <div id="player-content" class="w-full h-full hidden"></div>
                    </div>

                    <div class="flex flex-col md:flex-row gap-4 justify-between items-start md:items-center pb-10 sticky bottom-0 z-20 py-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-1">
                                <h2 id="current-lesson-title" class="text-xl md:text-2xl font-bold text-white leading-tight">...</h2>
                                <span id="check-completed" class="hidden bg-green-500/20 text-green-400 text-[10px] px-2 py-0.5 rounded font-bold uppercase border border-green-500/30 flex items-center gap-1">
                                    <i data-lucide="check" class="w-3 h-3"></i> Completada
                                </span>
                            </div>
                            <button onclick="marcarComoCompletada()" id="btn-mark-done" class="text-xs font-bold text-slate-400 hover:text-white flex items-center gap-2 transition-colors cursor-pointer select-none">
                                <div class="w-4 h-4 border-2 border-slate-500 rounded-sm flex items-center justify-center group-hover:border-white transition-colors" id="btn-mark-icon"></div> 
                                Marcar como vista
                            </button>
                        </div>
                        <div class="flex gap-3 w-full md:w-auto">
                            <button id="btn-prev" class="flex-1 md:flex-none px-5 py-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold text-sm disabled:opacity-50 transition-all flex items-center justify-center gap-2" disabled>
                                <i data-lucide="chevron-left" class="w-4 h-4"></i> Anterior
                            </button>
                            <button id="btn-next" class="flex-1 md:flex-none px-5 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-bold text-sm shadow-lg disabled:opacity-50 transition-all flex items-center justify-center gap-2" disabled>
                                Siguiente <i data-lucide="chevron-right" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <aside class="w-80 bg-slate-950/95 border-l border-white/5 flex flex-col shrink-0 overflow-hidden absolute md:relative right-0 h-full z-20 transition-transform transform translate-x-full md:translate-x-0 backdrop-blur-xl" id="playlist-sidebar">
            <div class="p-4 border-b border-white/5 bg-slate-950 sticky top-0 z-10">
                <h3 class="font-bold text-slate-300 text-xs uppercase tracking-wider flex items-center gap-2">
                    <i data-lucide="list" class="w-3 h-3"></i> Temario del Curso
                </h3>
                <div class="h-1.5 w-full bg-slate-800 rounded-full mt-3 overflow-hidden">
                    <div class="h-full bg-green-500 w-0 transition-all duration-500" id="progress-bar"></div>
                </div>
                <p class="text-[10px] text-slate-500 mt-1 text-right"><span id="progress-text">0%</span> Completado</p>
            </div>
            <div id="modules-list" class="flex-1 overflow-y-auto p-3 space-y-3 pb-20">
                 <p class="text-center text-slate-600 text-xs py-10"><i data-lucide="loader-2" class="w-5 h-5 animate-spin mx-auto mb-2"></i> Cargando...</p>
            </div>
        </aside>

        <button onclick="toggleMobileMenu()" class="md:hidden absolute bottom-6 right-6 z-30 bg-indigo-600 text-white p-4 rounded-full shadow-xl">
            <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
        
        <button id="btn-tutor-toggle" onclick="toggleTutor()" class="fixed bottom-8 right-8 z-[100] group transition-all duration-300 hover:scale-110 cursor-pointer hidden md:block">
            <div class="relative">
                <div class="w-16 h-16 rounded-full bg-slate-900 p-1 shadow-2xl border-4 border-indigo-500 overflow-hidden relative z-10 flex items-center justify-center" id="tutor-btn-border">
                     <div class="w-full h-full bg-white rounded-full flex items-center justify-center relative overflow-hidden">
                        <span class="text-3xl doc-bounce select-none">ü¶â</span>
                        <span id="doc-badge-btn" class="absolute bottom-1 right-2 text-sm bg-white rounded-full w-5 h-5 flex items-center justify-center shadow-sm border border-indigo-100">üéì</span>
                     </div>
                </div>
                <div class="absolute bottom-0 right-0 w-4 h-4 bg-green-500 border-2 border-slate-900 rounded-full z-20 animate-pulse"></div>
            </div>
        </button>

        <div id="tutor-window" class="fixed bottom-28 right-4 md:right-8 z-[100] w-80 md:w-96 bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl flex flex-col hidden origin-bottom-right transform scale-95 opacity-0 h-[500px] transition-all duration-300">
            <div class="p-4 bg-indigo-600 border-b border-white/10 rounded-t-2xl flex justify-between items-center" id="tutor-header">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-white p-0.5 border border-white/20 overflow-hidden flex items-center justify-center relative">
                        <span class="text-xl select-none">ü¶â</span>
                        <span id="doc-badge-header" class="absolute -bottom-1 -right-1 text-[10px] bg-white rounded-full w-4 h-4 flex items-center justify-center border border-indigo-100">üéì</span>
                    </div>
                    <div>
                        <h3 class="font-bold text-white text-sm" id="tutor-name">Doc (Tutor)</h3>
                        <p class="text-[10px] text-white/80 font-medium">En l√≠nea ‚Ä¢ Ayuda al instante</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="borrarHistorial()" class="text-white/60 hover:text-white p-1" title="Borrar Chat"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    <button onclick="toggleTutor()" class="text-white/60 hover:text-white p-1"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
            </div>
            
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-900/95 text-sm">
            </div>
            
            <div class="px-3 py-2 bg-slate-950 flex gap-2 overflow-x-auto border-t border-slate-800 no-scrollbar">
                <button onclick="accionarTutor('quiz')" class="text-[10px] bg-slate-800 hover:bg-blue-600 text-blue-300 border border-slate-700 px-3 py-1.5 rounded-full whitespace-nowrap flex items-center gap-1 transition">üìù Quiz R√°pido</button>
                <button onclick="accionarTutor('resumen')" class="text-[10px] bg-slate-800 hover:bg-purple-600 text-purple-300 border border-slate-700 px-3 py-1.5 rounded-full whitespace-nowrap flex items-center gap-1 transition">‚ö° Resumir</button>
                <button onclick="accionarTutor('explicar')" class="text-[10px] bg-slate-800 hover:bg-green-600 text-green-300 border border-slate-700 px-3 py-1.5 rounded-full whitespace-nowrap flex items-center gap-1 transition">üí° Explicar Sencillo</button>
            </div>
            
            <div class="p-3 bg-slate-950 border-t border-slate-800 rounded-b-2xl">
                <form id="chat-form" class="flex gap-2 relative" onsubmit="enviarMensajeTutor(event)">
                    <input type="text" id="chat-input" class="flex-1 bg-slate-900 border border-slate-700 rounded-xl pl-4 pr-10 py-3 text-sm text-white focus:outline-none focus:border-indigo-500 transition shadow-inner" placeholder="Preg√∫ntale a Doc..." autocomplete="off">
                    <button type="submit" class="absolute right-4 top-1/2 -translate-y-1/2 text-indigo-500 hover:text-indigo-400" id="btn-send-chat"><i data-lucide="send-horizontal" class="w-5 h-5"></i></button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURACI√ìN SUPABASE (ASARI V8.0)
        // ============================================
        const PROJECT_URL = 'https://vxggatcfrywyodovjwxj.supabase.co';
        const PUBLIC_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4Z2dhdGNmcnl3eW9kb3Zqd3hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzM5MjgsImV4cCI6MjA4MzgwOTkyOH0.RZ9jhEASO6nCV8EnzrHQBhglP4G1nik9Z5osPXysGNg';
        const db = supabase.createClient(PROJECT_URL, PUBLIC_KEY);

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let flatLessons = [];
        let currentLessonIndex = -1;
        let completedLessons = new Set();
        let currentCourseId = null;
        let currentUserId = null;
        let institutionContext = "";
        let areaContext = "";
        let isChatOpen = false;
        let userInstitutionId = null; // Nuevo: Para validaci√≥n cross-institution
        let jitsiApi = null; // Para manejar instancias Jitsi

        // ============================================
        // FUNCIONES DE UTILIDAD
        // ============================================

        /**
         * Muestra notificaci√≥n toast
         */
        function toast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `<span class="text-sm font-medium">${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        /**
         * Muestra loading en chat
         */
        function mostrarLoading() {
            const container = document.getElementById('chat-messages');
            const id = 'load-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex gap-3 chat-bubble";
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-white overflow-hidden shrink-0 border border-indigo-500 mt-1 flex items-center justify-center">
                    <span class="text-sm">ü¶â</span>
                </div>
                <div class="bg-slate-800 p-4 rounded-2xl rounded-tl-none border border-slate-700 flex gap-1 items-center h-10">
                    <span class="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-bounce"></span>
                    <span class="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-bounce delay-100"></span>
                    <span class="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-bounce delay-200"></span>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return id;
        }

        /**
         * Remueve loading del chat
         */
        function removerLoading(id) {
            const el = document.getElementById(id);
            if(el) el.remove();
        }

        // ============================================
        // 1. INICIALIZACI√ìN Y SESI√ìN CON SEGURIDAD CROSS-INSTITUTION
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            
            // Verificar sesi√≥n
            const { data: { session } } = await db.auth.getSession();
            if(!session) {
                window.location.href = './login.html';
                return;
            }
            
            currentUserId = session.user.id;
            
            // Cargar perfil CON institucion_id (SEGURIDAD CROSS-INSTITUTION)
            try {
                const { data: perfilResult, error: perfilError } = await db
                    .from('perfiles')
                    .select('nombre_completo, email, institucion_id')
                    .eq('id', currentUserId);
                    
                if(!perfilError && perfilResult && perfilResult.length > 0) {
                    const nombre = perfilResult[0].nombre_completo || perfilResult[0].email || 'Estudiante';
                    document.getElementById('student-name').innerText = nombre;
                    
                    // Guardar instituci√≥n del usuario para validaci√≥n
                    userInstitutionId = perfilResult[0].institucion_id;
                } else {
                    console.warn("Perfil no encontrado o error:", perfilError);
                }
            } catch(error) {
                console.warn("Error cargando perfil:", error);
            }

            // Obtener curso de URL
            const params = new URLSearchParams(window.location.search);
            currentCourseId = params.get('id');
            const cursoNombre = params.get('curso');

            if(!currentCourseId) {
                toast("No se especific√≥ curso", "error");
                setTimeout(() => window.location.href = '/login.html', 2000);
                return;
            }

            // Validar formato del ID
            if(currentCourseId === 'general' && cursoNombre) {
                toast("Accediendo a contenido general", "info");
                // Puedes manejar cursos generales aqu√≠ si es necesario
            }

            await cargarCurso(currentCourseId);
        });

        // ============================================
        // 2. GESTI√ìN DE PROGRESO DEL ALUMNO
        // ============================================
        async function gestionarProgresoAlumno(cursoId, userId) {
            try {
                // Buscar progreso existente
                const { data: progresoExistente, error: buscarError } = await db
                    .from('progreso_alumnos')
                    .select('*')
                    .eq('student_id', userId)
                    .eq('curso_id', cursoId);
                    
                let progreso = null;
                
                // Si no existe, crear registro
                if(buscarError || !progresoExistente || progresoExistente.length === 0) {
                    const { data: nuevoProgreso, error: crearError } = await db
                        .from('progreso_alumnos')
                        .insert({
                            student_id: userId,
                            curso_id: cursoId,
                            ultimo_acceso: new Date().toISOString(),
                            clases_vistas: [],
                            created_at: new Date().toISOString()
                        })
                        .select();
                        
                    if(crearError) {
                        console.error("Error creando progreso:", crearError);
                        return;
                    }
                    
                    progreso = nuevoProgreso ? nuevoProgreso[0] : null;
                    toast("Registro de progreso creado", "success");
                } else {
                    progreso = progresoExistente[0];
                    
                    // Actualizar √∫ltimo acceso
                    await db
                        .from('progreso_alumnos')
                        .update({ ultimo_acceso: new Date().toISOString() })
                        .eq('student_id', userId)
                        .eq('curso_id', cursoId);
                }
                
                // Cargar lecciones vistas
                if(progreso && progreso.clases_vistas && Array.isArray(progreso.clases_vistas)) {
                    completedLessons = new Set(progreso.clases_vistas);
                } else {
                    completedLessons = new Set();
                }
                
            } catch (error) {
                console.error("Error gestionando progreso:", error);
                completedLessons = new Set();
                toast("Error cargando progreso, pero continuamos", "error");
            }
        }

        // ============================================
        // 3. CARGA DEL CURSO (PRINCIPAL) CON VALIDACI√ìN CROSS-INSTITUTION
        // ============================================
        async function cargarCurso(id) {
            try {
                // 1. Obtener curso con relaciones
                const { data: cursoResult, error: cursoError } = await db
                    .from('cursos_oficiales')
                    .select('*, areas(*), instituciones(*)')
                    .eq('id', id);
                    
                if(cursoError) {
                    throw new Error(`Error BD curso: ${cursoError.message}`);
                }
                
                if(!cursoResult || cursoResult.length === 0) {
                    toast("Curso no encontrado", "error");
                    setTimeout(() => window.location.href = './mi-campus.html', 2000);
                    return;
                }
                
                const curso = cursoResult[0];
                
                // ====================================================
                // VALIDACI√ìN DE SEGURIDAD CROSS-INSTITUTION (NUEVO)
                // ====================================================
                if (userInstitutionId && curso.institution_id) {
                    // Verificar si el usuario pertenece a la misma instituci√≥n que el curso
                    if (userInstitutionId !== curso.institution_id) {
                        // Opcional: Verificar si es superadmin/staff (podr√≠as agregar un campo en perfiles)
                        // Por ahora, bloqueamos el acceso
                        console.error(`Acceso denegado: Usuario instituci√≥n ${userInstitutionId} vs Curso instituci√≥n ${curso.institution_id}`);
                        
                        // Mostrar alerta bloqueante
                        document.body.innerHTML = `
                            <div class="h-screen flex items-center justify-center bg-slate-950">
                                <div class="text-center p-8 max-w-md">
                                    <div class="w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <i data-lucide="shield-alert" class="w-10 h-10 text-red-500"></i>
                                    </div>
                                    <h2 class="text-2xl font-bold text-white mb-3">Acceso Denegado</h2>
                                    <p class="text-slate-300 mb-6">
                                        Este curso pertenece a otra instituci√≥n. No tienes permisos para acceder.
                                    </p>
                                    <div class="space-y-3">
                                        <a href="mi-campus.html" class="block bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-bold transition">
                                            Volver al Campus
                                        </a>
                                        <p class="text-xs text-slate-500 mt-4">
                                            Si crees que esto es un error, contacta al administrador.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `;
                        lucide.createIcons();
                        return;
                    }
                }
                // ====================================================
                
                // 2. Validar contenido b√°sico
                if(!curso.contenido || typeof curso.contenido !== 'object') {
                    console.warn("Curso sin contenido estructurado:", curso);
                    curso.contenido = [];
                }

                // A. Datos B√°sicos
                document.getElementById('course-title').innerText = curso.nombre || "Curso sin nombre";
                
                // B. Identidad Visual con validaci√≥n
                if (curso.instituciones) {
                    const inst = curso.instituciones;
                    document.getElementById('inst-name-header').innerText = inst.nombre || "Instituci√≥n";
                    
                    if (inst.color_primario) {
                        const color = inst.color_primario;
                        try {
                            document.getElementById('top-header').style.borderBottomColor = color;
                            document.getElementById('tutor-header').style.backgroundColor = color;
                            document.getElementById('tutor-btn-border').style.borderColor = color;
                            document.getElementById('btn-send-chat').style.color = color;
                            document.body.style.background = `linear-gradient(to bottom right, #0f172a 0%, ${color}15 100%)`;
                        } catch(e) { 
                            console.warn("Error aplicando colores:", e); 
                        }
                    }
                    
                    if (inst.logo_url) {
                        try {
                            const logo = document.getElementById('header-logo');
                            const container = document.getElementById('header-logo-container');
                            logo.src = inst.logo_url;
                            logo.onerror = () => {
                                container.classList.add('hidden');
                                container.classList.remove('flex');
                            };
                            container.classList.remove('hidden');
                            container.classList.add('flex');
                        } catch(e) { 
                            console.warn("Error cargando logo:", e); 
                        }
                    }
                    
                    institutionContext = `Instituci√≥n: ${inst.nombre}.`;
                }

                // C. Contexto Doc (B√∫ho)
                const fullContext = (curso.nombre + " " + (curso.areas?.nombre || "")).toLowerCase();
                updateDocPersonality(fullContext);
                
                if (curso.areas) {
                    areaContext = curso.areas.dossier_txt || "";
                    if(curso.areas.prompt_especifico) {
                        areaContext += `\nEnfoque pedag√≥gico: ${curso.areas.prompt_especifico}`;
                    }
                }

                // D. Gestionar progreso del alumno
                await gestionarProgresoAlumno(id, currentUserId);

                // E. Renderizar clases
                renderizarTemario(curso.contenido || []);
                
                // F. Navegar a √∫ltima clase vista o primera
                let targetIndex = 0;
                for(let i = 0; i < flatLessons.length; i++) {
                    if(!completedLessons.has(flatLessons[i].uniqueId)) {
                        targetIndex = i;
                        break;
                    }
                }
                
                if(flatLessons.length > 0 && completedLessons.size === flatLessons.length) {
                    targetIndex = flatLessons.length - 1;
                }
                
                if(flatLessons.length > 0) {
                    cargarClase(targetIndex);
                } else {
                    // Curso sin lecciones
                    document.getElementById('current-lesson-title').innerText = "Curso en preparaci√≥n";
                    document.getElementById('player-placeholder').innerHTML = `
                        <div class="text-center p-8">
                            <i data-lucide="book-open" class="w-16 h-16 text-slate-600 mx-auto mb-4"></i>
                            <h3 class="text-xl font-bold text-slate-500 mb-2">Contenido en construcci√≥n</h3>
                            <p class="text-slate-400">El instructor est√° preparando el material.</p>
                        </div>
                    `;
                    lucide.createIcons();
                }
                
                // G. Mensaje inicial de Doc (solo si hay contenido)
                if(flatLessons.length > 0) {
                    setTimeout(() => {
                        const role = document.getElementById('tutor-name').innerText.split('(')[1]?.replace(')','') || 'Tutor';
                        agregarBurbujaTutor(`¬°Hola! Soy <b>Doc</b>, tu ${role}. Estoy listo para ayudarte con el curso de <b>${curso.nombre}</b>.`, 'bot');
                    }, 1000);
                }
                
            } catch (error) {
                console.error("Error cr√≠tico cargando curso:", error);
                toast("Error al cargar el curso", "error");
                setTimeout(() => window.location.href = './mi-campus.html', 3000);
            }
        }

        // ============================================
        // 4. L√ìGICA DE PERSONALIDAD "DOC" (B√öHO)
        // ============================================
        function updateDocPersonality(contexto) {
            let icon = 'üéì'; // Default Acad√©mico
            let role = 'Tutor Acad√©mico';

            if(contexto.includes('salud') || contexto.includes('enferme') || contexto.includes('medicin') || contexto.includes('auxiliar')) {
                icon = 'ü©∫'; role = 'Tutor de Salud';
            } else if(contexto.includes('forense') || contexto.includes('criminal') || contexto.includes('investiga')) {
                icon = 'üîé'; role = 'Investigador Forense';
            } else if(contexto.includes('deporte') || contexto.includes('gym') || contexto.includes('entrena')) {
                icon = '‚öΩ'; role = 'Coach Deportivo';
            } else if(contexto.includes('legal') || contexto.includes('juridic') || contexto.includes('ley')) {
                icon = '‚öñÔ∏è'; role = 'Asesor Legal';
            } else if(contexto.includes('rescat') || contexto.includes('emergen') || contexto.includes('bombero')) {
                icon = '‚õëÔ∏è'; role = 'Instructor de Rescate';
            }

            // Actualizar UI del B√∫ho
            document.getElementById('doc-badge-btn').innerText = icon;
            document.getElementById('doc-badge-header').innerText = icon;
            document.getElementById('tutor-name').innerText = `Doc (${role})`;
        }

        // ============================================
        // 5. RENDERIZADO DE CLASES CON INTEGRACI√ìN JITSI
        // ============================================
        function renderizarTemario(modulos) {
            const container = document.getElementById('modules-list');
            container.innerHTML = "";
            flatLessons = [];

            if (!modulos || !Array.isArray(modulos)) {
                container.innerHTML = `
                    <div class="text-center py-8 text-slate-500">
                        <i data-lucide="book-open" class="w-8 h-8 mx-auto mb-2"></i>
                        <p class="text-sm">No hay lecciones disponibles</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            modulos.forEach((mod, modIdx) => {
                const modDiv = document.createElement('div');
                modDiv.className = "space-y-1 mb-4";
                modDiv.innerHTML = `
                    <div class="px-3 py-2 bg-slate-900/50 rounded-lg text-[10px] font-bold text-slate-400 uppercase tracking-wider border border-white/5">
                        ${mod.titulo || 'M√≥dulo sin t√≠tulo'}
                    </div>
                    <div class="space-y-1 pl-1" id="mod-content-${modIdx}"></div>
                `;
                container.appendChild(modDiv);

                if(mod.lecciones && Array.isArray(mod.lecciones)) {
                    mod.lecciones.forEach((lec, lecIdx) => {
                        const idx = flatLessons.length;
                        const uniqueId = `${modIdx}-${lecIdx}`;
                        flatLessons.push({ 
                            ...lec, 
                            modIdx, 
                            uniqueId,
                            tipo: lec.tipo || 'VIDEO',
                            titulo: lec.titulo || 'Lecci√≥n sin t√≠tulo',
                            url: lec.url || ''
                        });

                        const btn = document.createElement('button');
                        btn.id = `btn-lec-${idx}`;
                        const isCompleted = completedLessons.has(uniqueId);
                        
                        // Icono seg√∫n tipo
                        let icon = 'play-circle';
                        if(lec.tipo === 'PDF') icon = 'file-text';
                        if(lec.tipo === 'LIVE' || lec.tipo === 'ZOOM') icon = 'video';
                        if(lec.tipo === 'LIVE') icon = 'video'; // Jitsi

                        const leftIcon = isCompleted ? 
                            `<i data-lucide="check-circle-2" class="w-4 h-4 text-green-500"></i>` : 
                            `<i data-lucide="${icon}" class="w-4 h-4 opacity-50 group-hover:opacity-100"></i>`;

                        btn.className = `w-full text-left px-3 py-3 rounded-lg flex items-center justify-between text-xs transition-all border border-transparent group ${isCompleted ? 'text-green-400' : 'text-slate-400 hover:bg-white/5 hover:text-white'}`;
                        
                        btn.innerHTML = `
                            <div class="flex items-center gap-3 overflow-hidden">
                                <span class="shrink-0">${leftIcon}</span> 
                                <span class="truncate font-medium">${lec.titulo || 'Sin t√≠tulo'}</span>
                                ${lec.tipo === 'LIVE' ? '<span class="bg-red-500/20 text-red-400 text-[8px] px-1.5 py-0.5 rounded-full">EN VIVO</span>' : ''}
                                ${lec.tipo === 'ZOOM' ? '<span class="bg-blue-500/20 text-blue-400 text-[8px] px-1.5 py-0.5 rounded-full">ZOOM</span>' : ''}
                            </div>
                        `;
                        btn.onclick = () => cargarClase(idx);
                        modDiv.querySelector(`#mod-content-${modIdx}`).appendChild(btn);
                    });
                }
            });
            lucide.createIcons();
            actualizarBarraGlobal();
        }

        function cargarClase(index) {
            if(index < 0 || index >= flatLessons.length) return;
            
            // Limpiar instancia Jitsi anterior si existe
            if (jitsiApi) {
                jitsiApi.dispose();
                jitsiApi = null;
            }
            
            // Remover selecci√≥n previa
            document.querySelectorAll('[id^="btn-lec-"]').forEach(b => {
                b.classList.remove('bg-indigo-600/20', 'border-indigo-500/30');
            });
            
            // Agregar selecci√≥n actual
            const activeBtn = document.getElementById(`btn-lec-${index}`);
            if(activeBtn) {
                activeBtn.classList.add('bg-indigo-600/20', 'border-indigo-500/30');
            }

            currentLessonIndex = index;
            const lec = flatLessons[index];
            document.getElementById('current-lesson-title').innerText = lec.titulo;
            actualizarBotonCompletado(completedLessons.has(lec.uniqueId));

            // Content Loader
            const container = document.getElementById('player-content');
            const placeholder = document.getElementById('player-placeholder');
            container.innerHTML = "";
            
            placeholder.classList.add('hidden');
            container.classList.remove('hidden');

            // ============================================
            // L√ìGICA MEJORADA PARA DIFERENTES TIPOS DE CLASE
            // ============================================

            // 1. TIPO 'LIVE' - INTEGRACI√ìN JITSI NATIVA
            if (lec.tipo === 'LIVE') {
                const studentName = document.getElementById('student-name').innerText || 'Estudiante';
                const roomName = `ASARI_LIVE_${currentCourseId}_${lec.id || lec.uniqueId}`.replace(/[^a-zA-Z0-9_]/g, '_');
                
                container.innerHTML = `<div id="jitsi-container" class="w-full h-full bg-black"></div>`;
                
                // Instanciar Jitsi Meet
                try {
                    const domain = 'meet.jit.si';
                    const options = {
                        roomName: roomName,
                        width: '100%',
                        height: '100%',
                        parentNode: container.querySelector('#jitsi-container'),
                        configOverwrite: {
                            disableInviteFunctions: true, // Deshabilitar invitar a otros
                            startWithAudioMuted: true,
                            startWithVideoMuted: false,
                            prejoinPageEnabled: false
                        },
                        interfaceConfigOverwrite: {
                            SHOW_JITSI_WATERMARK: false,
                            SHOW_WATERMARK_FOR_GUESTS: false,
                            TOOLBAR_BUTTONS: [
                                'microphone', 'camera', 'closedcaptions', 'desktop', 'fullscreen',
                                'fodeviceselection', 'hangup', 'profile', 'chat', 'recording',
                                'livestreaming', 'settings', 'raisehand', 'videoquality', 'filmstrip',
                                'invite', 'feedback', 'stats', 'shortcuts', 'tileview', 'videobackgroundblur',
                                'download', 'help', 'mute-everyone'
                            ],
                        },
                        userInfo: {
                            displayName: studentName,
                            email: ''
                        }
                    };

                    jitsiApi = new JitsiMeetExternalAPI(domain, options);
                    
                    toast("Conectando a clase en vivo...", "info");
                    
                    // Manejar eventos de Jitsi
                    jitsiApi.addEventListeners({
                        readyToClose: () => {
                            console.log("Jitsi cerr√°ndose...");
                            jitsiApi.dispose();
                            jitsiApi = null;
                        },
                        participantJoined: (participant) => {
                            console.log("Participante unido:", participant);
                        },
                        participantLeft: (participant) => {
                            console.log("Participante sali√≥:", participant);
                        }
                    });
                    
                } catch (error) {
                    console.error("Error inicializando Jitsi:", error);
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-center p-10 bg-slate-900">
                            <i data-lucide="alert-triangle" class="w-16 h-16 text-red-500 mb-4"></i>
                            <h3 class="text-xl font-bold text-white mb-2">Error en clase en vivo</h3>
                            <p class="text-slate-300 mb-4">No se pudo cargar la clase en vivo</p>
                            <button onclick="marcarComoCompletada()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">
                                Continuar
                            </button>
                        </div>
                    `;
                    lucide.createIcons();
                }
            }
            
            // 2. TIPO 'ZOOM' - ENLACE EXTERNO CON BOT√ìN ELEGANTE
            else if (lec.tipo === 'ZOOM') {
                const zoomLink = lec.url || '#';
                
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center p-10 bg-gradient-to-br from-blue-900/30 to-slate-900">
                        <div class="w-24 h-24 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i data-lucide="video" class="w-12 h-12 text-blue-400"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-white mb-3">Reuni√≥n de Zoom</h3>
                        <p class="text-slate-300 mb-6 max-w-md">Clase en vivo a trav√©s de Zoom. Haz clic para unirte a la reuni√≥n.</p>
                        
                        <a href="${zoomLink}" target="_blank" 
                           class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-xl transition-all flex items-center gap-3 mb-4"
                           onclick="marcarComoCompletada()">
                            <i data-lucide="external-link" class="w-5 h-5"></i>
                            Unirse a Reuni√≥n de Zoom
                        </a>
                        
                        <p class="text-xs text-slate-500">Se abrir√° en una nueva pesta√±a para mejor experiencia</p>
                    </div>
                `;
                lucide.createIcons();
            }
            
            // 3. TIPO 'VIDEO' - CON MANEJO DE VIDEOS VAC√çOS
            else if (lec.tipo === 'VIDEO') {
                // Verificar si la URL est√° vac√≠a
                if (!lec.url || lec.url.trim() === '') {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-center p-10 bg-slate-900">
                            <i data-lucide="clock" class="w-16 h-16 text-yellow-500 mb-4"></i>
                            <h3 class="text-xl font-bold text-white mb-2">Video pendiente</h3>
                            <p class="text-slate-300 mb-4">El docente a√∫n no ha cargado el material de esta lecci√≥n.</p>
                            <div class="space-y-3">
                                <button onclick="marcarComoCompletada()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">
                                    Marcar como vista
                                </button>
                                <p class="text-xs text-slate-500">Revisa m√°s tarde para ver el contenido actualizado</p>
                            </div>
                        </div>
                    `;
                    lucide.createIcons();
                } else if (lec.url.includes('youtu') || lec.url.includes('youtube')) {
                    // Extraer ID de YouTube
                    let videoId = '';
                    if (lec.url.includes('v=')) {
                        videoId = lec.url.split('v=')[1];
                        const ampersandPosition = videoId.indexOf('&');
                        if (ampersandPosition !== -1) {
                            videoId = videoId.substring(0, ampersandPosition);
                        }
                    } else if (lec.url.includes('youtu.be/')) {
                        videoId = lec.url.split('youtu.be/')[1];
                        const questionPosition = videoId.indexOf('?');
                        if (questionPosition !== -1) {
                            videoId = videoId.substring(0, questionPosition);
                        }
                    }
                    
                    if (videoId) {
                        container.innerHTML = `
                            <iframe 
                                src="https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1&autoplay=1" 
                                class="w-full h-full" 
                                frameborder="0" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen>
                            </iframe>
                        `;
                    } else {
                        mostrarErrorVideo();
                    }
                } else {
                    container.innerHTML = `
                        <video src="${lec.url}" controls class="w-full h-full bg-black" autoplay>
                            Tu navegador no soporta el elemento de video.
                        </video>
                    `;
                }
            }
            
            // 4. TIPO 'PDF'
            else if (lec.tipo === 'PDF') {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center p-10 bg-slate-900 w-full">
                        <i data-lucide="file-text" class="w-16 h-16 text-red-500 mb-4"></i>
                        <h3 class="text-xl font-bold text-white mb-2">Lectura Obligatoria</h3>
                        <p class="text-slate-300 mb-4">${lec.titulo}</p>
                        <a href="${lec.url}" target="_blank" onclick="marcarComoCompletada()" 
                           class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-bold flex gap-2 transition">
                            <i data-lucide="download" class="w-4 h-4"></i> Abrir Documento
                        </a>
                    </div>
                `;
                lucide.createIcons();
            }
            
            // 5. TIPO DESCONOCIDO O NO ESPECIFICADO
            else {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center p-10 bg-slate-900">
                        <i data-lucide="alert-circle" class="w-16 h-16 text-yellow-500 mb-4"></i>
                        <h3 class="text-xl font-bold text-white mb-2">Contenido no disponible</h3>
                        <p class="text-slate-300">Tipo de contenido: ${lec.tipo || 'No especificado'}</p>
                        <button onclick="marcarComoCompletada()" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">
                            Marcar como vista
                        </button>
                    </div>
                `;
                lucide.createIcons();
            }

            updateNavButtons();
            
            // Cerrar sidebar en m√≥vil
            if(window.innerWidth < 768) {
                document.getElementById('playlist-sidebar').classList.add('translate-x-full');
            }
        }

        function mostrarErrorVideo() {
            const container = document.getElementById('player-content');
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center p-10 bg-slate-900">
                    <i data-lucide="alert-triangle" class="w-16 h-16 text-red-500 mb-4"></i>
                    <h3 class="text-xl font-bold text-white mb-2">Error al cargar video</h3>
                    <p class="text-slate-300 mb-4">El enlace del video no es v√°lido</p>
                    <button onclick="marcarComoCompletada()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">
                        Continuar igual
                    </button>
                </div>
            `;
            lucide.createIcons();
        }

        // ============================================
        // 6. GESTI√ìN DE PROGRESO Y COMPLETADO
        // ============================================
        async function marcarComoCompletada() {
            if(currentLessonIndex === -1 || flatLessons.length === 0) {
                toast("No hay lecci√≥n activa", "error");
                return;
            }
            
            const lec = flatLessons[currentLessonIndex];

            // Si ya est√° completada, solo navegar
            if(completedLessons.has(lec.uniqueId)) {
                if(currentLessonIndex < flatLessons.length - 1) {
                    cargarClase(currentLessonIndex + 1);
                } else {
                    toast("¬°Curso completado!", "success");
                }
                return;
            }

            // Marcar como vista
            completedLessons.add(lec.uniqueId);
            actualizarBotonCompletado(true);
            
            // Actualizar UI
            const btn = document.getElementById(`btn-lec-${currentLessonIndex}`);
            if(btn) {
                btn.classList.remove('text-slate-400', 'hover:bg-white/5', 'hover:text-white');
                btn.classList.add('text-green-400');
                const iconSpan = btn.querySelector('span:first-child');
                if(iconSpan) {
                    iconSpan.innerHTML = `<i data-lucide="check-circle-2" class="w-4 h-4 text-green-500"></i>`;
                    lucide.createIcons();
                }
            }
            
            actualizarBarraGlobal();

            // GUARDAR EN BD con manejo de errores
            try {
                const { error } = await db.from('progreso_alumnos').upsert({ 
                    student_id: currentUserId, 
                    curso_id: currentCourseId, 
                    clases_vistas: Array.from(completedLessons),
                    ultimo_acceso: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                }, { 
                    onConflict: 'student_id,curso_id'
                });
                
                if(error) throw error;
                
            } catch (error) {
                console.error("Error guardando progreso:", error);
                toast("‚ö†Ô∏è Error guardando progreso, pero continuamos...", "error");
            }

            // Navegar autom√°ticamente despu√©s de 800ms
            setTimeout(() => {
                if(currentLessonIndex < flatLessons.length - 1) {
                    cargarClase(currentLessonIndex + 1);
                } else {
                    toast("üéâ ¬°Has completado todas las lecciones!", "success");
                }
            }, 800);
        }

        function actualizarBotonCompletado(isDone) {
            const btn = document.getElementById('btn-mark-done');
            const badge = document.getElementById('check-completed');
            
            if(isDone) {
                badge.classList.remove('hidden');
                btn.innerHTML = `
                    <span class="text-green-400 flex items-center gap-1">
                        Siguiente Lecci√≥n <i data-lucide="arrow-right" class="w-3 h-3"></i>
                    </span>
                `;
            } else {
                badge.classList.add('hidden');
                btn.innerHTML = `
                    <div class="w-4 h-4 border-2 border-slate-500 rounded-sm flex items-center justify-center mr-2" id="btn-mark-icon"></div> 
                    Marcar como vista
                `;
            }
            lucide.createIcons();
        }

        function actualizarBarraGlobal() {
            if(flatLessons.length === 0) {
                document.getElementById('progress-bar').style.width = '0%';
                document.getElementById('progress-text').innerText = '0%';
                return;
            }
            
            const percent = Math.round((completedLessons.size / flatLessons.length) * 100);
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-text').innerText = `${percent}%`;
        }

        function updateNavButtons() {
            const prevBtn = document.getElementById('btn-prev');
            const nextBtn = document.getElementById('btn-next');
            
            prevBtn.disabled = currentLessonIndex <= 0;
            nextBtn.disabled = currentLessonIndex >= flatLessons.length - 1;
            
            prevBtn.onclick = () => cargarClase(currentLessonIndex - 1);
            nextBtn.onclick = () => cargarClase(currentLessonIndex + 1);
        }

        // ============================================
        // 7. L√ìGICA TUTOR IA (GEMINI)
        // ============================================
        function toggleTutor() {
            const win = document.getElementById('tutor-window');
            isChatOpen = !isChatOpen;
            
            if(isChatOpen) {
                win.classList.remove('hidden');
                requestAnimationFrame(() => {
                    win.classList.remove('scale-95', 'opacity-0');
                    document.getElementById('chat-input').focus();
                });
            } else {
                win.classList.add('scale-95', 'opacity-0');
                setTimeout(() => win.classList.add('hidden'), 300);
            }
        }

        function toggleMobileMenu() {
            document.getElementById('playlist-sidebar').classList.toggle('translate-x-full');
        }

        async function enviarMensajeTutor(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            
            if(!text) {
                toast("Escribe un mensaje", "error");
                return;
            }

            agregarBurbujaTutor(text, 'user');
            input.value = "";

            const leccionActual = document.getElementById('current-lesson-title').innerText;
            const docName = document.getElementById('tutor-name').innerText;
            
            const prompt = `
ROLE: Eres "${docName}", un asistente educativo representado por un B√∫ho Sabio.
TONO: Pedag√≥gico, alentador, profesional pero cercano.
CONTEXTO INSTITUCIONAL: ${institutionContext}
CONTEXTO DEL √ÅREA: ${areaContext}
LECCI√ìN ACTUAL: "${leccionActual}"
PREGUNTA DEL ALUMNO: "${text}"

INSTRUCCIONES:
1. Responde de forma clara y √∫til.
2. Usa formato Markdown para mejorar la legibilidad.
3. S√© conciso pero completo.
4. Si la pregunta no est√° relacionada con el curso, redirige amablemente al tema.
5. Incluye ejemplos pr√°cticos cuando sea relevante.

RESPUESTA:
            `;

            await consultarGemini(prompt);
        }

        async function consultarGemini(prompt) {
            const loadingId = mostrarLoading();
            
            try {
                // 1. Obtener API key
                const { data: secretResult, error: secretError } = await db
                    .from('app_secrets')
                    .select('value')
                    .eq('name', 'gemini_api_key');
                    
                if(secretError) {
                    throw new Error(`Error BD: ${secretError.message}`);
                }
                
                if(!secretResult || secretResult.length === 0) {
                    throw new Error("API key no configurada. Contacta al administrador.");
                }
                
                const apiKey = secretResult[0].value?.trim();
                if(!apiKey) {
                    throw new Error("API key vac√≠a.");
                }

                // 2. Llamar a Gemini
                const model = 'gemini-2.0-flash-lite'; // Puedes cambiar a 'gemini-pro' si es necesario
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        contents: [{ 
                            parts: [{ text: prompt }] 
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 1000,
                        }
                    })
                });

                if(!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`API Gemini: ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                removerLoading(loadingId);
                
                const reply = data.candidates?.[0]?.content?.parts?.[0]?.text 
                    || "Lo siento, no pude generar una respuesta en este momento. ¬øPodr√≠as reformular tu pregunta?";
                
                agregarBurbujaTutor(marked.parse(reply), 'bot');

            } catch(error) {
                console.error("Error consultando Gemini:", error);
                removerLoading(loadingId);
                
                let errorMsg = "‚ö†Ô∏è Error de conexi√≥n con Doc. ";
                if(error.message.includes('API key')) {
                    errorMsg = "‚ö†Ô∏è Configuraci√≥n incompleta del asistente.";
                }
                
                agregarBurbujaTutor(`${errorMsg} Intenta de nuevo m√°s tarde.`, 'bot');
            }
        }

        function agregarBurbujaTutor(htmlContent, type) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            
            if (type === 'user') {
                div.className = "flex gap-3 flex-row-reverse chat-bubble";
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center shrink-0">
                        <i data-lucide="user" class="w-4 h-4 text-slate-300"></i>
                    </div>
                    <div class="bg-indigo-600 text-white text-sm p-3 rounded-2xl rounded-tr-none shadow-md max-w-[85%]">
                        ${htmlContent}
                    </div>
                `;
            } else {
                // Avatar Din√°mico de Doc en el chat
                const badge = document.getElementById('doc-badge-header').innerText;
                div.className = "flex gap-3 chat-bubble";
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-white overflow-hidden shrink-0 border border-indigo-500 mt-1 flex items-center justify-center relative">
                        <span class="text-sm select-none">ü¶â</span>
                        <span class="absolute -bottom-1 -right-1 text-[8px] bg-white rounded-full w-3 h-3 flex items-center justify-center border border-indigo-100">
                            ${badge}
                        </span>
                    </div>
                    <div class="bg-slate-800 text-slate-200 text-sm p-3 rounded-2xl rounded-tl-none border border-slate-700 shadow-md max-w-[90%] prose prose-invert prose-sm leading-snug">
                        ${htmlContent}
                    </div>
                `;
            }
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            lucide.createIcons();
        }

        function borrarHistorial() {
            if(confirm("¬øBorrar todo el historial de chat?")) {
                document.getElementById('chat-messages').innerHTML = "";
                agregarBurbujaTutor("Memoria limpia. ¬øEn qu√© te ayudo ahora?", 'bot');
            }
        }

        function accionarTutor(accion) {
            const leccion = document.getElementById('current-lesson-title').innerText;
            
            if(accion === 'quiz') {
                agregarBurbujaTutor('Hazme un examen r√°pido.', 'user');
                consultarGemini(`Genera un examen corto de 3 preguntas multiple choice sobre: "${leccion}". Formato Markdown. Pon las respuestas correctas ocultas al final.`);
            } else if (accion === 'resumen') {
                agregarBurbujaTutor('Resumir esta clase.', 'user');
                consultarGemini(`Dame los 3 puntos clave m√°s importantes de: "${leccion}". Usa vi√±etas.`);
            } else if (accion === 'explicar') {
                agregarBurbujaTutor('Expl√≠came esto como si tuviera 10 a√±os.', 'user');
                consultarGemini(`Explica el concepto principal de "${leccion}" con una analog√≠a simple y divertida.`);
            }
        }

        // ============================================
        // 8. MANEJO DE LIMPIEZA AL SALIR
        // ============================================
        window.addEventListener('beforeunload', function() {
            if (jitsiApi) {
                jitsiApi.dispose();
            }
        });

        window.addEventListener('unload', function() {
            if (jitsiApi) {
                jitsiApi.dispose();
            }
        });
    </script>
</body>
</html>
