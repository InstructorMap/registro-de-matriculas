<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aula Virtual</title>
    <script src='https://meet.jit.si/external_api.js'></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> 
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        /* Estilos Base & Tema */
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; transition: background 0.5s ease; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        
        /* Animaciones */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .chat-bubble { animation: popIn 0.3s ease-out; }
        @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Animaci√≥n Doc (B√∫ho) */
        .doc-bounce { animation: docBounce 2s infinite; display: inline-block; }
        @keyframes docBounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

        /* Utilidades */
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; background: black; border-radius: 12px; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Toast Notifications */
        .toast { position: fixed; top: 20px; right: 20px; padding: 12px 16px; border-radius: 8px; z-index: 9999; animation: slideIn 0.3s ease-out; }
        .toast-success { background: #10b981; color: white; }
        .toast-error { background: #ef4444; color: white; }
        .toast-info { background: #3b82f6; color: white; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div id="toast-container"></div>

    <header id="top-header" class="h-16 bg-slate-950 border-b border-white/5 flex items-center justify-between px-4 md:px-6 shrink-0 z-20 transition-all duration-500">
        <div class="flex items-center gap-4">
            <a href="./mi-campus.html" class="flex items-center gap-2 px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg transition text-slate-300 hover:text-white text-xs font-bold border border-white/10 shadow-sm" title="Volver al Campus">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                <span class="hidden md:inline">Volver al Campus</span>
            </a>
            
            <div class="flex items-center gap-3 border-l border-white/10 pl-4">
                <div id="header-logo-container" class="hidden h-9 w-9 bg-white/90 rounded-lg items-center justify-center p-1 shadow-lg shadow-white/10">
                    <img id="header-logo" src="" class="h-full w-full object-contain" onerror="this.parentElement.classList.add('hidden')">
                </div>
                <div>
                    <h1 class="font-bold text-white text-sm md:text-lg leading-tight truncate max-w-[200px] md:max-w-md" id="course-title">Cargando Aula...</h1>
                    <p class="text-[10px] text-white/60 font-bold uppercase tracking-wider" id="inst-name-header">Campus Virtual</p>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="hidden md:block text-right">
                <p class="text-sm font-bold text-white" id="student-name">Estudiante</p>
                <div class="flex items-center justify-end gap-1.5">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <p class="text-[10px] text-green-400 font-bold uppercase">En Clase</p>
                </div>
            </div>
            <div id="user-avatar-ui" class="w-9 h-9 bg-white/10 rounded-full flex items-center justify-center overflow-hidden border border-white/10 relative">
                <i data-lucide="user" class="w-4 h-4 text-white z-0 absolute"></i>
                <img id="user-photo-header" src="" class="w-full h-full object-cover relative z-10 hidden" onerror="this.classList.add('hidden')">
            </div>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden relative">
        
        <main class="flex-1 flex flex-col min-w-0 bg-slate-900/50 relative z-10 backdrop-blur-sm" id="main-container">
            <div class="flex-1 p-4 md:p-8 overflow-y-auto flex flex-col">
                <div class="w-full max-w-6xl mx-auto space-y-6 h-full flex flex-col">
                    
                    <div id="player-wrapper" class="w-full bg-black rounded-2xl shadow-2xl overflow-hidden border border-white/10 relative aspect-video flex-shrink-0 flex items-center justify-center group">
                        <div id="player-placeholder" class="text-center p-8">
                            <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
                                <i data-lucide="loader-2" class="w-8 h-8 text-slate-600 animate-spin"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-500">Cargando contenido...</h3>
                        </div>
                        <div id="player-content" class="w-full h-full hidden"></div>
                    </div>

                    <div class="flex flex-col md:flex-row gap-4 justify-between items-start md:items-center pb-10 sticky bottom-0 z-20 py-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-1">
                                <h2 id="current-lesson-title" class="text-xl md:text-2xl font-bold text-white leading-tight">...</h2>
                                <span id="check-completed" class="hidden bg-green-500/20 text-green-400 text-[10px] px-2 py-0.5 rounded font-bold uppercase border border-green-500/30 flex items-center gap-1">
                                    <i data-lucide="check" class="w-3 h-3"></i> Completada
                                </span>
                            </div>
                            <button onclick="marcarComoCompletada()" id="btn-mark-done" class="text-xs font-bold text-slate-400 hover:text-white flex items-center gap-2 transition-colors cursor-pointer select-none">
                                <div class="w-4 h-4 border-2 border-slate-500 rounded-sm flex items-center justify-center group-hover:border-white transition-colors" id="btn-mark-icon"></div> 
                                Marcar como vista
                            </button>
                        </div>
                        <div class="flex gap-3 w-full md:w-auto">
                            <button id="btn-prev" class="flex-1 md:flex-none px-5 py-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold text-sm disabled:opacity-50 transition-all flex items-center justify-center gap-2" disabled>
                                <i data-lucide="chevron-left" class="w-4 h-4"></i> Anterior
                            </button>
                            <button id="btn-next" class="flex-1 md:flex-none px-5 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-bold text-sm shadow-lg disabled:opacity-50 transition-all flex items-center justify-center gap-2" disabled>
                                Siguiente <i data-lucide="chevron-right" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <aside class="w-80 bg-slate-950/95 border-l border-white/5 flex flex-col shrink-0 overflow-hidden absolute md:relative right-0 h-full z-20 transition-transform transform translate-x-full md:translate-x-0 backdrop-blur-xl" id="playlist-sidebar">
            <div class="p-4 border-b border-white/5 bg-slate-950 sticky top-0 z-10">
                <h3 class="font-bold text-slate-300 text-xs uppercase tracking-wider flex items-center gap-2">
                    <i data-lucide="list" class="w-3 h-3"></i> Temario del Curso
                </h3>
                <div class="h-1.5 w-full bg-slate-800 rounded-full mt-3 overflow-hidden">
                    <div class="h-full bg-green-500 w-0 transition-all duration-500" id="progress-bar"></div>
                </div>
                <p class="text-[10px] text-slate-500 mt-1 text-right"><span id="progress-text">0%</span> Completado</p>
            </div>
            <div id="modules-list" class="flex-1 overflow-y-auto p-3 space-y-3 pb-20">
                 <p class="text-center text-slate-600 text-xs py-10"><i data-lucide="loader-2" class="w-5 h-5 animate-spin mx-auto mb-2"></i> Cargando...</p>
            </div>
        </aside>

        <button onclick="toggleMobileMenu()" class="md:hidden absolute bottom-6 right-6 z-30 bg-indigo-600 text-white p-4 rounded-full shadow-xl">
            <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
        
        <button id="btn-tutor-toggle" onclick="toggleTutor()" class="fixed bottom-8 right-8 z-[100] group transition-all duration-300 hover:scale-110 cursor-pointer hidden md:block">
            <div class="relative">
                <div class="w-16 h-16 rounded-full bg-slate-900 p-1 shadow-2xl border-4 border-indigo-500 overflow-hidden relative z-10 flex items-center justify-center" id="tutor-btn-border">
                     <div class="w-full h-full bg-white rounded-full flex items-center justify-center relative overflow-hidden">
                        <span class="text-3xl doc-bounce select-none">ü¶â</span>
                        <span id="doc-badge-btn" class="absolute bottom-1 right-2 text-sm bg-white rounded-full w-5 h-5 flex items-center justify-center shadow-sm border border-indigo-100">üéì</span>
                     </div>
                </div>
                <div class="absolute bottom-0 right-0 w-4 h-4 bg-green-500 border-2 border-slate-900 rounded-full z-20 animate-pulse"></div>
            </div>
        </button>

        <div id="tutor-window" class="fixed bottom-28 right-4 md:right-8 z-[100] w-80 md:w-96 bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl flex flex-col hidden origin-bottom-right transform scale-95 opacity-0 h-[500px] transition-all duration-300">
            <div class="p-4 bg-indigo-600 border-b border-white/10 rounded-t-2xl flex justify-between items-center" id="tutor-header">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-white p-0.5 border border-white/20 overflow-hidden flex items-center justify-center relative">
                        <span class="text-xl select-none">ü¶â</span>
                        <span id="doc-badge-header" class="absolute -bottom-1 -right-1 text-[10px] bg-white rounded-full w-4 h-4 flex items-center justify-center border border-indigo-100">üéì</span>
                    </div>
                    <div>
                        <h3 class="font-bold text-white text-sm" id="tutor-name">Doc (Tutor)</h3>
                        <p class="text-[10px] text-white/80 font-medium">En l√≠nea ‚Ä¢ Ayuda al instante</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="borrarHistorial()" class="text-white/60 hover:text-white p-1" title="Borrar Chat"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    <button onclick="toggleTutor()" class="text-white/60 hover:text-white p-1"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
            </div>
            
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-900/95 text-sm">
            </div>
            
            <div class="px-3 py-2 bg-slate-950 flex gap-2 overflow-x-auto border-t border-slate-800 no-scrollbar">
                <button onclick="accionarTutor('quiz')" class="text-[10px] bg-slate-800 hover:bg-blue-600 text-blue-300 border border-slate-700 px-3 py-1.5 rounded-full whitespace-nowrap flex items-center gap-1 transition">üìù Quiz R√°pido</button>
                <button onclick="accionarTutor('resumen')" class="text-[10px] bg-slate-800 hover:bg-purple-600 text-purple-300 border border-slate-700 px-3 py-1.5 rounded-full whitespace-nowrap flex items-center gap-1 transition">‚ö° Resumir</button>
                <button onclick="accionarTutor('explicar')" class="text-[10px] bg-slate-800 hover:bg-green-600 text-green-300 border border-slate-700 px-3 py-1.5 rounded-full whitespace-nowrap flex items-center gap-1 transition">üí° Explicar Sencillo</button>
            </div>
            
            <div class="p-3 bg-slate-950 border-t border-slate-800 rounded-b-2xl">
                <form id="chat-form" class="flex gap-2 relative" onsubmit="enviarMensajeTutor(event)">
                    <input type="text" id="chat-input" class="flex-1 bg-slate-900 border border-slate-700 rounded-xl pl-4 pr-10 py-3 text-sm text-white focus:outline-none focus:border-indigo-500 transition shadow-inner" placeholder="Preg√∫ntale a Doc..." autocomplete="off">
                    <button type="submit" class="absolute right-4 top-1/2 -translate-y-1/2 text-indigo-500 hover:text-indigo-400" id="btn-send-chat"><i data-lucide="send-horizontal" class="w-5 h-5"></i></button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURACI√ìN SUPABASE
        // ============================================
        const PROJECT_URL = 'https://vxggatcfrywyodovjwxj.supabase.co';
        const PUBLIC_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4Z2dhdGNmcnl3eW9kb3Zqd3hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzM5MjgsImV4cCI6MjA4MzgwOTkyOH0.RZ9jhEASO6nCV8EnzrHQBhglP4G1nik9Z5osPXysGNg';
        const db = supabase.createClient(PROJECT_URL, PUBLIC_KEY);

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let flatLessons = [];
        let currentLessonIndex = -1;
        let completedLessons = new Set();
        let currentCourseId = null;
        let currentUser = null; 
        let userInstitutionId = null; 
        let institutionContext = "";
        let areaContext = "";
        let isChatOpen = false;
        let jitsiApi = null;

        // ============================================
        // 1. INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            
            // Verificar sesi√≥n
            const { data: { session } } = await db.auth.getSession();
            if(!session) {
                window.location.href = './login.html';
                return;
            }
            
            currentUser = session.user; 

            // Obtener curso de URL
            const params = new URLSearchParams(window.location.search);
            currentCourseId = params.get('id');

            if(!currentCourseId) {
                toast("No se especific√≥ curso", "error");
                setTimeout(() => window.location.href = './mi-campus.html', 2000);
                return;
            }

            // Cargar datos
            await cargarDatosUsuario();
            await cargarCurso(currentCourseId);
        });

        // ============================================
        // 2. CARGAR DATOS USUARIO (CORREGIDO PARA M√öLTIPLES MATR√çCULAS)
        // ============================================
        async function cargarDatosUsuario() {
            try {
                // A. Intentar obtener DNI de la sesi√≥n
                let dniDelAlumno = currentUser.user_metadata?.dni;

                // B. Fallback a perfiles
                if (!dniDelAlumno) {
                    const { data: perfil } = await db.from('perfiles').select('dni').eq('id', currentUser.id).maybeSingle();
                    if (perfil) dniDelAlumno = perfil.dni;
                }

                if (!dniDelAlumno) {
                    console.warn("DNI no identificado");
                    document.getElementById('student-name').innerText = "Estudiante";
                    return;
                }

                // C. Buscar TODAS las matr√≠culas del alumno
                const { data: todasMatriculas, error: errorMatriculas } = await db
                    .from('matriculas')
                    .select('nombre, apellido, foto_url, institution_id, curso_id')
                    .eq('dni_alumno', dniDelAlumno);

                if (errorMatriculas) {
                    console.error("Error consultando matr√≠culas:", errorMatriculas);
                    throw new Error("Error al consultar matr√≠culas");
                }

                if (!todasMatriculas || todasMatriculas.length === 0) {
                    console.warn("No se encontraron matr√≠culas para DNI:", dniDelAlumno);
                    document.getElementById('student-name').innerText = 'Estudiante';
                    return;
                }

                // D. ENCONTRAR LA MATR√çCULA QUE CORRESPONDE AL CURSO ACTUAL
                let matriculaCorrecta = null;
                
                // Opci√≥n 1: Buscar por curso_id si est√° disponible
                if (currentCourseId) {
                    matriculaCorrecta = todasMatriculas.find(m => m.curso_id === currentCourseId);
                }
                
                // Opci√≥n 2: Si no encontramos por curso_id, tomar la primera
                if (!matriculaCorrecta && todasMatriculas.length > 0) {
                    matriculaCorrecta = todasMatriculas[0];
                    console.log("Usando primera matr√≠cula de", todasMatriculas.length, "disponibles");
                }

                if (matriculaCorrecta) {
                    const nombre = matriculaCorrecta.nombre || '';
                    const apellido = matriculaCorrecta.apellido || '';
                    const nombreCompleto = `${nombre} ${apellido}`.trim() || "Estudiante";
                    
                    document.getElementById('student-name').innerText = nombreCompleto;
                    userInstitutionId = matriculaCorrecta.institution_id;

                    if (matriculaCorrecta.foto_url) {
                        const img = document.getElementById('user-photo-header');
                        if(img) {
                            img.src = matriculaCorrecta.foto_url;
                            img.classList.remove('hidden');
                        }
                    }
                    
                    console.log(`‚úÖ Matr√≠cula seleccionada: ${nombreCompleto}, Instituci√≥n: ${userInstitutionId}`);
                }
                
            } catch (e) {
                console.error("Error cargando perfil:", e);
                document.getElementById('student-name').innerText = 'Estudiante';
            }
        }

        // ============================================
        // 3. CARGAR CURSO
        // ============================================
        async function cargarCurso(id) {
            try {
                // Paso 1: Cargar Curso
                const { data: cursoResult, error: cursoError } = await db
                    .from('cursos_oficiales')
                    .select('*, areas(*)') 
                    .eq('id', id);
                    
                if(cursoError) throw cursoError;
                
                if(!cursoResult || cursoResult.length === 0) {
                    toast("Curso no encontrado", "error");
                    setTimeout(() => window.location.href = './mi-campus.html', 2000);
                    return;
                }
                
                const curso = cursoResult[0];

                // Paso 2: Cargar Instituci√≥n (Manual)
                const instId = curso.institution_id || curso.institucion_id;
                if (instId) {
                    const { data: instData } = await db.from('instituciones').select('*').eq('id', instId).maybeSingle();
                    if (instData) curso.instituciones = instData;
                }

                // --- UI ---
                document.getElementById('course-title').innerText = curso.nombre || "Curso";
                
                // Branding
                if (curso.instituciones) {
                    const inst = curso.instituciones;
                    document.getElementById('inst-name-header').innerText = inst.nombre || "Campus Virtual";
                    institutionContext = `Instituci√≥n: ${inst.nombre}.`;

                    if (inst.logo_url) {
                        const logo = document.getElementById('header-logo');
                        logo.src = inst.logo_url;
                        document.getElementById('header-logo-container').classList.remove('hidden');
                        document.getElementById('header-logo-container').classList.add('flex');
                    }
                    
                    if (inst.color_primario) {
                        document.getElementById('top-header').style.borderBottomColor = inst.color_primario;
                        document.getElementById('tutor-header').style.backgroundColor = inst.color_primario;
                    }
                }

                // Contexto IA
                if (curso.areas) {
                    areaContext = curso.areas.nombre || "";
                    if(curso.areas.prompt_especifico) areaContext += `. ${curso.areas.prompt_especifico}`;
                }
                
                // Personalidad
                updateDocPersonality((curso.nombre + " " + areaContext).toLowerCase());

                // Parsear Contenido
                let contenido = [];
                if (typeof curso.contenido === 'string') {
                    try { contenido = JSON.parse(curso.contenido); } catch (e) { contenido = []; }
                } else if (Array.isArray(curso.contenido)) {
                    contenido = curso.contenido;
                }

                renderizarTemario(contenido);
                await cargarProgreso(id); 

                if (flatLessons.length > 0) {
                    let targetIndex = flatLessons.findIndex(l => !completedLessons.has(l.uniqueId));
                    if (targetIndex === -1) targetIndex = 0; 
                    cargarClase(targetIndex);
                } else {
                    document.getElementById('player-placeholder').innerHTML = '<div class="text-center p-10"><h3 class="text-white font-bold">Contenido en preparaci√≥n</h3></div>';
                }

            } catch (error) {
                console.error("Error cr√≠tico cargando curso:", error);
                toast("Error t√©cnico: " + error.message, "error");
            }
        }

        // ============================================
        // 4. FUNCIONES DE UTILIDAD
        // ============================================
        
        function toast(msg, type='info') {
            const t = document.createElement('div');
            let colorClass = 'bg-blue-600';
            if (type === 'error') colorClass = 'bg-red-500';
            if (type === 'success') colorClass = 'bg-green-500';

            t.className = `fixed top-5 right-5 z-50 px-4 py-2 rounded shadow-lg text-white ${colorClass} fade-in`;
            t.innerText = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        function updateDocPersonality(contexto) {
            let icon = 'üéì'; 
            let role = 'Tutor Acad√©mico';

            if(contexto.includes('salud') || contexto.includes('medicin') || contexto.includes('enferme')) { 
                icon = 'ü©∫'; role = 'Tutor de Salud'; 
            } else if(contexto.includes('forense') || contexto.includes('criminal')) { 
                icon = 'üîé'; role = 'Investigador Forense'; 
            } else if(contexto.includes('deporte') || contexto.includes('entrena') || contexto.includes('gym')) { 
                icon = '‚öΩ'; role = 'Coach Deportivo'; 
            } else if(contexto.includes('legal') || contexto.includes('juridic')) { 
                icon = '‚öñÔ∏è'; role = 'Asesor Legal'; 
            } else if(contexto.includes('rescat') || contexto.includes('emergen')) { 
                icon = '‚õëÔ∏è'; role = 'Instructor de Rescate'; 
            }
            
            const badgeBtn = document.getElementById('doc-badge-btn');
            const badgeHead = document.getElementById('doc-badge-header');
            const nameEl = document.getElementById('tutor-name');

            if(badgeBtn) badgeBtn.innerText = icon;
            if(badgeHead) badgeHead.innerText = icon;
            if(nameEl) nameEl.innerText = `Doc (${role})`;
        }

        // ============================================
        // 5. CARGAR PROGRESO
        // ============================================
        async function cargarProgreso(cursoId) {
            try {
                const { data } = await db.from('progreso_alumnos')
                    .select('clases_vistas')
                    .eq('student_id', currentUser.id)
                    .eq('curso_id', cursoId)
                    .maybeSingle();
                
                if (data && data.clases_vistas) {
                    completedLessons = new Set(data.clases_vistas);
                    actualizarBarraProgreso();
                    
                    flatLessons.forEach(l => {
                        if (completedLessons.has(l.uniqueId)) {
                            const btn = document.getElementById(`btn-lec-${l.index}`);
                            if(btn) {
                                const icon = btn.querySelector('i');
                                if(icon) {
                                    icon.setAttribute('data-lucide', 'check-circle-2');
                                    icon.classList.add('text-green-500', 'opacity-100');
                                    icon.classList.remove('opacity-50');
                                }
                            }
                        }
                    });
                    lucide.createIcons();
                }
            } catch (err) {
                console.error("Error cargando progreso:", err);
            }
        }

        // ============================================
        // 6. RENDERIZADO
        // ============================================
        function renderizarTemario(modulos) {
            const container = document.getElementById('modules-list');
            container.innerHTML = "";
            flatLessons = [];

            if (!modulos || modulos.length === 0) {
                container.innerHTML = `<p class="text-slate-500 text-center text-xs mt-10">Sin contenido</p>`;
                return;
            }

            modulos.forEach((mod, modIdx) => {
                const modDiv = document.createElement('div');
                modDiv.className = "mb-4";
                modDiv.innerHTML = `<div class="px-3 py-2 bg-slate-900/50 rounded-lg text-[10px] font-bold text-slate-400 uppercase tracking-wider border border-white/5 mb-1">${mod.titulo || 'M√≥dulo'}</div>`;
                
                const lessonsContainer = document.createElement('div');
                lessonsContainer.className = "space-y-1 pl-1";

                if (mod.lecciones && Array.isArray(mod.lecciones)) {
                    mod.lecciones.forEach((lec, lecIdx) => {
                        const globalIdx = flatLessons.length;
                        const uniqueId = `${modIdx}-${lecIdx}`;
                        
                        flatLessons.push({ ...lec, modIdx, uniqueId, index: globalIdx });

                        const btn = document.createElement('button');
                        btn.id = `btn-lec-${globalIdx}`;
                        btn.className = `w-full text-left px-3 py-3 rounded-lg flex items-center gap-3 text-xs transition-all border border-transparent text-slate-400 hover:bg-white/5 hover:text-white`;
                        btn.onclick = () => cargarClase(globalIdx);
                        
                        let icon = 'play-circle';
                        if(lec.tipo === 'PDF') icon = 'file-text';
                        if(lec.tipo === 'LIVE') icon = 'video';

                        btn.innerHTML = `
                            <i data-lucide="${icon}" class="w-4 h-4 opacity-50 shrink-0"></i>
                            <span class="truncate font-medium">${lec.titulo || 'Lecci√≥n'}</span>
                        `;
                        lessonsContainer.appendChild(btn);
                    });
                }
                modDiv.appendChild(lessonsContainer);
                container.appendChild(modDiv);
            });
            lucide.createIcons();
        }

        function cargarClase(index) {
            if (index < 0 || index >= flatLessons.length) return;
            
            if (jitsiApi) { jitsiApi.dispose(); jitsiApi = null; }

            document.querySelectorAll('[id^="btn-lec-"]').forEach(b => b.classList.remove('bg-indigo-600/20', 'border-indigo-500/30', 'text-white'));
            const activeBtn = document.getElementById(`btn-lec-${index}`);
            if(activeBtn) activeBtn.classList.add('bg-indigo-600/20', 'border-indigo-500/30', 'text-white');

            currentLessonIndex = index;
            const lec = flatLessons[index];
            
            document.getElementById('current-lesson-title').innerText = lec.titulo;
            document.getElementById('player-placeholder').classList.add('hidden');
            const contentDiv = document.getElementById('player-content');
            contentDiv.classList.remove('hidden');
            contentDiv.innerHTML = ''; 

            if (lec.tipo === 'VIDEO' || !lec.tipo) {
                 if (lec.url && (lec.url.includes('youtube') || lec.url.includes('youtu.be'))) {
                    let videoId = lec.url.split('v=')[1];
                    const ampersandPosition = videoId ? videoId.indexOf('&') : -1;
                    if(ampersandPosition !== -1) videoId = videoId.substring(0, ampersandPosition);
                    if(!videoId && lec.url.includes('youtu.be')) videoId = lec.url.split('/').pop();

                    contentDiv.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0" class="w-full h-full" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
                 } else {
                     contentDiv.innerHTML = `<div class="flex h-full items-center justify-center text-white p-10 text-center"><p>Video no disponible.</p></div>`;
                 }
            } else if (lec.tipo === 'LIVE') {
                contentDiv.innerHTML = `<div id="jitsi-container" class="w-full h-full bg-slate-900"></div>`;
                iniciarJitsi(lec.url);
            } else if (lec.tipo === 'PDF') {
                 contentDiv.innerHTML = `
                    <div class="flex flex-col h-full items-center justify-center text-white gap-4 p-6 text-center">
                        <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center"><i data-lucide="file-text" class="w-10 h-10 text-red-500"></i></div>
                        <h3 class="text-xl font-bold">Material de Lectura</h3>
                        <a href="${lec.url}" target="_blank" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl font-bold transition flex items-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i> Abrir Documento
                        </a>
                    </div>`;
                 lucide.createIcons();
            }

            actualizarBotonesNav();
            checkSiCompletado(lec.uniqueId);
        }

        // ============================================
        // 7. FUNCIONES EXTRA (JITSI, PROGRESO, GEMINI)
        // ============================================
        function iniciarJitsi(roomName) {
            const domain = 'meet.jit.si';
            const safeRoom = (roomName || `ASARI_CLASS_${currentCourseId}`).replace(/[^a-zA-Z0-9]/g, '');
            const options = {
                roomName: safeRoom,
                width: '100%',
                height: '100%',
                parentNode: document.querySelector('#jitsi-container'),
                configOverwrite: { startWithAudioMuted: true, prejoinPageEnabled: false },
                interfaceConfigOverwrite: { SHOW_JITSI_WATERMARK: false },
                userInfo: { displayName: document.getElementById('student-name').innerText }
            };
            jitsiApi = new JitsiMeetExternalAPI(domain, options);
        }

        async function marcarComoCompletada() {
            if (currentLessonIndex === -1) return;
            const lec = flatLessons[currentLessonIndex];
            
            if (!completedLessons.has(lec.uniqueId)) {
                completedLessons.add(lec.uniqueId);
                actualizarBarraProgreso();
                checkSiCompletado(lec.uniqueId);
                
                await db.from('progreso_alumnos').upsert({
                    student_id: currentUser.id,
                    curso_id: currentCourseId,
                    clases_vistas: Array.from(completedLessons),
                    ultimo_acceso: new Date().toISOString()
                }, { onConflict: 'student_id, curso_id' });

                toast("Lecci√≥n completada", "success");
            }
            
            if (currentLessonIndex < flatLessons.length - 1) {
                cargarClase(currentLessonIndex + 1);
            }
        }

        function checkSiCompletado(uniqueId) {
            const btn = document.getElementById('btn-mark-done');
            const badge = document.getElementById('check-completed');
            if (completedLessons.has(uniqueId)) {
                badge.classList.remove('hidden');
                btn.innerHTML = `<span class="text-green-400 flex items-center gap-1">Siguiente <i data-lucide="arrow-right" class="w-3 h-3"></i></span>`;
            } else {
                badge.classList.add('hidden');
                btn.innerHTML = `Marcar como vista`;
            }
        }

        function actualizarBarraProgreso() {
            const total = flatLessons.length;
            if (total === 0) return;
            const completadas = completedLessons.size;
            const porcentaje = Math.round((completadas / total) * 100);
            document.getElementById('progress-bar').style.width = `${porcentaje}%`;
            document.getElementById('progress-text').innerText = `${porcentaje}%`;
        }

        function actualizarBotonesNav() {
            document.getElementById('btn-prev').disabled = currentLessonIndex <= 0;
            document.getElementById('btn-next').disabled = currentLessonIndex >= flatLessons.length - 1;
            document.getElementById('btn-prev').onclick = () => cargarClase(currentLessonIndex - 1);
            document.getElementById('btn-next').onclick = () => cargarClase(currentLessonIndex + 1);
        }

        // --- GEMINI 1.5 FLASH ---
        async function consultarGemini(prompt) {
            const loadingId = mostrarLoading();
            try {
                const { data: secretResult } = await db.from('app_secrets').select('value').eq('name', 'gemini_api_key');
                if(!secretResult || !secretResult.length) throw new Error("API Key no encontrada");
                
                const apiKey = secretResult[0].value?.trim();
                const model = 'gemini-1.5-flash'; 
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.7, maxOutputTokens: 1000 }
                    })
                });

                if(!response.ok) throw new Error("Error en IA: " + response.statusText);

                const data = await response.json();
                removerLoading(loadingId);
                const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "No pude responder.";
                agregarBurbujaTutor(marked.parse(reply), 'bot');

            } catch(error) {
                removerLoading(loadingId);
                agregarBurbujaTutor(`‚ö†Ô∏è ${error.message}`, 'bot');
            }
        }

        // --- UTILS UI ---
        function mostrarLoading() {
            const container = document.getElementById('chat-messages');
            const id = 'load-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex gap-3 chat-bubble";
            div.innerHTML = `<div class="w-8 h-8 rounded-full bg-white overflow-hidden shrink-0 border border-indigo-500 mt-1 flex items-center justify-center"><span class="text-sm">ü¶â</span></div><div class="bg-slate-800 p-4 rounded-2xl rounded-tl-none border border-slate-700 flex gap-1 items-center h-10"><span class="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-bounce"></span><span class="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-bounce delay-100"></span><span class="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-bounce delay-200"></span></div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return id;
        }

        function removerLoading(id) {
            const el = document.getElementById(id);
            if(el) el.remove();
        }

        function agregarBurbujaTutor(htmlContent, type) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            
            if (type === 'user') {
                div.className = "flex gap-3 flex-row-reverse chat-bubble";
                div.innerHTML = `<div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center shrink-0"><i data-lucide="user" class="w-4 h-4 text-slate-300"></i></div><div class="bg-indigo-600 text-white text-sm p-3 rounded-2xl rounded-tr-none shadow-md max-w-[85%]">${htmlContent}</div>`;
            } else {
                const badge = document.getElementById('doc-badge-header').innerText;
                div.className = "flex gap-3 chat-bubble";
                div.innerHTML = `<div class="w-8 h-8 rounded-full bg-white overflow-hidden shrink-0 border border-indigo-500 mt-1 flex items-center justify-center relative"><span class="text-sm select-none">ü¶â</span><span class="absolute -bottom-1 -right-1 text-[8px] bg-white rounded-full w-3 h-3 flex items-center justify-center border border-indigo-100">${badge}</span></div><div class="bg-slate-800 text-slate-200 text-sm p-3 rounded-2xl rounded-tl-none border border-slate-700 shadow-md max-w-[90%] prose prose-invert prose-sm leading-snug">${htmlContent}</div>`;
            }
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            lucide.createIcons();
        }

        function borrarHistorial() { document.getElementById('chat-messages').innerHTML = ''; }
        function toggleTutor() { 
            const win = document.getElementById('tutor-window');
            win.classList.toggle('hidden');
            win.classList.remove('scale-95', 'opacity-0');
            if(!win.classList.contains('hidden')) document.getElementById('chat-input').focus();
        }
        function toggleMobileMenu() { document.getElementById('playlist-sidebar').classList.toggle('translate-x-full'); }

        async function enviarMensajeTutor(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) { toast("Escribe un mensaje", "error"); return; }
            agregarBurbujaTutor(text, 'user');
            input.value = "";
            const leccionActual = document.getElementById('current-lesson-title').innerText;
            const docName = document.getElementById('tutor-name').innerText;
            const prompt = `ROLE: Eres "${docName}", un asistente educativo representado por un B√∫ho Sabio. TONO: Pedag√≥gico, alentador. CONTEXTO INSTITUCIONAL: ${institutionContext} CONTEXTO DEL √ÅREA: ${areaContext} LECCI√ìN ACTUAL: "${leccionActual}" PREGUNTA: "${text}"`;
            await consultarGemini(prompt);
        }
        
        function accionarTutor(accion) {
            const leccion = document.getElementById('current-lesson-title').innerText;
            if(accion === 'quiz') {
                agregarBurbujaTutor('Hazme un examen r√°pido.', 'user');
                consultarGemini(`Genera un examen corto de 3 preguntas multiple choice sobre: "${leccion}". Formato Markdown.`);
            } else if (accion === 'resumen') {
                agregarBurbujaTutor('Resumir esta clase.', 'user');
                consultarGemini(`Dame los 3 puntos clave de: "${leccion}".`);
            } else if (accion === 'explicar') {
                agregarBurbujaTutor('Expl√≠came esto sencillo.', 'user');
                consultarGemini(`Explica el concepto de "${leccion}" con una analog√≠a simple.`);
            }
        }
    </script>
</body>
</html>
