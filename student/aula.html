<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aula Virtual | Campus ASARI</title>
    <script src='https://meet.jit.si/external_api.js'></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; background: black; border-radius: 12px; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        #tutor-window { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .chat-bubble { animation: popIn 0.3s ease-out; }
        @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 h-screen flex flex-col overflow-hidden font-sans">

    <header id="top-header" class="h-16 bg-slate-950 border-b border-slate-800 flex items-center justify-between px-4 md:px-6 shrink-0 z-20 transition-colors duration-500">
        <div class="flex items-center gap-4">
            <a href="dashboard.html" class="p-2 hover:bg-slate-800 rounded-lg transition text-slate-400 hover:text-white"><i data-lucide="arrow-left" class="w-5 h-5"></i></a>
            <div>
                <h1 class="font-bold text-white text-sm md:text-lg leading-tight truncate max-w-[200px] md:max-w-md" id="course-title">Cargando curso...</h1>
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Campus Virtual</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="hidden md:block text-right">
                <p class="text-sm font-bold text-white" id="student-name">Estudiante</p>
                <div class="flex items-center justify-end gap-1.5"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span><p class="text-[10px] text-green-500 font-bold uppercase">En L√≠nea</p></div>
            </div>
            <div id="user-avatar-ui" class="w-9 h-9 bg-blue-600 rounded-full flex items-center justify-center font-bold text-white shadow-lg"><i data-lucide="user" class="w-4 h-4"></i></div>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden relative">
        <main class="flex-1 flex flex-col min-w-0 bg-slate-900 relative z-10">
            <div class="flex-1 p-4 md:p-8 overflow-y-auto flex flex-col">
                <div class="w-full max-w-6xl mx-auto space-y-6 h-full flex flex-col">
                    <div id="player-wrapper" class="w-full bg-black rounded-2xl shadow-2xl overflow-hidden border border-slate-800 relative aspect-video flex-shrink-0 flex items-center justify-center group">
                        <div id="player-placeholder" class="text-center p-8">
                            <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse"><i data-lucide="loader-2" class="w-8 h-8 text-slate-600 animate-spin"></i></div>
                            <h3 class="text-xl font-bold text-slate-500">Preparando clase...</h3>
                        </div>
                        <div id="player-content" class="w-full h-full hidden"></div>
                        <div id="jitsi-rescue" class="hidden absolute top-4 right-4 z-50">
                            <a id="jitsi-external-link" href="#" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold px-4 py-2 rounded-full shadow-lg flex items-center gap-2 transition-all opacity-50 hover:opacity-100"><i data-lucide="external-link" class="w-3 h-3"></i> Abrir en Nueva Pesta√±a</a>
                        </div>
                    </div>
                    <div class="flex flex-col md:flex-row gap-4 justify-between items-start md:items-center pb-10 bg-slate-900 sticky bottom-0 z-20 py-4 border-t border-slate-800/50">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-1">
                                <h2 id="current-lesson-title" class="text-xl md:text-2xl font-bold text-white leading-tight">...</h2>
                                <span id="check-completed" class="hidden bg-green-500/20 text-green-400 text-[10px] px-2 py-0.5 rounded font-bold uppercase border border-green-500/30 flex items-center gap-1"><i data-lucide="check" class="w-3 h-3"></i> Completada</span>
                            </div>
                            <button onclick="marcarComoCompletada()" id="btn-mark-done" class="text-xs font-bold text-slate-400 hover:text-white flex items-center gap-2 transition-colors cursor-pointer select-none">
                                <div class="w-4 h-4 border-2 border-slate-500 rounded-sm flex items-center justify-center group-hover:border-white transition-colors" id="btn-mark-icon"></div>
                                Marcar como vista
                            </button>
                        </div>
                        <div class="flex gap-3 w-full md:w-auto">
                            <button id="btn-prev" class="flex-1 md:flex-none px-5 py-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold text-sm disabled:opacity-50 transition-all flex items-center justify-center gap-2" disabled><i data-lucide="chevron-left" class="w-4 h-4"></i> Anterior</button>
                            <button id="btn-next" class="flex-1 md:flex-none px-5 py-2.5 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold text-sm shadow-lg disabled:opacity-50 transition-all flex items-center justify-center gap-2" disabled>Siguiente <i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <aside class="w-80 bg-slate-950 border-l border-slate-800 flex flex-col shrink-0 overflow-hidden absolute md:relative right-0 h-full z-20 transition-transform transform translate-x-full md:translate-x-0" id="playlist-sidebar">
            <div class="p-4 border-b border-slate-800 bg-slate-950 sticky top-0 z-10">
                <h3 class="font-bold text-slate-300 text-xs uppercase tracking-wider flex items-center gap-2"><i data-lucide="list" class="w-3 h-3"></i> Contenido</h3>
                <div class="h-1.5 w-full bg-slate-800 rounded-full mt-3 overflow-hidden"><div class="h-full bg-green-500 w-0 transition-all duration-500" id="progress-bar"></div></div>
                <p class="text-[10px] text-slate-500 mt-1 text-right"><span id="progress-text">0%</span> Completado</p>
            </div>
            <div id="modules-list" class="flex-1 overflow-y-auto p-3 space-y-3">
                 <p class="text-center text-slate-600 text-xs py-10"><i data-lucide="loader-2" class="w-5 h-5 animate-spin mx-auto mb-2"></i> Cargando...</p>
            </div>
        </aside>

        <button onclick="toggleMobileMenu()" class="md:hidden absolute bottom-6 right-6 z-30 bg-blue-600 text-white p-4 rounded-full shadow-xl"><i data-lucide="menu" class="w-6 h-6"></i></button>

        <button onclick="toggleTutor()" class="fixed bottom-8 right-8 z-50 group transition-all duration-300 hover:scale-110">
            <div class="relative">
                <div class="w-16 h-16 rounded-full bg-white p-1 shadow-2xl border-4 border-indigo-500 overflow-hidden relative z-10"><img id="tutor-btn-img" src="https://cdn-icons-png.flaticon.com/512/3468/3468283.png" class="w-full h-full object-contain"></div>
                <div class="absolute bottom-0 right-0 w-4 h-4 bg-green-500 border-2 border-slate-900 rounded-full z-20 animate-pulse"></div>
            </div>
        </button>

        <div id="tutor-window" class="fixed bottom-28 right-4 md:right-8 z-50 w-80 md:w-96 bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl flex flex-col hidden origin-bottom-right transform scale-95 opacity-0 h-[500px] transition-all duration-300">
            <div class="p-4 bg-gradient-to-r from-slate-900 to-slate-800 border-b border-slate-700 rounded-t-2xl flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-white p-0.5 border border-white/10 overflow-hidden"><img id="tutor-header-img" src="https://cdn-icons-png.flaticon.com/512/3468/3468283.png" class="w-full h-full object-contain"></div>
                    <div><h3 class="font-bold text-white text-sm">Hola, soy Doc.</h3><p class="text-[10px] text-green-400 font-medium" id="tutor-status">Tutor Virtual</p></div>
                </div>
                <div class="flex gap-2">
                    <button onclick="borrarHistorial()" class="text-slate-500 hover:text-red-400 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    <button onclick="toggleTutor()" class="text-slate-400 hover:text-white p-1"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-900/95"></div>
            <div class="px-3 py-2 bg-slate-900 flex gap-2 overflow-x-auto border-t border-slate-800 no-scrollbar">
                <button onclick="accionarTutor('quiz')" class="text-[11px] bg-slate-800 hover:bg-blue-600 text-blue-300 border border-slate-700 px-3 py-1.5 rounded-full whitespace-nowrap flex items-center gap-1">üìù Examen</button>
                <button onclick="accionarTutor('resumen')" class="text-[11px] bg-slate-800 hover:bg-purple-600 text-purple-300 border border-slate-700 px-3 py-1.5 rounded-full whitespace-nowrap flex items-center gap-1">‚ö° Resumen</button>
                <button onclick="accionarTutor('explicar')" class="text-[11px] bg-slate-800 hover:bg-green-600 text-green-300 border border-slate-700 px-3 py-1.5 rounded-full whitespace-nowrap flex items-center gap-1">üí° Explicar</button>
            </div>
            <div class="p-3 bg-slate-950 border-t border-slate-800 rounded-b-2xl">
                <form id="chat-form" class="flex gap-2 relative" onsubmit="enviarMensajeTutor(event)">
                    <input type="text" id="chat-input" class="flex-1 bg-slate-900 border border-slate-700 rounded-xl pl-4 pr-10 py-3 text-sm text-white focus:outline-none focus:border-indigo-500 transition shadow-inner" placeholder="Escribe tu duda..." autocomplete="off">
                    <button type="submit" class="absolute right-4 top-1/2 -translate-y-1/2 text-indigo-500 hover:text-indigo-400"><i data-lucide="send-horizontal" class="w-5 h-5"></i></button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const PROJECT_URL = 'https://vxggatcfrywyodovjwxj.supabase.co';
        const PUBLIC_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4Z2dhdGNmcnl3eW9kb3Zqd3hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzM5MjgsImV4cCI6MjA4MzgwOTkyOH0.RZ9jhEASO6nCV8EnzrHQBhglP4G1nik9Z5osPXysGNg';
        const db = supabase.createClient(PROJECT_URL, PUBLIC_KEY);

        // --- CONFIGURACI√ìN CR√çTICA (ACTUALIZADA 2026) ---
        const API_KEY_GOOGLE = 'AIzaSyAkZT7qHxVuhMgjzf-BlOPIyHx2hHGaj7U';
        let detectedModel = null; 

        // Lista Oficial de Modelos Vigentes 2026 (Prioridad de mejor a peor)
        const MODEL_PRIORITY = [
            'gemini-2.5-flash',       // EST√ÅNDAR ORO (2026)
            'gemini-2.5-flash-lite',  // EST√ÅNDAR PLATA
            'gemini-3-flash-preview', // FUTURO
            'gemini-1.5-flash-002',   // LEGACY ESTABLE (Si existe)
            'gemini-2.0-flash'        // LEGACY 
        ];

        let flatLessons = [], currentLessonIndex = -1, jitsiApi = null, completedLessons = new Set();
        let currentCourseId = null, currentUserId = null;
        const AVATARS = { 'salud': 'https://cdn-icons-png.flaticon.com/512/3304/3304567.png', 'deporte': 'https://cdn-icons-png.flaticon.com/512/5305/5305149.png', 'default': 'https://cdn-icons-png.flaticon.com/512/3468/3468283.png' };
        let currentAvatarUrl = AVATARS['default'];
        let currentRole = "Profesor General";

        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            const { data: { session } } = await db.auth.getSession();
            if(!session) return window.location.href = '../index.html';
            currentUserId = session.user.id;
            
            const { data: perfil } = await db.from('perfiles').select('nombre_completo').eq('id', currentUserId).single();
            if(perfil) document.getElementById('student-name').innerText = perfil.nombre_completo;

            const params = new URLSearchParams(window.location.search);
            currentCourseId = params.get('id');
            if(currentCourseId) await cargarCurso(currentCourseId); else window.location.href = 'dashboard.html';
        });

        // --- SISTEMA DE DETECCI√ìN INTELIGENTE ---
        async function getWorkingModel() {
            if (detectedModel) return detectedModel;

            // 1. Intentar descargar la lista real de tu cuenta
            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY_GOOGLE}`);
                const d = await r.json();
                
                if (d.models) {
                    const disponibles = d.models
                        .filter(m => m.supportedGenerationMethods.includes("generateContent"))
                        .map(m => m.name.replace("models/", ""));
                    
                    // Buscar coincidencia con nuestra lista de prioridad
                    for (const ideal of MODEL_PRIORITY) {
                        if (disponibles.includes(ideal)) {
                            detectedModel = ideal;
                            console.log("‚úÖ Modelo Oficial Detectado:", detectedModel);
                            return detectedModel;
                        }
                    }
                    
                    // Si no est√° en nuestra lista, agarrar el primer "flash" que haya
                    const fallbackFlash = disponibles.find(m => m.includes("flash"));
                    if (fallbackFlash) {
                        detectedModel = fallbackFlash;
                        return detectedModel;
                    }
                }
            } catch (e) { console.warn("Fallo listado autom√°tico, usando hardcoded..."); }

            // 2. Si falla el listado, probar Fuerza Bruta con el est√°ndar 2026
            detectedModel = "gemini-2.5-flash"; 
            return detectedModel;
        }

        async function consultarGemini(prompt) { 
            const loadingId = mostrarLoading(); 
            const container = document.getElementById('chat-messages');
            container.scrollTop = container.scrollHeight;
            
            try {
                const modelo = await getWorkingModel();
                
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelo}:generateContent?key=${API_KEY_GOOGLE}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                removerLoading(loadingId);
                
                if(data.error) {
                    console.error("Error API:", data.error);
                    // Si falla por 404, reseteamos el modelo para que busque otro la pr√≥xima
                    if(data.error.code === 404) detectedModel = null;
                    throw new Error(data.error.message);
                }
                
                if(!data.candidates || !data.candidates[0]) throw new Error("Sin respuesta de IA");
                
                agregarBurbujaTutor(data.candidates[0].content.parts[0].text, 'bot'); 

            } catch(e) { 
                removerLoading(loadingId); 
                console.error(e);
                let msg = `‚ö†Ô∏è Error de conexi√≥n: ${e.message}`;
                if(e.message.includes("404")) msg = "‚ö†Ô∏è Modelo no encontrado. Reintentando...";
                agregarBurbujaTutor(msg, 'bot'); 
            } 
        }

        // --- FUNCIONES RESTANTES ---
        async function cargarCurso(id) {
            const { data: curso, error } = await db.from('cursos_oficiales').select('*').eq('id', id).single();
            if(error || !curso) { alert("Error cargando curso"); return window.location.href = 'dashboard.html'; }
            document.getElementById('course-title').innerText = curso.nombre;
            personalizarDoc(curso.registro_id);
            if(curso.institution_id) aplicarBranding(curso.institution_id);
            const { data: progreso } = await db.from('progreso_alumnos').select('clases_vistas').eq('student_id', currentUserId).eq('curso_id', id).single();
            if(progreso && progreso.clases_vistas) completedLessons = new Set(progreso.clases_vistas);
            renderizarTemario(curso.contenido);
            let targetIndex = 0; for(let i=0; i<flatLessons.length; i++) if(!completedLessons.has(flatLessons[i].uniqueId)) { targetIndex = i; break; }
            if(completedLessons.size === flatLessons.length && flatLessons.length > 0) targetIndex = flatLessons.length - 1;
            cargarClase(targetIndex);
        }
        async function aplicarBranding(instId) { const { data: inst } = await db.from('instituciones').select('*').eq('id', instId).single(); if(inst && inst.color_primario) { document.getElementById('top-header').style.backgroundColor = inst.color_primario; document.getElementById('user-avatar-ui').style.backgroundColor = "rgba(255,255,255,0.2)"; } }
        function renderizarTemario(modulos) {
            const container = document.getElementById('modules-list'); container.innerHTML = ""; flatLessons = [];
            modulos.forEach((mod, modIdx) => {
                const modDiv = document.createElement('div'); modDiv.className = "space-y-1";
                modDiv.innerHTML = `<div class="px-3 py-2 bg-slate-900/50 rounded-lg text-[10px] font-bold text-slate-400 uppercase tracking-wider border border-slate-800/50">${mod.titulo}</div><div class="space-y-1 pl-1" id="mod-content-${modIdx}"></div>`;
                container.appendChild(modDiv);
                if(mod.lecciones) mod.lecciones.forEach((lec, lecIdx) => {
                    const idx = flatLessons.length; const uniqueId = `${modIdx}-${lecIdx}`; flatLessons.push({ ...lec, modIdx, uniqueId });
                    const btn = document.createElement('button'); btn.id = `btn-lec-${idx}`; const isCompleted = completedLessons.has(uniqueId);
                    btn.className = `w-full text-left px-3 py-3 rounded-lg flex items-center justify-between text-xs transition-all border border-transparent group ${isCompleted ? 'text-green-400' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`;
                    let icon = 'play-circle'; if(lec.tipo === 'PDF') icon = 'file-text'; if(lec.tipo === 'LIVE' || lec.tipo === 'ZOOM') icon = 'video';
                    const leftIcon = isCompleted ? `<i data-lucide="check-circle-2" class="w-4 h-4 text-green-500"></i>` : `<i data-lucide="${icon}" class="w-4 h-4 opacity-50 group-hover:opacity-100"></i>`;
                    btn.innerHTML = `<div class="flex items-center gap-3 overflow-hidden"><span class="shrink-0">${leftIcon}</span> <span class="truncate font-medium">${lec.titulo}</span></div>`;
                    btn.onclick = () => cargarClase(idx); modDiv.querySelector(`#mod-content-${modIdx}`).appendChild(btn);
                });
            }); lucide.createIcons(); actualizarBarraGlobal();
        }
        function cargarClase(index) {
            if(index < 0 || index >= flatLessons.length) return; if(jitsiApi) { jitsiApi.dispose(); jitsiApi = null; }
            document.getElementById('player-placeholder').classList.add('hidden'); document.getElementById('jitsi-rescue').classList.add('hidden');
            const container = document.getElementById('player-content'); container.innerHTML = ""; container.classList.remove('hidden');
            document.querySelectorAll('[id^="btn-lec-"]').forEach(b => b.classList.remove('bg-blue-600/20', 'border-blue-500/30'));
            const activeBtn = document.getElementById(`btn-lec-${index}`); if(activeBtn) activeBtn.classList.add('bg-blue-600/20', 'border-blue-500/30');
            currentLessonIndex = index; const lec = flatLessons[index]; document.getElementById('current-lesson-title').innerText = lec.titulo; actualizarBotonCompletado(completedLessons.has(lec.uniqueId));
            if(lec.tipo === 'VIDEO') { let url = lec.url || ""; if(url.includes('youtu')) { const videoId = url.split('v=')[1] || url.split('/').pop().split('?')[0]; container.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1" class="w-full h-full" frameborder="0" allowfullscreen></iframe>`; } else container.innerHTML = `<video src="${url}" controls class="w-full h-full bg-black"></video>`; } 
            else if (lec.tipo === 'PDF') { container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-center p-10 bg-slate-900 w-full"><i data-lucide="file-text" class="w-16 h-16 text-red-500 mb-4"></i><h3 class="text-xl font-bold text-white mb-2">Lectura</h3><a href="${lec.url}" target="_blank" onclick="marcarComoCompletada()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-bold flex gap-2"><i data-lucide="download" class="w-4 h-4"></i> Abrir PDF</a></div>`; lucide.createIcons(); } 
            else if (lec.tipo === 'ZOOM' || lec.tipo === 'LIVE') { container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-center bg-slate-900"><i data-lucide="video" class="w-12 h-12 text-blue-500 mb-4"></i><h3 class="font-bold text-white">Clase Externa</h3><a href="${lec.url}" target="_blank" onclick="marcarComoCompletada()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold mt-4">Unirse a la Reuni√≥n</a></div>`; lucide.createIcons(); }
            updateNavButtons(); if(window.innerWidth < 768) document.getElementById('playlist-sidebar').classList.add('translate-x-full');
        }
        async function marcarComoCompletada() {
            if(currentLessonIndex === -1) return; const lec = flatLessons[currentLessonIndex];
            if(completedLessons.has(lec.uniqueId)) { if(currentLessonIndex < flatLessons.length - 1) cargarClase(currentLessonIndex + 1); return; }
            completedLessons.add(lec.uniqueId); actualizarBotonCompletado(true); actualizarItemLista(currentLessonIndex, true); actualizarBarraGlobal();
            await db.from('progreso_alumnos').upsert({ student_id: currentUserId, curso_id: currentCourseId, clases_vistas: Array.from(completedLessons), updated_at: new Date().toISOString() }, { onConflict: 'student_id, curso_id' });
            setTimeout(() => { if(currentLessonIndex < flatLessons.length - 1) cargarClase(currentLessonIndex + 1); }, 800);
        }
        function actualizarBotonCompletado(isDone) { const btn = document.getElementById('btn-mark-done'); const badge = document.getElementById('check-completed'); if(isDone) { badge.classList.remove('hidden'); btn.innerHTML = `<span class="text-green-400 flex items-center gap-1">Siguiente <i data-lucide="arrow-right" class="w-3 h-3"></i></span>`; } else { badge.classList.add('hidden'); btn.innerHTML = `<div class="w-4 h-4 border-2 border-slate-500 rounded-sm flex items-center justify-center mr-2"></div> Marcar como vista`; } }
        function actualizarItemLista(idx, isDone) { const btn = document.getElementById(`btn-lec-${idx}`); if(btn && isDone) { btn.classList.remove('text-slate-400'); btn.classList.add('text-green-400'); btn.querySelector('span:first-child').innerHTML = `<i data-lucide="check-circle-2" class="w-4 h-4 text-green-500"></i>`; lucide.createIcons(); } }
        function actualizarBarraGlobal() { if(flatLessons.length === 0) return; const percent = Math.round((completedLessons.size / flatLessons.length) * 100); document.getElementById('progress-bar').style.width = `${percent}%`; document.getElementById('progress-text').innerText = `${percent}%`; }
        function updateNavButtons() { document.getElementById('btn-prev').disabled = currentLessonIndex <= 0; document.getElementById('btn-next').disabled = currentLessonIndex >= flatLessons.length - 1; document.getElementById('btn-prev').onclick = () => cargarClase(currentLessonIndex - 1); document.getElementById('btn-next').onclick = () => cargarClase(currentLessonIndex + 1); }
        function personalizarDoc(registroId) { let tipo = 'default'; let statusText = 'Tutor Acad√©mico'; if (registroId) { const rid = registroId.toLowerCase(); if(rid.includes('remaep') || rid.includes('salud')) { tipo = 'salud'; statusText = 'Experto en Salud'; } else if (rid.includes('isf') || rid.includes('deporte')) { tipo = 'deporte'; statusText = 'Coach Deportivo'; } } currentAvatarUrl = AVATARS[tipo]; currentRole = statusText; document.getElementById('tutor-btn-img').src = currentAvatarUrl; document.getElementById('tutor-header-img').src = currentAvatarUrl; document.getElementById('tutor-status').innerText = statusText; borrarHistorial(); }
        function toggleMobileMenu() { document.getElementById('playlist-sidebar').classList.toggle('translate-x-full'); }
        function toggleTutor() { const win = document.getElementById('tutor-window'); isChatOpen = !isChatOpen; if(isChatOpen) { win.classList.remove('hidden'); requestAnimationFrame(() => { win.classList.remove('scale-95', 'opacity-0'); document.getElementById('chat-input').focus(); }); } else { win.classList.add('scale-95', 'opacity-0'); setTimeout(() => win.classList.add('hidden'), 300); } }
        function borrarHistorial() { document.getElementById('chat-messages').innerHTML = `<div class="flex gap-3 chat-bubble"><div class="w-8 h-8 rounded-full bg-white overflow-hidden shrink-0 border border-indigo-500 mt-1 p-0.5"><img src="${currentAvatarUrl}" class="w-full h-full object-contain"></div><div class="bg-slate-800 text-slate-200 text-sm p-3 rounded-2xl rounded-tl-none border border-slate-700 shadow-md"><p>¬°Hola! Soy <b>Doc</b>. ü¶â</p></div></div>`; }
        function accionarTutor(accion) { if(accion === 'quiz') { agregarBurbujaTutor('Examen.', 'user'); consultarGemini('Genera examen 3 preguntas multiple choice sobre: ' + obtenerContexto() + '. Formato Markdown. Respuestas al final.'); } if(accion === 'resumen') { agregarBurbujaTutor('Resumen.', 'user'); consultarGemini('Resumen 3 puntos sobre: ' + obtenerContexto()); } if(accion === 'explicar') { agregarBurbujaTutor('Explicar.', 'user'); consultarGemini('Explica simple: ' + obtenerContexto()); } }
        async function enviarMensajeTutor(e) { e.preventDefault(); const t = document.getElementById('chat-input').value.trim(); if(!t) return; agregarBurbujaTutor(t, 'user'); document.getElementById('chat-input').value=""; consultarGemini(`Rol: ${currentRole}. Contexto: "${obtenerContexto()}". Pregunta: "${t}". Responde breve.`); }
        function obtenerContexto() { return `${document.getElementById('current-lesson-title').innerText} (Curso: ${document.getElementById('course-title').innerText})`; }
        function agregarBurbujaTutor(t, k) { const c = document.getElementById('chat-messages'); const d = document.createElement('div'); const h = t.replace(/\*\*(.*?)\*\*/g, '<b class="text-white">$1</b>').replace(/\n/g, '<br>'); d.className = k==='user' ? "flex gap-3 flex-row-reverse chat-bubble" : "flex gap-3 chat-bubble"; d.innerHTML = k==='user' ? `<div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center shrink-0"><i data-lucide="user" class="w-4 h-4 text-slate-300"></i></div><div class="bg-blue-600 text-white text-sm p-3 rounded-2xl rounded-tr-none shadow-md max-w-[80%]">${h}</div>` : `<div class="w-8 h-8 rounded-full bg-white overflow-hidden shrink-0 border border-indigo-500 mt-1 p-0.5"><img src="${currentAvatarUrl}" class="w-full h-full object-contain"></div><div class="bg-slate-800 text-slate-200 text-sm p-3 rounded-2xl rounded-tl-none border border-slate-700 shadow-md max-w-[90%] leading-relaxed">${h}</div>`; c.appendChild(d); c.scrollTop=c.scrollHeight; lucide.createIcons(); }
        function mostrarLoading() { const c=document.getElementById('chat-messages'), i='load-'+Date.now(), d=document.createElement('div'); d.id=i; d.className="flex gap-3 chat-bubble"; d.innerHTML=`<div class="w-8 h-8 rounded-full bg-white overflow-hidden shrink-0 border border-indigo-500 mt-1 p-0.5"><img src="${currentAvatarUrl}" class="w-full h-full object-contain"></div><div class="bg-slate-800 p-4 rounded-2xl rounded-tl-none border border-slate-700 flex gap-1 items-center h-10"><span class="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-bounce"></span><span class="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-bounce delay-100"></span><span class="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-bounce delay-200"></span></div>`; c.appendChild(d); c.scrollTop=c.scrollHeight; return i; }
        function removerLoading(i) { const e=document.getElementById(i); if(e) e.remove(); }
    </script>
</body>
</html>
