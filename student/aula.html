<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aula Virtual - ASARI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; background: black; border-radius: 12px; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 h-screen flex flex-col overflow-hidden font-sans">

    <header class="h-16 bg-slate-950 border-b border-slate-800 flex items-center justify-between px-6 shrink-0">
        <div class="flex items-center gap-4">
            <a href="../dashboard.html" class="p-2 hover:bg-slate-800 rounded-lg transition text-slate-400 hover:text-white" title="Salir al Dashboard">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </a>
            <div>
                <h1 class="font-bold text-white text-lg leading-tight" id="course-title">Cargando curso...</h1>
                <p class="text-xs text-slate-500 font-medium uppercase tracking-wider">Aula Virtual</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <div class="hidden md:block text-right">
                <p class="text-sm font-bold text-white" id="student-name">Estudiante</p>
                <p class="text-[10px] text-green-500 font-bold uppercase">En línea</p>
            </div>
            <div class="w-9 h-9 bg-blue-600 rounded-full flex items-center justify-center font-bold text-white shadow-lg">
                <i data-lucide="user" class="w-4 h-4"></i>
            </div>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        
        <main class="flex-1 flex flex-col min-w-0 bg-slate-900 relative">
            <div class="flex-1 p-6 md:p-10 overflow-y-auto flex flex-col">
                <div class="w-full max-w-5xl mx-auto space-y-6">
                    
                    <div id="player-area" class="bg-black rounded-2xl shadow-2xl overflow-hidden border border-slate-800 relative aspect-video flex items-center justify-center">
                        <div class="text-center p-8">
                            <i data-lucide="play-circle" class="w-16 h-16 text-slate-700 mx-auto mb-4"></i>
                            <h3 class="text-xl font-bold text-slate-500">Selecciona una clase del temario</h3>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h2 id="current-lesson-title" class="text-2xl font-bold text-white">Bienvenido</h2>
                        <div class="flex gap-3">
                            <button id="btn-prev" class="px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm font-bold disabled:opacity-50" disabled>Anterior</button>
                            <button id="btn-next" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold shadow-lg disabled:opacity-50" disabled>Siguiente</button>
                        </div>
                    </div>

                </div>
            </div>
        </main>

        <aside class="w-80 bg-slate-950 border-l border-slate-800 flex flex-col shrink-0 overflow-hidden">
            <div class="p-4 border-b border-slate-800 bg-slate-950">
                <h3 class="font-bold text-slate-300 text-sm uppercase tracking-wider">Contenido</h3>
                <div class="h-1 w-full bg-slate-800 rounded-full mt-3 overflow-hidden">
                    <div class="h-full bg-green-500 w-0" id="progress-bar"></div>
                </div>
            </div>

            <div id="modules-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                <p class="text-center text-slate-600 text-xs py-10">Cargando temario...</p>
            </div>
        </aside>

    </div>

    <script>
        const PROJECT_URL = 'https://vxggatcfrywyodovjwxj.supabase.co';
        const PUBLIC_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4Z2dhdGNmcnl3eW9kb3Zqd3hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzM5MjgsImV4cCI6MjA4MzgwOTkyOH0.RZ9jhEASO6nCV8EnzrHQBhglP4G1nik9Z5osPXysGNg';
        const db = supabase.createClient(PROJECT_URL, PUBLIC_KEY);

        let flatLessons = [];
        let currentLessonIndex = -1;

        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            
            // 1. Auth Check
            const { data: { session } } = await db.auth.getSession();
            if(!session) return window.location.href = '../index.html';
            
            // 2. Cargar Perfil
            const { data: perfil } = await db.from('perfiles').select('nombre_completo').eq('id', session.user.id).single();
            if(perfil && perfil.nombre_completo) document.getElementById('student-name').innerText = perfil.nombre_completo;

            // 3. Cargar Curso
            const params = new URLSearchParams(window.location.search);
            const cursoId = params.get('id');

            if(!cursoId) { alert("ID de curso no válido"); return; }
            await cargarCurso(cursoId);
        });

        async function cargarCurso(id) {
            const { data, error } = await db.from('cursos_oficiales').select('*').eq('id', id).single();
            if(error) return alert("Error cargando curso");
            
            document.getElementById('course-title').innerText = data.nombre;
            renderizarTemario(data.contenido);
        }

        function renderizarTemario(modulos) {
            const container = document.getElementById('modules-list');
            container.innerHTML = "";
            flatLessons = [];

            if(!modulos || !Array.isArray(modulos)) return;

            modulos.forEach((mod, idx) => {
                // Acordeón Módulo
                const div = document.createElement('div');
                div.innerHTML = `
                    <div class="px-3 py-2 bg-slate-800/50 rounded-lg mb-1 text-xs font-bold text-slate-300">
                        ${mod.titulo}
                    </div>
                    <div class="space-y-0.5 pl-2 pb-2" id="mod-${idx}"></div>
                `;
                container.appendChild(div);
                
                // Lecciones
                if(mod.lecciones) {
                    mod.lecciones.forEach(lec => {
                        const globalIndex = flatLessons.length;
                        flatLessons.push(lec);

                        const btn = document.createElement('button');
                        btn.className = "w-full text-left px-3 py-2 rounded-lg flex items-center gap-3 text-xs text-slate-400 hover:bg-slate-800 hover:text-white transition-all";
                        const icon = lec.tipo === 'VIDEO' ? 'play-circle' : 'file-text';
                        const color = lec.tipo === 'VIDEO' ? 'text-blue-500' : 'text-red-500';
                        
                        btn.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4 ${color}"></i> <span class="truncate">${lec.titulo}</span>`;
                        btn.onclick = () => cargarClase(globalIndex);
                        
                        div.querySelector(`#mod-${idx}`).appendChild(btn);
                    });
                }
            });
            lucide.createIcons();
            if(flatLessons.length > 0) cargarClase(0);
        }

        function cargarClase(index) {
            if(index < 0 || index >= flatLessons.length) return;
            currentLessonIndex = index;
            const lec = flatLessons[index];
            const player = document.getElementById('player-area');
            
            document.getElementById('current-lesson-title').innerText = lec.titulo;

            if(lec.tipo === 'VIDEO') {
                let url = lec.url;
                if(url.includes('youtu')) {
                    const videoId = url.split('v=')[1] || url.split('/').pop();
                    url = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
                    player.innerHTML = `<iframe src="${url}" class="w-full h-full" frameborder="0" allowfullscreen allow="autoplay"></iframe>`;
                } else {
                    player.innerHTML = `<video src="${url}" controls autoplay class="w-full h-full bg-black"></video>`;
                }
            } else {
                player.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center p-10">
                        <i data-lucide="file-text" class="w-16 h-16 text-red-500 mb-4"></i>
                        <h3 class="text-xl font-bold text-white mb-4">Documento PDF</h3>
                        <a href="${lec.url}" target="_blank" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-bold">Descargar / Ver</a>
                    </div>`;
                lucide.createIcons();
            }
            
            // Botones Nav
            document.getElementById('btn-prev').disabled = index === 0;
            document.getElementById('btn-prev').onclick = () => cargarClase(index - 1);
            document.getElementById('btn-next').disabled = index === flatLessons.length - 1;
            document.getElementById('btn-next').onclick = () => cargarClase(index + 1);
        }
    </script>
</body>
</html>
