<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificación Oficial Blockchain</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background: #f0f2f5; }
        .hash-font { font-family: 'JetBrains Mono', monospace; }
        .loader-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div id="loader" class="flex flex-col items-center text-center">
        <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full loader-spin mb-4"></div>
        <p class="text-slate-500 font-bold text-sm tracking-widest animate-pulse">CONSULTANDO LEDGER...</p>
    </div>

    <div id="error-screen" class="hidden w-full max-w-md bg-white rounded-2xl shadow-xl p-8 text-center fade-in">
        <div class="w-20 h-20 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6">
            <i data-lucide="x-circle" class="w-10 h-10"></i>
        </div>
        <h1 class="text-2xl font-black text-slate-800 mb-2">No Encontrado</h1>
        <p class="text-slate-500 text-sm">El código solicitado no existe en el registro oficial o ha sido eliminado permanentemente.</p>
    </div>

    <div id="suspended-screen" class="hidden w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden border-t-8 border-red-600 fade-in relative">
        <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
            <i data-lucide="ban" class="w-32 h-32 text-red-900"></i>
        </div>
        <div class="p-8 text-center relative z-10">
            <div class="w-20 h-20 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-6 border-4 border-white shadow-lg">
                <i data-lucide="ban" class="w-10 h-10"></i>
            </div>
            <h1 class="text-2xl font-black text-red-600 mb-1">MATRÍCULA SUSPENDIDA</h1>
            <p class="text-xs font-bold text-red-400 uppercase tracking-widest mb-6">Estado Inactivo / Retenido</p>
            
            <div class="bg-red-50 rounded-xl p-4 border border-red-100 text-left">
                <p class="text-xs text-red-400 font-bold uppercase mb-1">Titular</p>
                <p class="text-lg font-black text-slate-700" id="susp-nombre">---</p>
                <div class="h-px bg-red-200 my-3"></div>
                <p class="text-xs text-red-400 font-bold uppercase mb-1">Certificación</p>
                <p class="text-sm font-bold text-slate-700" id="susp-curso">---</p>
            </div>
            <p class="mt-6 text-xs text-slate-400">Esta credencial digital carece de validez oficial en este momento. Contacte a la institución emisora.</p>
        </div>
    </div>

    <div id="success-screen" class="hidden w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden border-t-8 border-emerald-500 fade-in">
        <div class="bg-emerald-50 p-6 text-center border-b border-emerald-100">
            <div class="w-16 h-16 bg-white text-emerald-500 rounded-full flex items-center justify-center mx-auto mb-3 shadow-sm">
                <i data-lucide="check-circle-2" class="w-8 h-8"></i>
            </div>
            <h1 class="text-xl font-black text-emerald-800">CERTIFICACIÓN VÁLIDA</h1>
            <p class="text-xs font-bold text-emerald-600 uppercase tracking-widest">Verificado en Blockchain</p>
        </div>

        <div class="p-8 space-y-6">
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 bg-slate-200 rounded-full overflow-hidden border-2 border-white shadow-md flex-shrink-0">
                    <img id="val-foto" src="" class="w-full h-full object-cover">
                </div>
                <div>
                    <p class="text-xs text-slate-400 font-bold uppercase">Alumno Certificado</p>
                    <h2 class="text-lg font-black text-slate-800 leading-tight" id="val-nombre">---</h2>
                    <p class="text-sm font-mono text-slate-500" id="val-dni">DNI: ---</p>
                </div>
            </div>

            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                <div class="flex items-start gap-3">
                    <i data-lucide="award" class="text-blue-600 mt-1" size="20"></i>
                    <div>
                        <p class="text-xs text-slate-400 font-bold uppercase">Título / Formación</p>
                        <p class="text-sm font-bold text-slate-700 leading-snug" id="val-curso">---</p>
                    </div>
                </div>
                <div class="mt-4 flex items-start gap-3">
                    <i data-lucide="building-2" class="text-slate-400 mt-1" size="20"></i>
                    <div>
                        <p class="text-xs text-slate-400 font-bold uppercase">Institución Emisora</p>
                        <p class="text-sm font-bold text-slate-600" id="val-instituto">---</p>
                    </div>
                </div>
            </div>

            <div>
                <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Hash de Transacción (TXID)</p>
                <div class="bg-slate-900 text-emerald-400 p-3 rounded-lg text-[10px] hash-font break-all leading-relaxed relative group cursor-pointer" onclick="copiarHash()">
                    <span id="val-hash">---</span>
                    <i data-lucide="copy" class="absolute top-2 right-2 text-slate-600 w-3 h-3 group-hover:text-white transition"></i>
                </div>
                <p id="copy-msg" class="text-[10px] text-emerald-600 text-center mt-1 hidden">Copiado al portapapeles</p>
            </div>

            <div class="flex justify-between items-center text-xs border-t pt-4">
                <span class="text-slate-400 font-bold">Fecha de Emisión:</span>
                <span class="font-bold text-slate-700" id="val-fecha">---</span>
            </div>
        </div>
        
        <div class="bg-slate-50 p-4 text-center border-t border-slate-100">
            <img src="https://vxggatcfrywyodovjwxj.supabase.co/storage/v1/object/public/logos-instituciones/Asari%20Logo.jpg" class="h-6 mx-auto opacity-50 grayscale hover:grayscale-0 transition">
        </div>
    </div>

    <script>
        const PROJECT_URL = 'https://vxggatcfrywyodovjwxj.supabase.co';
        const PUBLIC_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4Z2dhdGNmcnl3eW9kb3Zqd3hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzM5MjgsImV4cCI6MjA4MzgwOTkyOH0.RZ9jhEASO6nCV8EnzrHQBhglP4G1nik9Z5osPXysGNg';
        const db = supabase.createClient(PROJECT_URL, PUBLIC_KEY);

        const params = new URLSearchParams(window.location.search);
        const idAlumno = params.get('id');

        async function validar() {
            if (!idAlumno) return mostrarError();

            try {
                // 1. Buscar en Matriculas
                const { data: alumno, error } = await db
                    .from('matriculas')
                    .select('*, instituciones(nombre, logo_url)')
                    .eq('id', idAlumno)
                    .single();

                if (error || !alumno) throw new Error("No encontrado");

                // 2. CHECK DE SUSPENSIÓN (PRIORIDAD ALTA)
                if (alumno.estado === 'SUSPENDIDO') {
                    return mostrarSuspendido(alumno);
                }

                // 3. Buscar Hash en Ledger (Simulado o Real)
                // Intentamos buscar una transacción real, si no, generamos visualización
                const { data: ledger } = await db
                    .from('ledger_transacciones')
                    .select('id, created_at')
                    .eq('matricula_id', idAlumno)
                    .limit(1)
                    .maybeSingle();

                const hashDisplay = ledger ? ledger.id : `GENESIS_${alumno.id.replace(/-/g,'').substring(0,32)}_ASARI_CHAIN`;
                const fechaEmision = ledger ? new Date(ledger.created_at) : new Date(alumno.fecha_inicio);

                // 4. Renderizar Éxito
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('success-screen').classList.remove('hidden');

                document.getElementById('val-nombre').innerText = `${alumno.nombre} ${alumno.apellido}`;
                document.getElementById('val-dni').innerText = `DNI: ${alumno.dni_alumno}`;
                document.getElementById('val-curso').innerText = alumno.curso;
                document.getElementById('val-instituto').innerText = alumno.instituciones?.nombre || 'INSTITUTO OFICIAL';
                document.getElementById('val-hash').innerText = hashDisplay;
                document.getElementById('val-fecha').innerText = fechaEmision.toLocaleDateString('es-AR', { day: 'numeric', month: 'long', year: 'numeric' });

                const imgEl = document.getElementById('val-foto');
                imgEl.src = alumno.foto_url || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23cbd5e1'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E";

                lucide.createIcons();

            } catch (err) {
                console.error(err);
                mostrarError();
            }
        }

        function mostrarError() {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('error-screen').classList.remove('hidden');
            lucide.createIcons();
        }

        function mostrarSuspendido(alumno) {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('suspended-screen').classList.remove('hidden');
            
            document.getElementById('susp-nombre').innerText = `${alumno.nombre} ${alumno.apellido}`;
            document.getElementById('susp-curso').innerText = alumno.curso;
            lucide.createIcons();
        }

        function copiarHash() {
            const t = document.getElementById('val-hash').innerText;
            navigator.clipboard.writeText(t);
            const msg = document.getElementById('copy-msg');
            msg.classList.remove('hidden');
            setTimeout(() => msg.classList.add('hidden'), 2000);
        }

        // Iniciar
        validar();
    </script>
</body>
</html>
