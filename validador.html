<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Validación Oficial</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #0033cc; --success: #2e7d32; --error: #c62828; --bg: #f5f7fa; --card-bg: #ffffff; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
        body { background-color: var(--bg); color: #333; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px; }

        .header-validador { margin-bottom: 25px; text-align: center; width: 100%; max-width: 400px; display: flex; flex-direction: column; align-items: center; }
        .org-logo { height: 80px; width: auto; object-fit: contain; margin-bottom: 10px; }
        .org-name-text { font-size: 14px; font-weight: 900; color: #555; text-transform: uppercase; margin-bottom: 5px; }
        .system-badge { background: var(--primary); color: white; padding: 6px 15px; border-radius: 20px; font-size: 11px; font-weight: 700; letter-spacing: 1px; display: inline-block; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        .validation-card { background: var(--card-bg); width: 100%; max-width: 400px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); overflow: hidden; position: relative; padding-bottom: 30px; border-top: 5px solid var(--primary); }

        .status-banner { padding: 20px; text-align: center; color: white; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; font-size: 18px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .status-ok { background-color: var(--success); }
        .status-fail { background-color: var(--error); }

        .profile-section { display: flex; flex-direction: column; align-items: center; margin-top: -30px; padding: 0 20px; }
        .student-img-container { width: 140px; height: 140px; border-radius: 50%; border: 6px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.15); background: #eee; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        .student-img { width: 100%; height: 100%; object-fit: cover; }
        
        .student-name { font-size: 22px; font-weight: 900; margin-top: 15px; text-align: center; color: #222; text-transform: uppercase; line-height: 1.2; }
        .student-dni { font-size: 14px; color: #666; margin-top: 5px; font-weight: 500; }

        .info-grid { margin-top: 25px; width: 100%; padding: 0 25px; }
        .info-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 15px 0; }
        .info-row:last-child { border-bottom: none; }
        .label { font-size: 12px; color: #888; font-weight: 700; text-transform: uppercase; }
        .value { font-size: 16px; font-weight: 700; color: #333; text-align: right; max-width: 60%; }
        .icon-reg { color: var(--primary); margin-right: 8px; font-size: 14px; }

        .footer-secure { margin-top: auto; text-align: center; font-size: 11px; color: #aaa; padding: 30px 0; max-width: 300px; line-height: 1.5; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div><div style="font-weight: bold; color: #555;">VERIFICANDO...</div></div>

    <div class="header-validador hidden" id="main-content">
        <img src="" id="org-logo" class="org-logo">
        <div id="org-name" class="org-name-text"></div>
        <div><span class="system-badge" id="badge-registro">VALIDACIÓN OFICIAL</span></div>
    </div>

    <div class="validation-card hidden" id="card-content">
        <div id="status-bar" class="status-banner"><i class="fas fa-check-circle"></i> <span>VALIDANDO...</span></div>
        <div class="profile-section">
            <div class="student-img-container">
                <img src="" id="st-photo" class="student-img" crossorigin="anonymous">
            </div>
            <div class="student-name" id="st-name">---</div>
            <div class="student-dni">DNI: <span id="st-dni">---</span></div>
        </div>
        <div class="info-grid">
            <div class="info-row"><span class="label"><i class="fas fa-graduation-cap icon-reg"></i> Curso</span><span class="value" id="st-curso">---</span></div>
            <div class="info-row"><span class="label"><i class="fas fa-hashtag icon-reg"></i> Matrícula</span><span class="value" id="st-matricula">---</span></div>
            <div class="info-row"><span class="label"><i class="fas fa-building icon-reg"></i> Registro</span><span class="value" id="st-registro">---</span></div>
            <div class="info-row"><span class="label"><i class="fas fa-calendar-check icon-reg"></i> Estado</span><span class="value" id="st-vigencia">VIGENTE</span></div>
        </div>
    </div>

    <div class="footer-secure"><strong>Verificación Segura</strong><br>Datos oficiales de la institución emisora.</div>

    <script>
        const PROJECT_URL = 'https://vxggatcfrywyodovjwxj.supabase.co';
        const PUBLIC_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4Z2dhdGNmcnl3eW9kb3Zqd3hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzM5MjgsImV4cCI6MjA4MzgwOTkyOH0.RZ9jhEASO6nCV8EnzrHQBhglP4G1nik9Z5osPXysGNg';
        const db = supabase.createClient(PROJECT_URL, PUBLIC_KEY);

        // SILUETA GRIS (BASE64) - SE USA SI NO HAY FOTO O FALLA LA CARGA
        const AVATAR_DEFAULT = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ccc'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E";

        const COLORES_REGISTRO = { 'remaep': '#0033cc', 'rubra': '#cc0000', 'rniue': '#b8860b', 'remets': '#1a1a1a', 'rmts': '#1a1a1a', 'rpdye': '#0099ff', 'rpde': '#0099ff', 'rce': '#ff6600', 'asarin': '#800000', 'colbert': '#2f4f4f', 'default': '#0033cc' };

        window.addEventListener('load', async () => {
            const params = new URLSearchParams(window.location.search);
            const idAlumno = params.get('id');
            if (!idAlumno) return mostrarError("ID Inválido.");

            try {
                // 1. CARGAR DATOS
                const { data: alumno, error } = await db.from('matriculas').select('*').eq('id', idAlumno).single();
                if (error || !alumno) throw new Error("Credencial no encontrada.");

                // 2. CONFIGURAR APARIENCIA
                if (alumno.institution_id) {
                    try {
                        const { data: inst } = await db.from('instituciones').select('*').eq('id', alumno.institution_id).maybeSingle();
                        if (inst) {
                            if(inst.logo_url) document.getElementById('org-logo').src = inst.logo_url;
                            if(inst.nombre) document.getElementById('org-name').innerText = inst.nombre;
                            if(inst.color_primario) document.documentElement.style.setProperty('--primary', inst.color_primario);
                            else aplicarColorRegistro(alumno.registro_id);
                        } else aplicarColorRegistro(alumno.registro_id);
                    } catch(e) { aplicarColorRegistro(alumno.registro_id); }
                } else aplicarColorRegistro(alumno.registro_id);

                // 3. MOSTRAR DATOS
                document.getElementById('st-name').innerText = `${alumno.nombre} ${alumno.apellido}`;
                document.getElementById('st-dni').innerText = new Intl.NumberFormat('es-AR').format(alumno.dni_alumno);
                document.getElementById('st-curso').innerText = alumno.curso;
                document.getElementById('st-matricula').innerText = generarHash(String(alumno.dni_alumno));
                document.getElementById('st-registro').innerText = (alumno.registro_id || "OFICIAL").toUpperCase();
                document.getElementById('badge-registro').innerText = `VALIDACIÓN ${ (alumno.registro_id || "OFICIAL").toUpperCase() }`;

                // 4. GESTIÓN DE FOTO (EL PUNTO CLAVE)
                const imgEl = document.getElementById('st-photo');
                // Si hay URL, intentamos cargarla. Si falla, el evento 'error' pone el avatar default.
                if (alumno.foto_url && alumno.foto_url.length > 5) {
                    imgEl.onload = function() { console.log("Foto cargada OK"); };
                    imgEl.onerror = function() { 
                        console.log("Error cargando foto, usando default"); 
                        this.src = AVATAR_DEFAULT; 
                    };
                    imgEl.src = alumno.foto_url; // Directo de Supabase
                } else {
                    imgEl.src = AVATAR_DEFAULT;
                }

                // 5. FECHAS
                const inicio = new Date(alumno.fecha_inicio || new Date());
                let vence;
                if(alumno.fecha_vencimiento) {
                    const p = alumno.fecha_vencimiento.split('-');
                    vence = new Date(p[0], p[1]-1, p[2]);
                } else {
                    vence = new Date(inicio); vence.setFullYear(vence.getFullYear()+1);
                }
                
                const hoy = new Date();
                const stVigencia = document.getElementById('st-vigencia');
                const bar = document.getElementById('status-bar');
                
                if (hoy > vence) {
                    bar.className = 'status-banner status-fail';
                    bar.innerHTML = '<i class="fas fa-times-circle"></i> <span>VENCIDA</span>';
                    stVigencia.innerText = `EXPIRÓ: ${vence.toLocaleDateString('es-AR')}`;
                    stVigencia.style.color = 'var(--error)';
                } else {
                    bar.className = 'status-banner status-ok';
                    bar.innerHTML = '<i class="fas fa-check-circle"></i> <span>HABILITADO</span>';
                    stVigencia.innerText = `VENCE: ${vence.toLocaleDateString('es-AR')}`;
                    stVigencia.style.color = 'var(--success)';
                }

                document.getElementById('loader').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('card-content').classList.remove('hidden');

            } catch (e) { mostrarError(e.message); }
        });

        function aplicarColorRegistro(id) {
            const c = COLORES_REGISTRO[(id||'default').toLowerCase()] || COLORES_REGISTRO['default'];
            document.documentElement.style.setProperty('--primary', c);
        }

        function mostrarError(msg) {
            document.getElementById('loader').innerHTML = `<div style="text-align:center; color:#c62828; padding:20px;"><i class="fas fa-exclamation-triangle" style="font-size:50px;"></i><br><br><strong>ERROR</strong><br>${msg}</div>`;
        }
        function generarHash(d) { let h=0;for(let i=0;i<d.length;i++){h=((h<<5)-h)+d.charCodeAt(i);h|=0;} return String(Math.abs(h)).substring(0,6).padStart(6,'9'); }
    </script>
</body>
</html>
