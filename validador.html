<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificación Oficial Blockchain</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background: #f0f2f5; }
        .hash-font { font-family: 'JetBrains Mono', monospace; }
        .loader-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div id="loader" class="flex flex-col items-center text-center">
        <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full loader-spin mb-4"></div>
        <p class="text-slate-500 font-bold text-sm tracking-widest animate-pulse">CONSULTANDO LEDGER...</p>
    </div>

    <div id="error-screen" class="hidden w-full max-w-md bg-white rounded-2xl shadow-xl p-8 text-center fade-in">
        <div class="w-20 h-20 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6">
            <i data-lucide="x-circle" class="w-10 h-10"></i>
        </div>
        <h1 class="text-2xl font-black text-slate-800 mb-2">No Encontrado</h1>
        <p class="text-slate-500 text-sm">El código solicitado no existe en el registro oficial o ha sido eliminado permanentemente.</p>
    </div>

    <div id="suspended-screen" class="hidden w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden border-t-8 border-red-600 fade-in relative">
        <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
            <i data-lucide="ban" class="w-32 h-32 text-red-900"></i>
        </div>
        <div class="p-8 text-center relative z-10">
            <div class="w-20 h-20 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-6 border-4 border-white shadow-lg">
                <i data-lucide="ban" class="w-10 h-10"></i>
            </div>
            <h1 class="text-2xl font-black text-red-600 mb-1">MATRÍCULA SUSPENDIDA</h1>
            <p class="text-xs font-bold text-red-400 uppercase tracking-widest mb-6">Estado Inactivo / Retenido</p>
            
            <div class="bg-red-50 rounded-xl p-4 border border-red-100 text-left">
                <p class="text-xs text-red-400 font-bold uppercase mb-1">Titular</p>
                <p class="text-lg font-black text-slate-700" id="susp-nombre">---</p>
                <div class="h-px bg-red-200 my-3"></div>
                <p class="text-xs text-red-400 font-bold uppercase mb-1">Certificación</p>
                <p class="text-sm font-bold text-slate-700" id="susp-curso">---</p>
            </div>
            <p class="mt-6 text-xs text-slate-400">Esta credencial digital carece de validez oficial por decisión administrativa.</p>
        </div>
    </div>

    <div id="expired-screen" class="hidden w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden border-t-8 border-orange-500 fade-in relative">
        <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
            <i data-lucide="clock" class="w-32 h-32 text-orange-900"></i>
        </div>
        <div class="p-8 text-center relative z-10">
            <div class="w-20 h-20 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mx-auto mb-6 border-4 border-white shadow-lg">
                <i data-lucide="alert-triangle" class="w-10 h-10"></i>
            </div>
            <h1 class="text-2xl font-black text-orange-600 mb-1">CERTIFICACIÓN VENCIDA</h1>
            <p class="text-xs font-bold text-orange-400 uppercase tracking-widest mb-6">La vigencia ha expirado</p>
            
            <div class="bg-orange-50 rounded-xl p-4 border border-orange-100 text-left">
                <p class="text-xs text-orange-400 font-bold uppercase mb-1">Fecha de Vencimiento</p>
                <p class="text-2xl font-black text-slate-700" id="exp-fecha">---</p>
                <div class="h-px bg-orange-200 my-3"></div>
                <p class="text-xs text-orange-400 font-bold uppercase mb-1">Estado Actual</p>
                <p class="text-sm font-bold text-slate-700">NO VIGENTE / REQUIERE RENOVACIÓN</p>
            </div>
            <p class="mt-6 text-xs text-slate-400">Este documento fue válido en el pasado pero ha superado su fecha límite de validez.</p>
        </div>
    </div>

    <div id="success-screen" class="hidden w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden border-t-8 border-gray-300 fade-in relative">
        
        <div id="header-bg" class="p-6 text-center border-b border-gray-100 bg-gray-50 transition-colors duration-500">
            <div id="icon-bg" class="w-16 h-16 bg-white text-gray-500 rounded-full flex items-center justify-center mx-auto mb-3 shadow-sm transition-colors duration-500">
                <i data-lucide="check-circle-2" class="w-8 h-8"></i>
            </div>
            <h1 id="header-title" class="text-xl font-black text-gray-800">CERTIFICACIÓN VÁLIDA</h1>
            <p id="header-subtitle" class="text-xs font-bold text-gray-500 uppercase tracking-widest">Verificado en Blockchain</p>
        </div>

        <div class="p-8 space-y-6 relative">
            <img id="val-logo-inst" src="" class="absolute top-4 right-4 h-8 object-contain opacity-80 hidden">

            <div class="flex items-center gap-4">
                <div id="foto-border" class="w-16 h-16 bg-slate-200 rounded-full overflow-hidden border-2 border-white shadow-md flex-shrink-0">
                    <img id="val-foto" src="" class="w-full h-full object-cover">
                </div>
                <div>
                    <p class="text-xs text-slate-400 font-bold uppercase">Alumno Certificado</p>
                    <h2 class="text-lg font-black text-slate-800 leading-tight" id="val-nombre">---</h2>
                    <p class="text-sm font-mono text-slate-500" id="val-dni">DNI: ---</p>
                </div>
            </div>

            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                <div class="flex items-start gap-3 mb-4">
                    <i data-lucide="award" class="text-slate-400 mt-1" size="20"></i>
                    <div>
                        <p class="text-xs text-slate-400 font-bold uppercase">Título / Formación</p>
                        <p class="text-sm font-bold text-slate-700 leading-snug" id="val-curso">---</p>
                    </div>
                </div>
                
                <div class="flex items-start gap-3 mb-4">
                    <i data-lucide="hash" class="text-slate-400 mt-1" size="20"></i>
                    <div>
                        <p class="text-xs text-slate-400 font-bold uppercase">Matrícula Nº</p>
                        <p class="text-lg font-black text-slate-800 leading-none tracking-tight" id="val-matricula">---</p>
                    </div>
                </div>

                <div class="flex items-start gap-3">
                    <i data-lucide="building-2" class="text-slate-400 mt-1" size="20"></i>
                    <div>
                        <p class="text-xs text-slate-400 font-bold uppercase">Institución Emisora</p>
                        <p class="text-sm font-bold text-slate-600" id="val-instituto">---</p>
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-center text-xs border-t pt-4">
                <span class="text-slate-400 font-bold">Vigencia hasta:</span>
                <span class="font-bold text-slate-700" id="val-vencimiento">---</span>
            </div>

            <div>
                <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Hash de Transacción (TXID)</p>
                <div class="bg-slate-900 text-emerald-400 p-3 rounded-lg text-[10px] hash-font break-all leading-relaxed relative group cursor-pointer" onclick="copiarHash()">
                    <span id="val-hash">---</span>
                    <i data-lucide="copy" class="absolute top-2 right-2 text-slate-600 w-3 h-3 group-hover:text-white transition"></i>
                </div>
                <p id="copy-msg" class="text-[10px] text-emerald-600 text-center mt-1 hidden">Copiado al portapapeles</p>
            </div>
        </div>
        
        <div class="bg-slate-50 p-4 text-center border-t border-slate-100">
            <img src="https://vxggatcfrywyodovjwxj.supabase.co/storage/v1/object/public/logos-instituciones/Asari%20Logo.jpg" class="h-6 mx-auto opacity-50 grayscale hover:grayscale-0 transition">
        </div>
    </div>

    <script>
        const PROJECT_URL = 'https://vxggatcfrywyodovjwxj.supabase.co';
        const PUBLIC_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4Z2dhdGNmcnl3eW9kb3Zqd3hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzM5MjgsImV4cCI6MjA4MzgwOTkyOH0.RZ9jhEASO6nCV8EnzrHQBhglP4G1nik9Z5osPXysGNg';
        const db = supabase.createClient(PROJECT_URL, PUBLIC_KEY);

        // Paleta de colores
        const COLORES_REGISTRO = { 
            'remaep': '#0033cc', 
            'rubra': '#cc0000', 
            'rniue': '#b8860b', 
            'remets': '#1a1a1a', 
            'rmts': '#1a1a1a',
            'rpdye': '#0099ff', 
            'rpde': '#0099ff',
            'rce': '#ff6600',
            'asarin': '#800000', 
            'colbert': '#2f4f4f', 
            'default': '#0033cc' 
        };

        const params = new URLSearchParams(window.location.search);
        const idAlumno = params.get('id');

        async function validar() {
            if (!idAlumno) return mostrarError();

            try {
                // 1. Buscar en Matriculas
                const { data: alumno, error } = await db
                    .from('matriculas')
                    .select('*, instituciones(nombre, logo_url)')
                    .eq('id', idAlumno)
                    .single();

                if (error || !alumno) throw new Error("No encontrado");

                // --- LÓGICA DE PRIORIDAD DE ESTADOS ---

                // A. CHECK SUSPENSIÓN (Máxima Prioridad)
                if (alumno.estado === 'SUSPENDIDO') {
                    return mostrarSuspendido(alumno);
                }

                // B. CHECK VENCIMIENTO (Segunda Prioridad)
                const fechaInicio = new Date(alumno.fecha_inicio);
                let fechaVence;
                
                if (alumno.fecha_vencimiento) {
                    // Si tiene fecha manual específica
                    const partes = alumno.fecha_vencimiento.split('-'); 
                    fechaVence = new Date(partes[0], partes[1] - 1, partes[2]);
                } else {
                    // Default: 1 año desde inicio
                    fechaVence = new Date(fechaInicio);
                    fechaVence.setFullYear(fechaVence.getFullYear() + 1);
                }

                if (new Date() > fechaVence) {
                    return mostrarVencido(fechaVence);
                }

                // C. TODO OK -> MOSTRAR CERTIFICADO
                renderizarExito(alumno, fechaVence);

            } catch (err) {
                console.error(err);
                mostrarError();
            }
        }

        function renderizarExito(alumno, fechaVence) {
            // 3. Buscar Hash en Ledger (Simulado o Real)
            db.from('ledger_transacciones')
                .select('id, created_at')
                .eq('matricula_id', idAlumno)
                .limit(1)
                .maybeSingle()
                .then(({ data: ledger }) => {
                    const hashDisplay = ledger ? ledger.id : `GENESIS_${alumno.id.replace(/-/g,'').substring(0,32)}_ASARI_CHAIN`;
                    
                    document.getElementById('loader').classList.add('hidden');
                    document.getElementById('success-screen').classList.remove('hidden');

                    // Aplicar Colores
                    const regId = (alumno.registro_id || 'default').toLowerCase();
                    const colorTema = COLORES_REGISTRO[regId] || COLORES_REGISTRO['default'];
                    aplicarEstilos(colorTema);

                    // Llenar Datos
                    document.getElementById('val-nombre').innerText = `${alumno.nombre} ${alumno.apellido}`;
                    document.getElementById('val-dni').innerText = `DNI: ${new Intl.NumberFormat('es-AR').format(alumno.dni_alumno)}`;
                    document.getElementById('val-curso').innerText = alumno.curso;
                    document.getElementById('val-instituto').innerText = alumno.instituciones?.nombre || 'INSTITUTO OFICIAL';
                    document.getElementById('val-hash').innerText = hashDisplay;
                    document.getElementById('val-vencimiento').innerText = fechaVence.toLocaleDateString('es-AR');
                    
                    // Matrícula
                    document.getElementById('val-matricula').innerText = generarHashMatricula(String(alumno.dni_alumno));
                    document.getElementById('val-matricula').style.color = colorTema;

                    // Logo
                    if (alumno.instituciones?.logo_url) {
                        const logo = document.getElementById('val-logo-inst');
                        logo.src = alumno.instituciones.logo_url;
                        logo.classList.remove('hidden');
                    }

                    // Foto CON ANTI-CACHE (Fix: se agrego ?t=Date.now())
                    const imgEl = document.getElementById('val-foto');
                    if (alumno.foto_url) {
                        imgEl.src = alumno.foto_url + "?t=" + Date.now();
                        imgEl.crossOrigin = "anonymous";
                    } else {
                        imgEl.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23cbd5e1'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E";
                    }
                    
                    lucide.createIcons();
                });
        }

        function aplicarEstilos(colorTema) {
            const hexToRgba = (hex, alpha) => {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            };

            document.getElementById('header-bg').style.backgroundColor = hexToRgba(colorTema, 0.1);
            document.getElementById('success-screen').style.borderColor = colorTema;
            document.getElementById('header-title').style.color = colorTema;
            document.getElementById('header-subtitle').style.color = colorTema;
            document.getElementById('icon-bg').style.color = colorTema;
            document.getElementById('foto-border').style.borderColor = colorTema;
        }

        function mostrarError() {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('error-screen').classList.remove('hidden');
            lucide.createIcons();
        }

        function mostrarSuspendido(alumno) {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('suspended-screen').classList.remove('hidden');
            document.getElementById('susp-nombre').innerText = `${alumno.nombre} ${alumno.apellido}`;
            document.getElementById('susp-curso').innerText = alumno.curso;
            lucide.createIcons();
        }

        function mostrarVencido(fecha) {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('expired-screen').classList.remove('hidden');
            document.getElementById('exp-fecha').innerText = fecha.toLocaleDateString('es-AR');
            lucide.createIcons();
        }

        function generarHashMatricula(d) { 
            let h = 0; 
            for (let i = 0; i < d.length; i++) { h = ((h << 5) - h) + d.charCodeAt(i); h |= 0; } 
            return String(Math.abs(h)).substring(0, 6).padStart(6, '9'); 
        }

        function copiarHash() {
            const t = document.getElementById('val-hash').innerText;
            navigator.clipboard.writeText(t);
            const msg = document.getElementById('copy-msg');
            msg.classList.remove('hidden');
            setTimeout(() => msg.classList.add('hidden'), 2000);
        }

        // Iniciar
        validar();
    </script>
</body>
</html>
