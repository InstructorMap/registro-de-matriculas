<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Validación Oficial - Credencial Digital</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        /* VARIABLE DINÁMICA --primary SE LLENARÁ CON JS */
        :root { --primary: #0033cc; --success: #2e7d32; --error: #c62828; --bg: #f5f7fa; --card-bg: #ffffff; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
        
        body { background-color: var(--bg); color: #333; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px; }

        /* CABECERA CON LOGO DINÁMICO */
        .header-validador { margin-bottom: 25px; text-align: center; width: 100%; max-width: 400px; }
        .org-logo { height: 80px; width: auto; object-fit: contain; margin-bottom: 10px; }
        
        /* ETIQUETA DEL SISTEMA (TOMA COLOR DEL REGISTRO) */
        .system-badge { background: var(--primary); color: white; padding: 6px 15px; border-radius: 20px; font-size: 11px; font-weight: 700; letter-spacing: 1px; display: inline-block; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* TARJETA PRINCIPAL (BORDE DEL COLOR DEL REGISTRO) */
        .validation-card { background: var(--card-bg); width: 100%; max-width: 400px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); overflow: hidden; position: relative; padding-bottom: 30px; border-top: 5px solid var(--primary); }

        /* ESTADO (VERDE/ROJO - SEGURIDAD) */
        .status-banner { padding: 20px; text-align: center; color: white; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; font-size: 18px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .status-ok { background-color: var(--success); }
        .status-fail { background-color: var(--error); }

        /* PERFIL */
        .profile-section { display: flex; flex-direction: column; align-items: center; margin-top: -30px; padding: 0 20px; }
        .student-img { width: 140px; height: 140px; border-radius: 50%; border: 6px solid white; object-fit: cover; box-shadow: 0 5px 15px rgba(0,0,0,0.15); background: #eee; }
        
        .student-name { font-size: 22px; font-weight: 900; margin-top: 15px; text-align: center; color: #222; text-transform: uppercase; line-height: 1.2; }
        .student-dni { font-size: 14px; color: #666; margin-top: 5px; font-weight: 500; }

        /* DATOS DEL CURSO */
        .info-grid { margin-top: 25px; width: 100%; padding: 0 25px; }
        .info-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 15px 0; }
        .info-row:last-child { border-bottom: none; }
        .label { font-size: 12px; color: #888; font-weight: 700; text-transform: uppercase; }
        .value { font-size: 16px; font-weight: 700; color: #333; text-align: right; max-width: 60%; }
        
        /* ÍCONOS CON COLOR DE REGISTRO */
        .icon-reg { color: var(--primary); margin-right: 8px; font-size: 14px; }

        /* FOOTER */
        .footer-secure { margin-top: auto; text-align: center; font-size: 11px; color: #aaa; padding: 30px 0; max-width: 300px; line-height: 1.5; }
        
        /* LOADING */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div style="font-weight: bold; color: #555;">VERIFICANDO...</div>
    </div>

    <div class="header-validador hidden" id="main-content">
        <img src="https://vxggatcfrywyodovjwxj.supabase.co/storage/v1/object/public/logos-instituciones/Asari%20Logo.jpg" id="org-logo" class="org-logo">
        <div><span class="system-badge" id="badge-registro">SISTEMA NACIONAL DE VALIDACIÓN</span></div>
    </div>

    <div class="validation-card hidden" id="card-content">
        
        <div id="status-bar" class="status-banner">
            <i class="fas fa-check-circle"></i> <span>VALIDANDO...</span>
        </div>

        <div class="profile-section">
            <img src="" id="st-photo" class="student-img">
            <div class="student-name" id="st-name">---</div>
            <div class="student-dni">DNI: <span id="st-dni">---</span></div>
        </div>

        <div class="info-grid">
            <div class="info-row">
                <span class="label"><i class="fas fa-graduation-cap icon-reg"></i> Certificación</span>
                <span class="value" id="st-curso">---</span>
            </div>
            <div class="info-row">
                <span class="label"><i class="fas fa-hashtag icon-reg"></i> Matrícula</span>
                <span class="value" id="st-matricula">---</span>
            </div>
            <div class="info-row">
                <span class="label"><i class="fas fa-building icon-reg"></i> Registro</span>
                <span class="value" id="st-registro">---</span>
            </div>
            <div class="info-row">
                <span class="label"><i class="fas fa-calendar-check icon-reg"></i> Estado</span>
                <span class="value" id="st-vigencia" style="color: var(--success);">VIGENTE</span>
            </div>
        </div>
    </div>

    <div class="footer-secure">
        <strong>Verificación Segura con Tecnología Blockchain</strong><br>
        Los datos mostrados provienen directamente de los registros oficiales de la institución emisora.
    </div>

    <script>
        const PROJECT_URL = 'https://vxggatcfrywyodovjwxj.supabase.co';
        const PUBLIC_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4Z2dhdGNmcnl3eW9kb3Zqd3hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzM5MjgsImV4cCI6MjA4MzgwOTkyOH0.RZ9jhEASO6nCV8EnzrHQBhglP4G1nik9Z5osPXysGNg';
        const db = supabase.createClient(PROJECT_URL, PUBLIC_KEY);

        // --- TU LISTA DE COLORES MANUAL ---
        const COLORES_REGISTRO = { 
            'remaep': '#0033cc', 
            'rubra': '#cc0000', 
            'rniue': '#b8860b', 
            'remets': '#1b4f4b', 
            'rmts': '#1b4f4b',
            'rpdye': '#0099ff', 
            'rpde': '#0099ff',
            'rce': '#ff6600',
            'asarin': '#800000', 
            'colbert': '#2f4f4f', 
            'default': '#0033cc' 
        };

        async function initValidator() {
            const params = new URLSearchParams(window.location.search);
            const idAlumno = params.get('id');

            if (!idAlumno) {
                mostrarError("ID Inválido o inexistente.");
                return;
            }

            try {
                // 1. BUSCAR ALUMNO
                const { data: alumno, error } = await db
                    .from('matriculas')
                    .select('*')
                    .eq('id', idAlumno)
                    .single();

                if (error || !alumno) throw new Error("Credencial no encontrada en el registro oficial.");

                // 2. APLICAR COLOR DEL REGISTRO (Lógica Manual)
                const idRegistro = (alumno.registro_id || 'default').toLowerCase();
                const colorTema = COLORES_REGISTRO[idRegistro] || COLORES_REGISTRO['default'];
                
                // Inyectar color en CSS
                document.documentElement.style.setProperty('--primary', colorTema);

                // 3. BUSCAR LOGO DEL INSTITUTO (Colbert)
                if (alumno.institution_id) {
                    try {
                        const { data: inst } = await db
                            .from('instituciones')
                            .select('logo_url')
                            .eq('id', alumno.institution_id)
                            .maybeSingle();
                        
                        if (inst && inst.logo_url) {
                            document.getElementById('org-logo').src = inst.logo_url;
                        }
                    } catch (e) { console.log("Usando logo por defecto"); }
                }

                // 4. RENDERIZAR DATOS
                renderData(alumno);

            } catch (err) {
                mostrarError(err.message);
            }
        }

        function renderData(alumno) {
            const el = (id) => document.getElementById(id);
            
            // Foto
            if (alumno.foto_url) el('st-photo').src = alumno.foto_url;
            else el('st-photo').src = "https://via.placeholder.com/150?text=SIN+FOTO";

            // Textos básicos
            el('st-name').innerText = `${alumno.nombre} ${alumno.apellido}`;
            el('st-dni').innerText = new Intl.NumberFormat('es-AR').format(alumno.dni_alumno);
            el('st-curso').innerText = alumno.curso;
            el('st-matricula').innerText = generarHashMatricula(String(alumno.dni_alumno));
            
            const nombreReg = (alumno.registro_id || "OFICIAL").toUpperCase();
            el('st-registro').innerText = nombreReg;
            el('badge-registro').innerText = `VALIDACIÓN OFICIAL ${nombreReg}`; // Badge con nombre del registro

            // Lógica de Vencimiento
            const fechaInicio = new Date(alumno.fecha_inicio || new Date());
            let fechaVencimiento;
            
            if (alumno.fecha_vencimiento) {
                const partes = alumno.fecha_vencimiento.split('-');
                fechaVencimiento = new Date(partes[0], partes[1] - 1, partes[2]);
            } else {
                // Si no hay fecha explicita, calculamos 1 año
                fechaVencimiento = new Date(fechaInicio);
                fechaVencimiento.setFullYear(fechaVencimiento.getFullYear() + 1);
            }

            const hoy = new Date();
            const bar = el('status-bar');
            const vigenciaTxt = el('st-vigencia');

            if (hoy > fechaVencimiento) {
                // VENCIDO
                bar.className = 'status-banner status-fail';
                bar.innerHTML = '<i class="fas fa-times-circle"></i> <span>CREDENCIAL VENCIDA</span>';
                vigenciaTxt.innerText = `EXPIRÓ: ${fechaVencimiento.toLocaleDateString('es-AR')}`;
                vigenciaTxt.style.color = 'var(--error)';
            } else {
                // HABILITADO
                bar.className = 'status-banner status-ok';
                bar.innerHTML = '<i class="fas fa-check-circle"></i> <span>HABILITADO OFICIAL</span>';
                vigenciaTxt.innerText = `VENCE: ${fechaVencimiento.toLocaleDateString('es-AR')}`;
                vigenciaTxt.style.color = 'var(--success)';
            }

            // Mostrar todo
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('card-content').classList.remove('hidden');
        }

        function mostrarError(msg) {
            document.getElementById('loader').innerHTML = `
                <div style="text-align:center; color: #c62828; padding: 20px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 50px; margin-bottom: 20px;"></i><br>
                    <strong>ERROR DE VALIDACIÓN</strong><br><br>
                    ${msg}
                </div>
            `;
        }

        function generarHashMatricula(d) {
            let h = 0; for (let i = 0; i < d.length; i++) { h = ((h << 5) - h) + d.charCodeAt(i); h |= 0; }
            return String(Math.abs(h)).substring(0, 6).padStart(6, '9');
        }

        // Iniciar al cargar
        window.addEventListener('load', initValidator);
    </script>
</body>
</html>
